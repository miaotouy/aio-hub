name: ç§»åŠ¨ç«¯æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - "v*.*.*-m" # å½“æ¨é€å¸¦ -m åç¼€çš„ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v0.1.9-mï¼‰
      - "v*.*.*-m-*" # ï¼ˆå¦‚ v0.1.9-m-beta.1ï¼‰
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build-android:
    name: æ„å»º Android
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: è®¾ç½® Android SDK
        uses: android-actions/setup-android@v3

      - name: è®¾ç½® Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: å®‰è£… Rust ç¨³å®šç‰ˆ
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, armv7-linux-androideabi, i686-linux-android, x86_64-linux-android

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "mobile/src-tauri -> target"

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          bun install
          cd mobile && bun install

      - name: æ„å»º Android åº”ç”¨
        run: |
          cd mobile
          bun tauri android build --apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–ç‰ˆæœ¬å·
        id: get-version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # æå–ç‰ˆæœ¬å·ï¼š
            # v0.1.9-m -> 0.1.9
            # v0.1.9-m-beta.1 -> 0.1.9-beta.1
            TAG_NAME="${{ github.ref_name }}"
            # å»æ‰å¼€å¤´çš„ v
            VERSION_NUM="${TAG_NAME#v}"
            # å°†ç¬¬ä¸€ä¸ª -m æ›¿æ¢ä¸ºç©ºï¼ˆå¤„ç† v0.1.9-m -> 0.1.9 å’Œ v0.1.9-m-beta.1 -> 0.1.9-beta.1ï¼‰
            VERSION_NUM=$(echo "$VERSION_NUM" | sed 's/-m//')
            echo "version=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "version_num=${VERSION_NUM}" >> $GITHUB_OUTPUT
          else
            # ä» mobile/package.json è¯»å–
            VERSION=$(cat mobile/package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')
            echo "version=v${VERSION}-m" >> $GITHUB_OUTPUT
            echo "version_num=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: æ•´ç†å¹¶é‡å‘½å Android äº§ç‰©
        shell: bash
        run: |
          mkdir -p dist-artifacts
          VERSION="${{ steps.get-version.outputs.version_num }}"

          # æŸ¥æ‰¾ç”Ÿæˆçš„ APK å¹¶é‡å‘½å
          # Tauri è·¯å¾„é€šå¸¸åœ¨ mobile/src-tauri/gen/android/app/build/outputs/apk/release/
          APK_DIR="mobile/src-tauri/gen/android/app/build/outputs/apk/release"

          if [ -d "$APK_DIR" ]; then
            # é€šç”¨ APK (å¦‚æœæœ‰)
            find "$APK_DIR" -name "app-release.apk" -exec cp {} "dist-artifacts/AIO-Hub_${VERSION}_universal.apk" \;
            
            # é’ˆå¯¹ä¸åŒæ¶æ„çš„ APK
            # arm64-v8a
            find "$APK_DIR" -name "app-arm64-v8a-release.apk" -exec cp {} "dist-artifacts/AIO-Hub_${VERSION}_arm64-v8a.apk" \;
            # armeabi-v7a
            find "$APK_DIR" -name "app-armeabi-v7a-release.apk" -exec cp {} "dist-artifacts/AIO-Hub_${VERSION}_armeabi-v7a.apk" \;
            # x86_64
            find "$APK_DIR" -name "app-x86_64-release.apk" -exec cp {} "dist-artifacts/AIO-Hub_${VERSION}_x86_64.apk" \;
          fi

          echo "å‡†å¤‡ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh dist-artifacts/

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aio-hub-mobile-android-${{ steps.get-version.outputs.version }}
          path: dist-artifacts/*

  release:
    name: å‘å¸ƒ Release
    runs-on: ubuntu-latest
    needs: [build-android]
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–å‘å¸ƒä¿¡æ¯
        id: get-release-info
        shell: bash
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            RELEASE_NAME="AIO Hub Mobile ${VERSION}"
            IS_DRAFT="false"
          else
            VERSION="mobile-main"
            RELEASE_NAME="AIO Hub Mobile main è‰æ¡ˆ (${SHORT_SHA})"
            IS_DRAFT="true"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "is_draft=${IS_DRAFT}" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get-release-info.outputs.version }}
          name: ${{ steps.get-release-info.outputs.name }}
          body: |
            ## ğŸ“± ç§»åŠ¨ç«¯ç‰ˆæœ¬å‘å¸ƒ

            è¿™æ˜¯ AIO Hub çš„ç§»åŠ¨ç«¯æ„å»ºç‰ˆæœ¬ã€‚



            ### ä¸‹è½½è¯´æ˜
            - **Android**:
              - `_arm64-v8a.apk`: é€‚ç”¨äºå¤§å¤šæ•°ç°ä»£å®‰å“æ‰‹æœºã€‚
              - `_universal.apk`: é€šç”¨ç‰ˆæœ¬ã€‚
              - `_armeabi-v7a.apk`: é€‚ç”¨äºæ—§æ¬¾ 32 ä½å®‰å“æ‰‹æœºã€‚

            ### æ³¨æ„äº‹é¡¹
            - ç§»åŠ¨ç«¯ç›®å‰å¤„äºå¼€å‘é¢„è§ˆé˜¶æ®µã€‚
            - æ¨èä¼˜å…ˆä¸‹è½½ `arm64-v8a` ç‰ˆæœ¬ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚
          draft: ${{ steps.get-release-info.outputs.is_draft }}
          prerelease: ${{ contains(steps.get-release-info.outputs.version, 'beta') || contains(steps.get-release-info.outputs.version, 'alpha') }}
          files: artifacts/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
