name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - "v*.*.*" # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v0.1.9ï¼‰
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "windows-latest"
            target: "x86_64-pc-windows-msvc"
            bundles: "nsis"
          - platform: "ubuntu-22.04"
            target: "x86_64-unknown-linux-gnu"
            bundles: "deb,appimage"
          - platform: "macos-latest"
            target: "aarch64-apple-darwin"
            bundles: "dmg"
          - platform: "macos-latest"
            target: "x86_64-apple-darwin"
            bundles: "dmg"

    runs-on: ${{ matrix.platform }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: å®‰è£… Rust ç¨³å®šç‰ˆ
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: å®‰è£…ä¾èµ– (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev pkg-config libgit2-dev libwebkit2gtk-4.1-dev librsvg2-dev patchelf libayatana-appindicator3-dev

      - name: å®‰è£…ä¾èµ– (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          # ä¸éœ€è¦å®‰è£… openssl å’Œ libgit2ï¼Œä½¿ç”¨ vendored ç‰¹æ€§
          echo "ä½¿ç”¨ vendored OpenSSL å’Œ libgit2"

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: bun install

      - name: æ„å»ºåº”ç”¨ (ä»…æ„å»ºï¼Œä¸åˆ›å»º Release)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # ä¸ä¼ é€’ tagName/releaseName/releaseBodyï¼Œç¦ç”¨è‡ªåŠ¨åˆ›å»º Release
          args: --target ${{ matrix.target }} --bundles ${{ matrix.bundles }}
      - name: è·å–ç‰ˆæœ¬å·
        id: get-version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # å¦‚æœæ˜¯æ ‡ç­¾è§¦å‘ï¼Œç›´æ¥ä½¿ç”¨æ ‡ç­¾å
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            # å¦åˆ™ä» package.json è¯»å–ç‰ˆæœ¬å·
            VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: è®¾ç½®å¹³å°ç®€ç§°å’Œæ–‡ä»¶ç±»å‹
        id: platform-name
        shell: bash
        run: |
          case "${{ matrix.target }}" in
            "x86_64-pc-windows-msvc")
              echo "name=windows-x64" >> $GITHUB_OUTPUT
              echo "ext=exe" >> $GITHUB_OUTPUT
              ;;
            "x86_64-unknown-linux-gnu")
              echo "name=linux-x64" >> $GITHUB_OUTPUT
              echo "ext=deb-appimage" >> $GITHUB_OUTPUT
              ;;
            "aarch64-apple-darwin")
              echo "name=macos-arm64" >> $GITHUB_OUTPUT
              echo "ext=dmg" >> $GITHUB_OUTPUT
              ;;
            "x86_64-apple-darwin")
              echo "name=macos-x64" >> $GITHUB_OUTPUT
              echo "ext=dmg" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "name=unknown" >> $GITHUB_OUTPUT
              echo "ext=bin" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: å‡†å¤‡æ‰å¹³åŒ–çš„æ„å»ºäº§ç‰©
        shell: bash
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºå­˜æ”¾æ‰å¹³åŒ–çš„æ–‡ä»¶
          mkdir -p dist-artifacts

          # æ ¹æ®å¹³å°ç±»å‹ï¼Œå°†åµŒå¥—åœ¨å­ç›®å½•ä¸­çš„æ–‡ä»¶å¤åˆ¶åˆ°æ‰å¹³ç›®å½•
          case "${{ matrix.target }}" in
            "x86_64-pc-windows-msvc")
              # Windows: ä» nsis/ ç›®å½•ä¸­æå–å®‰è£…ç¨‹åº
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.exe" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.msi" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              # æå–åŸå§‹äºŒè¿›åˆ¶æ–‡ä»¶ä½œä¸ºä¾¿æºç‰ˆ
              RAW_EXE="src-tauri/target/${{ matrix.target }}/release/aiohub.exe"
              if [ -f "$RAW_EXE" ]; then
                cp "$RAW_EXE" "dist-artifacts/AIO-Hub-${{ steps.get-version.outputs.version }}-windows-x64-Portable.exe"
                # åˆ›å»ºæ ‡è¯†æ–‡ä»¶
                echo "Portable Mode Enabled" > dist-artifacts/portable.flag
              fi
              ;;
            "x86_64-unknown-linux-gnu")
              # Linux: ä»å„è‡ªçš„å­ç›®å½•ä¸­æå– .deb å’Œ .AppImage
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.deb" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.AppImage" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              ;;
            *-apple-darwin)
              # macOS: ä» dmg/ ç›®å½•ä¸­æå– .dmg
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.dmg" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              ;;
          esac

          # æ˜¾ç¤ºå‡†å¤‡å¥½çš„æ–‡ä»¶åˆ—è¡¨
          echo "å‡†å¤‡ä¸Šä¼ çš„æ–‡ä»¶ï¼š"
          ls -lh dist-artifacts/

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: aio-hub-${{ steps.get-version.outputs.version }}-${{ steps.platform-name.outputs.name }}.${{ steps.platform-name.outputs.ext }}
          path: dist-artifacts/*
          if-no-files-found: warn

  # Flatpak æ„å»º (ç‹¬ç«‹ Job)
  build-flatpak:
    runs-on: ubuntu-22.04
    needs: build # ç­‰å¾…ä¸»æ„å»ºå®Œæˆ

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: å®‰è£… Rust ç¨³å®šç‰ˆ
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: å®‰è£… Flatpak æ„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          # æ·»åŠ  Flathub ä»“åº“
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          # å®‰è£… Freedesktop SDK å’Œ Platform
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: å®‰è£… Tauri æ„å»ºä¾èµ–
        run: |
          sudo apt-get install -y build-essential libssl-dev pkg-config libgit2-dev libwebkit2gtk-4.1-dev librsvg2-dev patchelf libayatana-appindicator3-dev

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: bun install

      - name: æ„å»ºåº”ç”¨ (ä½¿ç”¨ tauri build ç¡®ä¿èµ„æºåµŒå…¥)
        run: bun tauri build

      - name: å‡†å¤‡ Flatpak æºæ–‡ä»¶
        run: |
          # å°†æ‰€æœ‰æºæ–‡ä»¶å¤åˆ¶åˆ° src-tauri ç›®å½•ï¼ˆæ¸…å•æ–‡ä»¶æ‰€åœ¨ä½ç½®ï¼‰
          # è¿™æ · flatpak-builder å¯ä»¥é€šè¿‡ç›¸å¯¹è·¯å¾„æ‰¾åˆ°å®ƒä»¬
          # æ³¨æ„ï¼štauri build ç”Ÿæˆçš„è·¯å¾„å¯èƒ½ä¸å¸¦ target ç›®å½•åï¼ˆå–å†³äºé…ç½®ï¼‰ï¼Œè¿™é‡Œä½¿ç”¨ find ç¡®ä¿æ‰¾åˆ°
          BINARY_PATH=$(find src-tauri/target/x86_64-unknown-linux-gnu/release -maxdepth 1 -type f -name "aiohub" | head -n 1)
          if [ -z "$BINARY_PATH" ]; then
            BINARY_PATH="src-tauri/target/release/aiohub"
          fi
          cp "$BINARY_PATH" src-tauri/aiohub
          # å‰¥ç¦»è°ƒè¯•ç¬¦å·ä»¥å‡å°ä½“ç§¯
          strip src-tauri/aiohub
          chmod +x src-tauri/aiohub
          cp src-tauri/icons/128x128.png src-tauri/com.mty.aiohub.png
          # åˆ—å‡ºå‡†å¤‡å¥½çš„æ–‡ä»¶
          echo "å‡†å¤‡å¥½çš„ Flatpak æºæ–‡ä»¶ï¼š"
          ls -la src-tauri/aiohub src-tauri/com.mty.aiohub.desktop src-tauri/com.mty.aiohub.png src-tauri/com.mty.aiohub.yml

      - name: æ„å»º Flatpak
        run: |
          # flatpak-builder <build-dir> <manifest-path>
          # build-dir: flatpak-builder çš„å·¥ä½œç›®å½•ï¼ˆä¼šè¢«æ¸…ç©ºï¼‰
          # manifest-path: æ¸…å•æ–‡ä»¶è·¯å¾„ï¼Œæºæ–‡ä»¶è·¯å¾„ç›¸å¯¹äºæ¸…å•æ–‡ä»¶ä½ç½®
          flatpak-builder --force-clean --repo=flatpak-repo flatpak-build src-tauri/com.mty.aiohub.yml
          flatpak build-bundle flatpak-repo aio-hub.flatpak com.mty.aiohub

      - name: è·å–ç‰ˆæœ¬å·
        id: get-version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # ä»æ ‡ç­¾åä¸­æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
            VERSION="${{ github.ref_name }}"
            VERSION_NUM="${VERSION#v}"
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "version_num=${VERSION_NUM}" >> $GITHUB_OUTPUT
          else
            VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
            echo "version_num=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: é‡å‘½å Flatpak æ–‡ä»¶
        run: |
          # é‡å‘½åä¸ºå¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶åï¼Œä¸å…¶ä»–å¹³å°ä¿æŒä¸€è‡´
          mv aio-hub.flatpak AIO.Hub_${{ steps.get-version.outputs.version_num }}_amd64.flatpak

      - name: ä¸Šä¼  Flatpak æ„å»ºäº§ç‰©åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aio-hub-${{ steps.get-version.outputs.version }}-linux-x64.flatpak
          path: AIO.Hub_${{ steps.get-version.outputs.version_num }}_amd64.flatpak
          if-no-files-found: warn

  # ç»Ÿä¸€å‘å¸ƒ Job - ç­‰å¾…æ‰€æœ‰æ„å»ºå®Œæˆåç»Ÿä¸€ä¸Šä¼ åˆ° Release
  release:
    runs-on: ubuntu-latest
    needs: [build, build-flatpak]
    # å…è®¸ Tag è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–å‘å¸ƒä¿¡æ¯
        id: get-release-info
        shell: bash
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # æ ‡ç­¾è§¦å‘ï¼šä½¿ç”¨çœŸå®ç‰ˆæœ¬å·
            VERSION="${{ github.ref_name }}"
            RELEASE_NAME="AIO Hub ${VERSION}"
            IS_MAIN_DRAFT="false"
          else
            # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨ main è‰æ¡ˆï¼Œæ ‡è®°æäº¤å“ˆå¸Œ
            VERSION="main"
            RELEASE_NAME="AIO Hub main è‰æ¡ˆ (${SHORT_SHA})"
            IS_MAIN_DRAFT="true"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "is_main_draft=${IS_MAIN_DRAFT}" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        shell: bash
        run: |
          mkdir -p release-files

          # éå†æ‰€æœ‰ artifact ç›®å½•ï¼Œå°†æ–‡ä»¶å¤åˆ¶åˆ° release-files
          echo "=== ä¸‹è½½çš„ Artifacts ç»“æ„ ==="
          find artifacts -type f -ls

          echo "=== å¤åˆ¶æ–‡ä»¶åˆ° release-files ==="
          # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©ï¼ˆæ’é™¤ç›®å½•ï¼‰
          find artifacts -type f \( -name "*.exe" -o -name "*.msi" -o -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" -o -name "*.flatpak" \) -exec cp {} release-files/ \;

          echo "=== å‡†å¤‡ä¸Šä¼ çš„æ–‡ä»¶ ==="
          ls -lh release-files/

      - name: åˆ›å»º Release å¹¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get-release-info.outputs.version }}
          name: ${{ steps.get-release-info.outputs.name }}
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ



            ### ä¸‹è½½è¯´æ˜
            - **Windows**:
              - `.exe` (x64 å®‰è£…ç¨‹åº)
              - `-Portable.exe` (ç»¿è‰²ä¾¿æºç‰ˆï¼Œæ•°æ®å­˜æ”¾åœ¨åŒçº§ data ç›®å½•)
            - **macOS**:
              - `_aarch64.dmg` (Apple Silicon: M1/M2/M3)
              - `_x64.dmg` (Intel èŠ¯ç‰‡)
            - **Linux**:
              - `.deb` (Debian/Ubuntu)
              - `.AppImage` (é€šç”¨)
              - `.flatpak` (æ²™ç›’ç‰ˆ)

            ### æ³¨æ„äº‹é¡¹
            - macOS ç”¨æˆ·é¦–æ¬¡æ‰“å¼€å¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œï¼Œæˆ–å‚è€ƒ https://github.com/miaotouy/aio-hub/blob/main/docs/guide/macos-gatekeeper-fix.md ä¸­çš„è¿è¡Œæ–¹æ³•
            - Linux ç”¨æˆ·ä½¿ç”¨ AppImage éœ€è¦å…ˆæ·»åŠ æ‰§è¡Œæƒé™: `chmod +x *.AppImage`
          draft: true
          prerelease: ${{ steps.get-release-info.outputs.is_main_draft == 'true' || contains(steps.get-release-info.outputs.version, 'beta') || contains(steps.get-release-info.outputs.version, 'alpha') || contains(steps.get-release-info.outputs.version, 'dev') }}
          make_latest: ${{ steps.get-release-info.outputs.is_main_draft != 'true' }}
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
