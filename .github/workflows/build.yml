name: æž„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v0.1.9ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            bundles: 'nsis'
          - platform: 'ubuntu-22.04'
            target: 'x86_64-unknown-linux-gnu'
            bundles: 'deb,appimage'
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            bundles: 'dmg'
          - platform: 'macos-latest'
            target: 'x86_64-apple-darwin'
            bundles: 'dmg'

    runs-on: ${{ matrix.platform }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: å®‰è£… Rust ç¨³å®šç‰ˆ
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: å®‰è£…ä¾èµ– (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev pkg-config libgit2-dev libwebkit2gtk-4.1-dev librsvg2-dev patchelf libayatana-appindicator3-dev

      - name: å®‰è£…ä¾èµ– (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          # ä¸éœ€è¦å®‰è£… openssl å’Œ libgit2ï¼Œä½¿ç”¨ vendored ç‰¹æ€§
          echo "ä½¿ç”¨ vendored OpenSSL å’Œ libgit2"

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: bun install

      - name: æž„å»ºåº”ç”¨
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'AIO Hub ${{ github.ref_name }}'
          releaseBody: |
            ## ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            ### å˜æ›´å†…å®¹
            æŸ¥çœ‹å®Œæ•´çš„ [Changelog](https://github.com/miaotouy/aio-hub/blob/main/CHANGELOG.md)
            
            ### ä¸‹è½½è¯´æ˜Ž
            - **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åº
            - **macOS**: ä¸‹è½½ `.dmg` é•œåƒæ–‡ä»¶
            - **Linux**: ä¸‹è½½ `.deb` (Debian/Ubuntu) æˆ– `.AppImage` (é€šç”¨)
            
            ### æ³¨æ„äº‹é¡¹
            - macOS ç”¨æˆ·é¦–æ¬¡æ‰“å¼€å¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸Žéšç§"ä¸­å…è®¸è¿è¡Œ
            - Linux ç”¨æˆ·ä½¿ç”¨ AppImage éœ€è¦å…ˆæ·»åŠ æ‰§è¡Œæƒé™: `chmod +x *.AppImage`
          releaseDraft: true
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          args: --target ${{ matrix.target }} --bundles ${{ matrix.bundles }}

      - name: è®¾ç½®å¹³å°ç®€ç§°
        id: platform-name
        shell: bash
        run: |
          case "${{ matrix.target }}" in
            "x86_64-pc-windows-msvc")
              echo "name=windows-x64" >> $GITHUB_OUTPUT
              ;;
            "x86_64-unknown-linux-gnu")
              echo "name=linux-x64" >> $GITHUB_OUTPUT
              ;;
            "aarch64-apple-darwin")
              echo "name=macos-arm64" >> $GITHUB_OUTPUT
              ;;
            "x86_64-apple-darwin")
              echo "name=macos-x64" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "name=unknown" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: aio-hub-${{ github.ref_name }}-${{ steps.platform-name.outputs.name }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.exe
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dmg
          if-no-files-found: warn