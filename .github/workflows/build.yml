name: æž„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v0.1.9ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            bundles: 'nsis'
          - platform: 'ubuntu-22.04'
            target: 'x86_64-unknown-linux-gnu'
            bundles: 'deb,appimage'
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            bundles: 'dmg'
          - platform: 'macos-latest'
            target: 'x86_64-apple-darwin'
            bundles: 'dmg'

    runs-on: ${{ matrix.platform }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: å®‰è£… Rust ç¨³å®šç‰ˆ
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: å®‰è£…ä¾èµ– (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev pkg-config libgit2-dev libwebkit2gtk-4.1-dev librsvg2-dev patchelf libayatana-appindicator3-dev

      - name: å®‰è£…ä¾èµ– (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          # ä¸éœ€è¦å®‰è£… openssl å’Œ libgit2ï¼Œä½¿ç”¨ vendored ç‰¹æ€§
          echo "ä½¿ç”¨ vendored OpenSSL å’Œ libgit2"

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: bun install

      - name: æž„å»ºåº”ç”¨
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'AIO Hub ${{ github.ref_name }}'
          releaseBody: |
            ## ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            ### å˜æ›´å†…å®¹
            æŸ¥çœ‹å®Œæ•´çš„ [Changelog](https://github.com/miaotouy/aio-hub/blob/main/CHANGELOG.md)
            
            ### ä¸‹è½½è¯´æ˜Ž
            - **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åº
            - **macOS**: ä¸‹è½½ `.dmg` é•œåƒæ–‡ä»¶
            - **Linux**: ä¸‹è½½ `.deb` (Debian/Ubuntu) æˆ– `.AppImage` (é€šç”¨)
            
            ### æ³¨æ„äº‹é¡¹
            - macOS ç”¨æˆ·é¦–æ¬¡æ‰“å¼€å¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸Žéšç§"ä¸­å…è®¸è¿è¡Œ
            - Linux ç”¨æˆ·ä½¿ç”¨ AppImage éœ€è¦å…ˆæ·»åŠ æ‰§è¡Œæƒé™: `chmod +x *.AppImage`
          releaseDraft: true
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          args: --target ${{ matrix.target }} --bundles ${{ matrix.bundles }}

      - name: èŽ·å–ç‰ˆæœ¬å·
        id: get-version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # å¦‚æžœæ˜¯æ ‡ç­¾è§¦å‘ï¼Œç›´æŽ¥ä½¿ç”¨æ ‡ç­¾å
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            # å¦åˆ™ä»Ž package.json è¯»å–ç‰ˆæœ¬å·
            VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: è®¾ç½®å¹³å°ç®€ç§°å’Œæ–‡ä»¶ç±»åž‹
        id: platform-name
        shell: bash
        run: |
          case "${{ matrix.target }}" in
            "x86_64-pc-windows-msvc")
              echo "name=windows-x64" >> $GITHUB_OUTPUT
              echo "ext=exe" >> $GITHUB_OUTPUT
              ;;
            "x86_64-unknown-linux-gnu")
              echo "name=linux-x64" >> $GITHUB_OUTPUT
              echo "ext=deb-appimage" >> $GITHUB_OUTPUT
              ;;
            "aarch64-apple-darwin")
              echo "name=macos-arm64" >> $GITHUB_OUTPUT
              echo "ext=dmg" >> $GITHUB_OUTPUT
              ;;
            "x86_64-apple-darwin")
              echo "name=macos-x64" >> $GITHUB_OUTPUT
              echo "ext=dmg" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "name=unknown" >> $GITHUB_OUTPUT
              echo "ext=bin" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: å‡†å¤‡æ‰å¹³åŒ–çš„æž„å»ºäº§ç‰©
        shell: bash
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºŽå­˜æ”¾æ‰å¹³åŒ–çš„æ–‡ä»¶
          mkdir -p dist-artifacts
          
          # æ ¹æ®å¹³å°ç±»åž‹ï¼Œå°†åµŒå¥—åœ¨å­ç›®å½•ä¸­çš„æ–‡ä»¶å¤åˆ¶åˆ°æ‰å¹³ç›®å½•
          case "${{ matrix.target }}" in
            "x86_64-pc-windows-msvc")
              # Windows: ä»Ž nsis/ ç›®å½•ä¸­æå– .exe å’Œ .msi
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.exe" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.msi" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              ;;
            "x86_64-unknown-linux-gnu")
              # Linux: ä»Žå„è‡ªçš„å­ç›®å½•ä¸­æå– .deb å’Œ .AppImage
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.deb" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.AppImage" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              ;;
            *-apple-darwin)
              # macOS: ä»Ž dmg/ ç›®å½•ä¸­æå– .dmg
              find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.dmg" -exec cp {} dist-artifacts/ \; 2>/dev/null || true
              ;;
          esac
          
          # æ˜¾ç¤ºå‡†å¤‡å¥½çš„æ–‡ä»¶åˆ—è¡¨
          echo "å‡†å¤‡ä¸Šä¼ çš„æ–‡ä»¶ï¼š"
          ls -lh dist-artifacts/

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: aio-hub-${{ steps.get-version.outputs.version }}-${{ steps.platform-name.outputs.name }}.${{ steps.platform-name.outputs.ext }}
          path: dist-artifacts/*
          if-no-files-found: warn

  # Flatpak æž„å»º (ç‹¬ç«‹ Job)
  build-flatpak:
    runs-on: ubuntu-22.04
    needs: build  # ç­‰å¾…ä¸»æž„å»ºå®Œæˆ
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: å®‰è£… Rust ç¨³å®šç‰ˆ
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: å®‰è£… Flatpak æž„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          # æ·»åŠ  Flathub ä»“åº“
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          # å®‰è£… Freedesktop SDK å’Œ Platform
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: å®‰è£… Tauri æž„å»ºä¾èµ–
        run: |
          sudo apt-get install -y build-essential libssl-dev pkg-config libgit2-dev libwebkit2gtk-4.1-dev librsvg2-dev patchelf libayatana-appindicator3-dev

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: bun install

      - name: æž„å»ºå‰ç«¯
        run: bun run build

      - name: æž„å»º Rust åŽç«¯
        run: |
          cd src-tauri
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: å‡†å¤‡ Flatpak æž„å»ºç›®å½•
        run: |
          mkdir -p flatpak-build
          # æ‹·è´äºŒè¿›åˆ¶æ–‡ä»¶
          cp src-tauri/target/x86_64-unknown-linux-gnu/release/aiohub flatpak-build/aiohub
          chmod +x flatpak-build/aiohub
          # æ‹·è´èµ„æºæ–‡ä»¶
          cp src-tauri/com.mty.aiohub.desktop flatpak-build/com.mty.aiohub.desktop
          cp src-tauri/icons/128x128.png flatpak-build/com.mty.aiohub.png
          # æ‹·è´æ¸…å•æ–‡ä»¶ä»¥ä¾¿ flatpak-builder åœ¨åŒçº§ç›®å½•æŸ¥æ‰¾èµ„æº
          cp src-tauri/com.mty.aiohub.yml flatpak-build/com.mty.aiohub.yml

      - name: æž„å»º Flatpak
        run: |
          flatpak-builder --force-clean --repo=flatpak-repo flatpak-build flatpak-build/com.mty.aiohub.yml
          flatpak build-bundle flatpak-repo aio-hub.flatpak com.mty.aiohub

      - name: èŽ·å–ç‰ˆæœ¬å·
        id: get-version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: ä¸Šä¼  Flatpak æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: aio-hub-${{ steps.get-version.outputs.version }}-linux-x64.flatpak
          path: aio-hub.flatpak
          if-no-files-found: warn