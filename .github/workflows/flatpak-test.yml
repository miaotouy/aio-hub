name: 手动测试 Flatpak 构建

on:
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: read

jobs:
  build-flatpak:
    runs-on: ubuntu-22.04
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: 安装 Rust 稳定版
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: 安装 Flatpak 构建依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          # 添加 Flathub 仓库
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          # 安装 GNOME SDK 和 Platform (匹配清单文件中的版本 46)
          sudo flatpak install -y flathub org.gnome.Platform//46 org.gnome.Sdk//46

      - name: 安装 Tauri 构建依赖
        run: |
          sudo apt-get install -y build-essential libssl-dev pkg-config libgit2-dev libwebkit2gtk-4.1-dev librsvg2-dev patchelf libayatana-appindicator3-dev

      - name: Rust 缓存
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: 安装前端依赖
        run: bun install

      - name: 构建应用 (使用 tauri build 确保资源嵌入)
        run: bun tauri build

      - name: 准备 Flatpak 源文件
        run: |
          # 将所有源文件复制到 src-tauri 目录（清单文件所在位置）
          # 这样 flatpak-builder 可以通过相对路径找到它们
          BINARY_PATH=$(find src-tauri/target/x86_64-unknown-linux-gnu/release -maxdepth 1 -type f -name "aiohub" | head -n 1)
          if [ -z "$BINARY_PATH" ]; then
            BINARY_PATH="src-tauri/target/release/aiohub"
          fi
          cp "$BINARY_PATH" src-tauri/aiohub
          # 剥离调试符号以减小体积
          strip src-tauri/aiohub
          chmod +x src-tauri/aiohub
          cp src-tauri/icons/128x128.png src-tauri/com.mty.aiohub.png
          # 列出准备好的文件
          echo "准备好的 Flatpak 源文件："
          ls -la src-tauri/aiohub src-tauri/com.mty.aiohub.desktop src-tauri/com.mty.aiohub.png src-tauri/com.mty.aiohub.yml

      - name: 构建 Flatpak
        run: |
          # flatpak-builder <build-dir> <manifest-path>
          # build-dir: flatpak-builder 的工作目录（会被清空）
          # manifest-path: 清单文件路径，源文件路径相对于清单文件位置
          flatpak-builder --force-clean --repo=flatpak-repo flatpak-build src-tauri/com.mty.aiohub.yml
          flatpak build-bundle flatpak-repo aio-hub-test.flatpak com.mty.aiohub

      - name: 上传 Flatpak 测试产物
        uses: actions/upload-artifact@v4
        with:
          name: aio-hub-test-linux-x64.flatpak
          path: aio-hub-test.flatpak
          if-no-files-found: error