# ğŸ“ AIO çŸ¥è¯†åº“è®¾è®¡æ–¹æ¡ˆ

## ä¸€ã€å±‚çº§æ€»è§ˆ (Architecture Overview)

æ•´ä¸ªçŸ¥è¯†å¼•æ“ç”±ä¸‰ä¸ªæ ¸å¿ƒå±‚çº§ç»„æˆï¼Œè‡ªä¸Šè€Œä¸‹ç®¡ç†çŸ¥è¯†çš„ç»„ç»‡ã€å­˜å‚¨ä¸æ£€ç´¢ã€‚

```mermaid
graph TD
    WS[KnowledgeWorkspace<br/>å…¨å±€å·¥ä½œåŒº] -->|åŒ…å«| KB_List[KnowledgeBase Index<br/>çŸ¥è¯†åº“ç´¢å¼•åˆ—è¡¨]
    WS -->|åŒ…å«| WC[WorkspaceConfig<br/>å…¨å±€é…ç½®]

    KB_List -.->|æ‡’åŠ è½½| KB[KnowledgeBase<br/>çŸ¥è¯†åº“å®ä½“]
    KB -->|åŒ…å«| CAIU[CAIU<br/>åŸå­ä¿¡æ¯å•å…ƒ]

    subgraph Runtime [Rust è¿è¡Œæ—¶å†…å­˜]
        RI[RuntimeIndex<br/>å…¨å±€è¿è¡Œæ—¶ç´¢å¼•]
        RI -->|Tagå€’æ’| TagMap[Tag -> CAIU_ID]
        RI -->|Keyæ˜ å°„| KeyMap[Key -> CAIU_ID]
        RI -->|å¼•ç”¨å›¾ç¼“å­˜| RefCache[Reference Graph Cache]
        RI -->|å‘é‡æ£€ç´¢| VectorIndex[HNSW Index]
    end

    subgraph External [å¤–éƒ¨ä¾èµ–]
        AM[AssetManager<br/>å…¨å±€èµ„äº§ç®¡ç†å™¨]
    end

    CAIU -.->|èµ„äº§å¼•ç”¨| AM
```

---

## äºŒã€Rust æ•°æ®ç»“æ„å®šä¹‰ (Rust Implementation)

ä¸ºäº†å…¼é¡¾å¼€å‘ä½“éªŒä¸è¿è¡Œæ•ˆç‡ï¼Œç³»ç»Ÿä½¿ç”¨ `serde` è¿›è¡Œåºåˆ—åŒ–å¤„ç†ï¼Œå¹¶é‡‡ç”¨ `Uuid` ä½œä¸ºå”¯ä¸€æ ‡è¯†ã€‚

### 2.1 å…¨å±€å·¥ä½œåŒº (Workspace)

```rust
use serde::{Serialize, Deserialize};
use uuid::Uuid;
use std::collections::HashMap;

#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct KnowledgeWorkspace {
    pub version: String,
    pub config: WorkspaceConfig,
    pub bases: Vec<KnowledgeBaseIndex>,
}

#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct WorkspaceConfig {
    pub default_embedding_model: String,
    pub vector_index: VectorIndexConfig,
}

#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct VectorIndexConfig {
    /// ç´¢å¼•ç®—æ³•: "hnsw", "flat", "ivf" ç­‰
    pub algorithm: String,
    /// å‘é‡ç»´åº¦ï¼Œéœ€ä¸ embedding model è¾“å‡ºåŒ¹é…
    pub dimension: usize,
    /// è·ç¦»åº¦é‡: "cosine", "euclidean", "dot"
    pub metric: String,
    /// HNSW ç‰¹å®šå‚æ•°: æ„å»ºæ—¶çš„é‚»å±…æ•°é‡
    pub ef_construction: Option<usize>,
    /// HNSW ç‰¹å®šå‚æ•°: æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§è¿æ¥æ•°
    pub m: Option<usize>,
}

#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct KnowledgeBaseIndex {
    pub id: Uuid,
    pub name: String,
    pub description: Option<String>,
    pub entry_count: usize,
    pub last_updated: i64,
    pub path: String, // ç›¸å¯¹è·¯å¾„

    // è¿è¡Œæ—¶çŠ¶æ€ (ä¸åºåˆ—åŒ–åˆ° JSON)
    #[serde(skip)]
    pub is_loaded: bool,
    #[serde(skip)]
    pub is_vectorized: bool,
}
```

### 2.2 çŸ¥è¯†åº“ (KnowledgeBase)

**æ³¨æ„**ï¼šå¯¹äºå¤§å‹æ–‡æœ¬å†…å®¹ï¼Œåœ¨ååºåˆ—åŒ–æ—¶å»ºè®®ä½¿ç”¨ `std::borrow::Cow` ä»¥å‡å°‘å†…å­˜å¤åˆ¶ã€‚

```rust
#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct KnowledgeBase {
    pub id: Uuid,
    pub name: String,
    pub description: Option<String>,

    pub schema_version: String,
    pub content_version: u64,

    pub embedding: EmbeddingConfig,
    pub meta: KnowledgeBaseMeta,

    pub entries: Vec<Caiu>,
}

#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct EmbeddingConfig {
    /// ä½¿ç”¨çš„ embedding æ¨¡å‹æ ‡è¯†
    pub model: String,
    /// å‘é‡ç»´åº¦
    pub dimension: usize,
    /// æ‰¹å¤„ç†å¤§å°
    pub batch_size: usize,
    /// æ˜¯å¦å·²å®Œæˆå‘é‡åŒ–
    pub is_indexed: bool,
    /// æœ€åå‘é‡åŒ–æ—¶é—´æˆ³
    pub last_indexed_at: Option<i64>,
}

#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct KnowledgeBaseMeta {
    pub created_at: i64,
    pub updated_at: i64,
    pub author: Option<String>,
    /// çŸ¥è¯†åº“çº§åˆ«çš„æ ‡ç­¾ï¼Œç”¨äºåˆ†ç±»
    pub tags: Vec<String>,
    /// çŸ¥è¯†åº“å›¾æ ‡ (Asset ID)
    pub icon: Option<String>,
}

#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct Caiu {
    pub id: Uuid,
    pub key: String,         // ç”¨äº [[Key]] å¼•ç”¨
    pub content: String,     // Markdown å†…å®¹

    pub tags: Vec<String>,   // é€é•œé”šç‚¹

    #[serde(default)]
    pub assets: Vec<AssetRef>,

    #[serde(default = "default_priority")]
    pub priority: i32,

    #[serde(default = "default_enabled")]
    pub enabled: bool,

    // è¿è¡Œæ—¶è®¡ç®—çš„å¼•ç”¨å…³ç³» (ä¸æŒä¹…åŒ–ï¼Œé€šè¿‡å†…å­˜ç¼“å­˜ç»´æŠ¤)
    #[serde(skip)]
    pub refs: Vec<Uuid>,     // æœ¬æ¡ç›®å¼•ç”¨çš„å…¶ä»–æ¡ç›®
    #[serde(skip)]
    pub ref_by: Vec<Uuid>,   // å¼•ç”¨æœ¬æ¡ç›®çš„å…¶ä»–æ¡ç›®
}

/// èµ„äº§å¼•ç”¨ç»“æ„ï¼ŒæŒ‡å‘å…¨å±€ AssetManager ä¸­çš„èµ„äº§
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct AssetRef {
    /// AssetManager ä¸­çš„èµ„äº§ ID
    pub id: String,
    /// æ˜¾ç¤ºåç§°
    pub name: String,
    /// MIME ç±»å‹
    pub mime_type: String,
    /// åè®®å‰ç¼€ï¼Œåº”ä¸º "appdata://"
    pub protocol: String,
}

fn default_priority() -> i32 { 100 }
fn default_enabled() -> bool { true }
```

### 2.3 äº¤äº’æ•°æ®ç»“æ„

```rust
/// åˆ›å»º/æ›´æ–° CAIU çš„è¾“å…¥ç»“æ„
#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CaiuInput {
    pub key: String,
    pub content: String,
    pub tags: Vec<String>,
    /// Asset IDs (æ¥è‡ª AssetManager)
    pub asset_ids: Vec<String>,
    pub priority: Option<i32>,
}

/// æœç´¢è¿‡æ»¤å™¨
#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct SearchFilters {
    /// é™å®šæœç´¢çš„çŸ¥è¯†åº“ ID åˆ—è¡¨ï¼ŒNone è¡¨ç¤ºæœç´¢æ‰€æœ‰
    pub kb_ids: Option<Vec<Uuid>>,
    /// æ ‡ç­¾è¿‡æ»¤
    pub tags: Option<Vec<String>>,
    /// æœ€ä½ç›¸å…³åº¦åˆ†æ•°é˜ˆå€¼ (0.0 - 1.0)
    pub min_score: Option<f32>,
    /// è¿”å›ç»“æœæ•°é‡ä¸Šé™
    pub limit: usize,
    /// æ˜¯å¦åŒ…å«ç¦ç”¨çš„æ¡ç›®
    pub include_disabled: bool,
}

/// æœç´¢ç»“æœ
#[derive(Debug, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct SearchResult {
    /// å‘½ä¸­çš„ CAIU
    pub caiu: Caiu,
    /// ç›¸å…³åº¦åˆ†æ•° (0.0 - 1.0)
    pub score: f32,
    /// åŒ¹é…ç±»å‹: "semantic", "keyword", "hybrid"
    pub match_type: String,
    /// é«˜äº®ç‰‡æ®µ (ç”¨äº UI å±•ç¤º)
    pub highlight: Option<String>,
    /// æ‰€å±çŸ¥è¯†åº“ ID
    pub kb_id: Uuid,
    /// æ‰€å±çŸ¥è¯†åº“åç§°
    pub kb_name: String,
}
```

---

## ä¸‰ã€å…³é”®æŠ€æœ¯æ–¹æ¡ˆ

### 3.1 JSON è§£ææ€§èƒ½ä¼˜åŒ–ç­–ç•¥

ä¸ºç¡®ä¿ Rust ç«¯é«˜æ•ˆè§£æå¤§å‹ JSON ç»“æ„ï¼Œé‡‡ç”¨ä»¥ä¸‹æŠ€æœ¯ç­–ç•¥ï¼š

1.  **æµå¼è¯»å– (Streaming IO)**:
    ä½¿ç”¨ `BufReader` é…åˆ `serde_json::from_reader` æ›¿ä»£ `fs::read_to_string`ï¼Œä»¥æ˜¾è‘—é™ä½å³°å€¼å†…å­˜å ç”¨ã€‚

    ```rust
    let file = File::open("path/to/large_kb.json")?;
    let reader = BufReader::new(file);
    let kb: KnowledgeBase = serde_json::from_reader(reader)?;
    ```

2.  **å¹¶è¡ŒåŠ è½½ (Parallel Loading)**:
    åˆ©ç”¨ `rayon` åº“å¹¶è¡ŒåŠ è½½å’Œè§£æ Workspace ä¸­çš„å¤šä¸ªç‹¬ç«‹ KnowledgeBase æ–‡ä»¶ï¼Œç¼©çŸ­å†·å¯åŠ¨æ—¶é—´ã€‚

3.  **å­—ç¬¦ä¸²å»é‡ (String Interning)**:
    å¯¹äº `tags` ç­‰é«˜é¢‘é‡å¤å­—ç¬¦ä¸²ï¼Œåœ¨å†…å­˜ä¸­ä½¿ç”¨ `string_cache` æˆ– `HashSet` è¿›è¡Œå»é‡å­˜å‚¨ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ã€‚

### 3.2 å¼•ç”¨è§£æä¸ç¼“å­˜æœºåˆ¶

ç³»ç»Ÿæ”¯æŒåŸºäº Wiki é£æ ¼çš„å¼•ç”¨è¯­æ³•ï¼Œé€šè¿‡å‘½åç©ºé—´åŒºåˆ†åº“å†…ä¸è·¨åº“å¼•ç”¨ã€‚ç”±äºå¼•ç”¨è§£æè®¡ç®—æˆæœ¬è¾ƒé«˜ï¼Œç³»ç»Ÿé‡‡ç”¨**å†·å¯åŠ¨æ„å»º + å†…å­˜ç¼“å­˜**ç­–ç•¥ã€‚

#### 1. å¼•ç”¨æ ¼å¼

- **åº“å†…å¼•ç”¨ (`[[Key]]`)**: ä»…åœ¨å½“å‰çŸ¥è¯†åº“ä¸­æŸ¥æ‰¾ `Key`ã€‚
- **è·¨åº“å¼•ç”¨ (`[[LibraryName::Key]]`)**: åœ¨æŒ‡å®šçš„å¤–éƒ¨åº“ `LibraryName` ä¸­æŸ¥æ‰¾ `Key`ã€‚

#### 2. è§£æè§„åˆ™

- è§£æå™¨ä¼˜å…ˆè¯†åˆ«å‘½åç©ºé—´åˆ†éš”ç¬¦ `::`ã€‚
- è‹¥å­˜åœ¨å‘½åç©ºé—´ï¼Œåˆ™åœ¨å¯¹åº”åç§°çš„çŸ¥è¯†åº“ä¸­æ£€ç´¢ Keyã€‚
- è‹¥æ— å‘½åç©ºé—´ï¼Œåˆ™ä¸¥æ ¼é™åˆ¶åœ¨å½“å‰çŸ¥è¯†åº“èŒƒå›´å†…æ£€ç´¢ã€‚
- ä»»æ„ç¯èŠ‚æŸ¥æ‰¾å¤±è´¥ï¼ˆåº“ä¸å­˜åœ¨æˆ– Key ä¸å­˜åœ¨ï¼‰å‡è§†ä¸ºæ–­é“¾ã€‚

#### 3. ç¼“å­˜ç­–ç•¥

1.  **å†·å¯åŠ¨å¼‚æ­¥æ„å»º**:
    - çŸ¥è¯†åº“åŠ è½½å®Œæˆåï¼Œå¯åŠ¨åå°å¼‚æ­¥ä»»åŠ¡ã€‚
    - éå†æ‰€æœ‰ CAIU çš„ `content` å­—æ®µï¼Œæ­£åˆ™æå– `[[...]]` å¼•ç”¨ã€‚
    - æ„å»ºåŒå‘å¼•ç”¨å›¾ (`refs` / `ref_by`) å¹¶å­˜å…¥ `RuntimeIndex`ã€‚

2.  **å†…å­˜ç¼“å­˜ç»´æŠ¤**:
    - è¿è¡Œæ—¶ç›´æ¥ä»å†…å­˜è¯»å–å¼•ç”¨å…³ç³»ã€‚
    - å½“ CAIU å†…å®¹æ›´æ–°æ—¶ï¼Œå¢é‡æ›´æ–°ç›¸å…³çš„å¼•ç”¨è¾¹ã€‚
    - ä¸å°†å¼•ç”¨å…³ç³»åºåˆ—åŒ–åˆ°ç£ç›˜ï¼Œé¿å…æ•°æ®å†—ä½™å’Œä¸€è‡´æ€§é—®é¢˜ã€‚

### 3.3 å‘é‡å­˜å‚¨ä¸æ£€ç´¢ (Vectorization)

ä¸ºäº†åœ¨æœ¬åœ°é«˜æ•ˆè¿è¡Œè¯­ä¹‰æ£€ç´¢ï¼Œç³»ç»Ÿé‡‡ç”¨è½»é‡çº§çš„åµŒå…¥å¼å‘é‡ç´¢å¼•æ–¹æ¡ˆã€‚

#### 1. å­˜å‚¨åˆ†ç¦»

- **å…ƒæ•°æ®ä¸æ–‡æœ¬**: å­˜å‚¨åœ¨ `kb_xxx.json` ä¸­ã€‚
- **å‘é‡æ•°æ®**: å­˜å‚¨åœ¨åŒåçš„ `kb_xxx.vec` äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ ¼å¼ä¸ºï¼š
  ```
  [HEADER: 4 bytes magic + 4 bytes version + 4 bytes dimension + 4 bytes count]
  [VECTORS: count * dimension * 4 bytes (f32)]
  [ID_MAP: count * 16 bytes (UUID)]
  ```
- **HNSW ç´¢å¼•**: å­˜å‚¨åœ¨ `kb_xxx.hnsw` æ–‡ä»¶ä¸­ï¼ˆå¯é€‰ç”¨ `usearch` æˆ– `hnswlib` çš„åºåˆ—åŒ–æ ¼å¼ï¼‰ã€‚

#### 2. å‘é‡åŒ–æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Rust
    participant LLM_API

    User->>Frontend: è§¦å‘"å‘é‡åŒ–"
    Frontend->>Rust: kb_vectorize(kb_id)
    loop æ¯ä¸ªæœªå‘é‡åŒ–çš„ CAIU
        Rust->>LLM_API: embedding(content)
        LLM_API-->>Rust: Vec<f32>
        Rust->>Rust: å†™å…¥ .vec æ–‡ä»¶
    end
    Rust->>Rust: æ„å»º HNSW ç´¢å¼•
    Rust->>Rust: ä¿å­˜ .hnsw æ–‡ä»¶
    Rust-->>Frontend: å®Œæˆ
```

#### 3. å¢é‡æ›´æ–°ç­–ç•¥

- **æ–°å¢ CAIU**: è®¡ç®— embeddingï¼Œè¿½åŠ åˆ° `.vec` æ–‡ä»¶ï¼Œå¢é‡æ’å…¥ HNSW ç´¢å¼•ã€‚
- **ä¿®æ”¹ CAIU**: é‡æ–°è®¡ç®— embeddingï¼Œæ›´æ–° `.vec` æ–‡ä»¶å¯¹åº”ä½ç½®ï¼ŒHNSW ç´¢å¼•ä¸­åˆ é™¤æ—§å‘é‡å¹¶æ’å…¥æ–°å‘é‡ã€‚
- **åˆ é™¤ CAIU**: æ ‡è®°ä¸ºå·²åˆ é™¤ï¼ˆæ‡’æƒ°åˆ é™¤ï¼‰ï¼Œå®šæœŸæ‰§è¡Œå‹ç¼©é‡å»ºã€‚

#### 4. æ£€ç´¢èåˆç­–ç•¥

æœç´¢æ—¶åŒæ—¶æ‰§è¡Œè¯­ä¹‰æ£€ç´¢å’Œå…³é”®è¯æ£€ç´¢ï¼Œé‡‡ç”¨ RF (Reciprocal Rank Fusion) èåˆç®—æ³•ï¼š

```
score = Î£ 1 / (k + rank_i)
```

å…¶ä¸­ `k` é€šå¸¸å– 60ï¼Œ`rank_i` ä¸ºè¯¥ç»“æœåœ¨ç¬¬ i ä¸ªæ£€ç´¢æ–¹æ³•ä¸­çš„æ’åã€‚

---

## å››ã€æ–‡ä»¶å­˜å‚¨ç»“æ„ç¤ºä¾‹

```text
e:/rc20/allinweb/all-in-one-tools/knowledge/
â”œâ”€â”€ workspace.json              # å…¥å£æ–‡ä»¶
â””â”€â”€ bases/                      # çŸ¥è¯†åº“æ•°æ®ç›®å½•
    â”œâ”€â”€ kb_personal.json        # çŸ¥è¯†åº“å…ƒæ•°æ®ä¸æ–‡æœ¬
    â”œâ”€â”€ kb_personal.vec         # å‘é‡æ•°æ®
    â”œâ”€â”€ kb_personal.hnsw        # HNSW ç´¢å¼•
    â”œâ”€â”€ kb_world_setting.json
    â”œâ”€â”€ kb_world_setting.vec
    â”œâ”€â”€ kb_world_setting.hnsw
    â”œâ”€â”€ kb_coding.json
    â”œâ”€â”€ kb_coding.vec
    â””â”€â”€ kb_coding.hnsw
```

> **æ³¨æ„**: å¤šæ¨¡æ€èµ„äº§ï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ç­‰ï¼‰ç»Ÿä¸€å­˜å‚¨åœ¨å…¨å±€ `AssetManager` ç®¡ç†çš„ç›®å½•ä¸­ï¼Œé€šè¿‡ `appdata://` åè®®å¼•ç”¨ï¼Œä¸åœ¨çŸ¥è¯†åº“ç›®å½•ä¸‹ç‹¬ç«‹å­˜å‚¨ã€‚

---

## äº”ã€Chat é›†æˆæ–¹æ¡ˆ (Pipeline Integration)

åŸºäº LLM Chat çš„ **Unified Pipeline Architecture**ï¼ŒçŸ¥è¯†å¼•æ“å°†ä½œä¸ºæ ‡å‡†çš„ **ContextProcessor** æ¥å…¥ã€‚

### 5.1 å¤„ç†å™¨å®šä¹‰

æ–°å¢ `knowledge-retriever` å¤„ç†å™¨ï¼Œæ’å…¥åˆ°ä¸Šä¸‹æ–‡ç®¡é“çš„ä¸­æ®µã€‚

| å±æ€§         | å€¼                    | è¯´æ˜                                                    |
| :----------- | :-------------------- | :------------------------------------------------------ |
| **ID**       | `knowledge-retriever` | å”¯ä¸€æ ‡è¯†ç¬¦                                              |
| **Priority** | **350** (é»˜è®¤å€¼)      | ä½äº `transcription` ä¹‹åï¼Œ`injection` ä¹‹å‰ï¼Œå¯é…ç½®è°ƒæ•´ |
| **Role**     | RAG æ£€ç´¢ä¸æ³¨å…¥        | åˆ†æå½“å‰ä¸Šä¸‹æ–‡ï¼Œæ£€ç´¢çŸ¥è¯†ï¼Œæ³¨å…¥ System Message           |

**æ‰§è¡Œé€»è¾‘**:

1.  **Input**: æ¥æ”¶ `PipelineContext`ï¼Œè·å–æœ€è¿‘çš„ç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…æ‹¬å·²è½¬å†™çš„éŸ³é¢‘/å›¾ç‰‡æ–‡æœ¬ï¼‰ã€‚
2.  **Search**: è°ƒç”¨ Rust åç«¯ `kb_search` æ¥å£ï¼Œæ‰§è¡Œè¯­ä¹‰æ£€ç´¢ + å…³é”®è¯åŒ¹é…ã€‚
3.  **Inject**: å°†å‘½ä¸­çš„ CAIU (åŸå­ä¿¡æ¯å•å…ƒ) æ ¼å¼åŒ–ä¸º System Messageï¼Œæ’å…¥åˆ° `context.messages` å¤´éƒ¨ã€‚
    - _ä¼˜åŠ¿_: ç”±äºåœ¨ `token-limiter` ä¹‹å‰æ‰§è¡Œï¼ŒToken é™åˆ¶å™¨ä¼šè‡ªåŠ¨è®¡ç®—çŸ¥è¯†çš„å¼€é”€ï¼Œå¹¶ä¼˜å…ˆæˆªæ–­è¾ƒæ—©çš„ä¼šè¯å†å²ï¼Œç¡®ä¿çŸ¥è¯†ä¸Šä¸‹æ–‡ä¸è¢«ä¸¢å¼ƒã€‚

### 5.2 å¤šæ¨¡æ€èµ„äº§æ³¨å…¥ (Structured Injection)

LLM Chat çš„ `asset-resolver` å¤„ç†å™¨ä¸è§£ææ¶ˆæ¯æ–‡æœ¬ä¸­çš„åè®®ï¼Œå®ƒå¤„ç†çš„æ˜¯ `ChatMessageNode.attachments` å­—æ®µä¸­çš„ç»“æ„åŒ–é™„ä»¶åˆ—è¡¨ã€‚å› æ­¤ï¼ŒçŸ¥è¯†åº“ä¸­çš„å¤šæ¨¡æ€å†…å®¹å¿…é¡»é€šè¿‡ç»“æ„åŒ–æ–¹å¼æ³¨å…¥ã€‚

**å¤„ç†æµç¨‹**:

1.  **æ£€ç´¢ç»“æœç»“æ„åŒ–**: `SearchResult.caiu.assets` å­—æ®µåŒ…å«å®Œæ•´çš„ `AssetRef` åˆ—è¡¨ã€‚

2.  **æ„å»ºæ³¨å…¥æ¶ˆæ¯**: `knowledge-retriever` å¤„ç†å™¨åœ¨æ„å»ºæ³¨å…¥æ¶ˆæ¯æ—¶ï¼Œå°† `AssetRef` è½¬æ¢ä¸ºæ ‡å‡†çš„ `ChatMessageNode` é™„ä»¶æ ¼å¼ï¼š

    ```typescript
    const injectedMessage: ChatMessageNode = {
      role: "system",
      content: caiu.content, // çº¯æ–‡æœ¬/Markdown å†…å®¹
      attachments: caiu.assets.map((assetRef) => ({
        id: assetRef.id,
        name: assetRef.name,
        mimeType: assetRef.mime_type,
        // ... å…¶ä»– Asset å…ƒæ•°æ®
      })),
    };
    ```

3.  **åç»­å¤„ç†**:
    - å¦‚æœæ¨¡å‹æ”¯æŒè§†è§‰ï¼Œ`asset-resolver` ä¼šå°† `attachments` ä¸­çš„å›¾ç‰‡è½¬æ¢ä¸º Base64 æˆ– URLã€‚
    - å¦‚æœæ¨¡å‹ä¸æ”¯æŒè§†è§‰ï¼Œ`transcription-processor` ä¼šå…ˆå¯¹å›¾ç‰‡è¿›è¡Œ OCR è½¬å†™ï¼Œå°†æ–‡æœ¬è¿½åŠ åˆ° `content` ä¸­ã€‚

### 5.3 ç•Œé¢äº¤äº’

- **Agent é…ç½®**: åœ¨ Agent ç¼–è¾‘å™¨çš„ "Pipeline Config" éƒ¨åˆ†ï¼Œå¯ä»¥å¯ç”¨/ç¦ç”¨ `knowledge-retriever`ï¼Œå¹¶ç»‘å®šç‰¹å®šçš„çŸ¥è¯†åº“ï¼ˆå¦‚ "åªæœç´¢ Project A çŸ¥è¯†åº“"ï¼‰ã€‚
- **æ˜¾å¼å¼•ç”¨**: åˆ©ç”¨ **Anchor System**ï¼Œæ³¨å†Œ `knowledge_base` é”šç‚¹ã€‚è¯¥é”šç‚¹ç±»ä¼¼äº `chat_history`ï¼Œä½œä¸ºçŸ¥è¯†æ£€ç´¢ç»“æœçš„æ’å…¥ç‚¹ä½ï¼Œå…è®¸ç”¨æˆ·åœ¨ Prompt Template ä¸­ç²¾ç¡®æ§åˆ¶çŸ¥è¯†å†…å®¹çš„æ’å…¥ä½ç½®ã€‚

---

## å…­ã€çŸ¥è¯†åº“ç®¡ç†ç•Œé¢ (Knowledge Manager)

çŸ¥è¯†åº“çš„ç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰ä½œä¸ºç‹¬ç«‹çš„ **Tool Window** å­˜åœ¨ï¼Œä¸è€¦åˆåœ¨ Chat ç•Œé¢ä¸­ã€‚

- **ç‹¬ç«‹åº”ç”¨**: `src/tools/knowledge-base/` (æ–°å»º)
- **æ ¸å¿ƒåŠŸèƒ½**:
  - **å¡ç‰‡ç¼–è¾‘å™¨**: Markdown ç¼–è¾‘ï¼Œæ”¯æŒæ‹–æ‹½ä¸Šä¼ ï¼ˆè°ƒç”¨ `useAssetManager`ï¼‰ã€‚
  - **å›¾è°±è§†å›¾**: å±•ç¤ºçŸ¥è¯†å…³è”ï¼ˆåŸºäºå¼•ç”¨å…³ç³» `refs` / `ref_by`ï¼‰ã€‚
  - **ç´¢å¼•ç®¡ç†**: æ‰‹åŠ¨è§¦å‘å‘é‡åŒ–æˆ–é‡å»ºç´¢å¼•ã€‚
  - **å¯¼å…¥/å¯¼å‡º**: æ”¯æŒæ‰¹é‡å¯¼å…¥ Markdown æ–‡ä»¶ï¼Œå¯¼å‡ºä¸ºæ ‡å‡†æ ¼å¼ã€‚

---

## ä¸ƒã€Rust æ¨¡å—æ¶æ„ (Backend Architecture)

åœ¨ `src-tauri/src/` ä¸‹æ–°å¢ `knowledge` æ¨¡å—ï¼Œä¿æŒ `lib.rs` æ•´æ´ã€‚

```text
src-tauri/src/knowledge/
â”œâ”€â”€ mod.rs              # æ¨¡å—å…¥å£ä¸ API æ³¨å†Œ
â”œâ”€â”€ core.rs             # æ ¸å¿ƒç»“æ„ä½“ (Workspace, KnowledgeBase, Caiu)
â”œâ”€â”€ index/              # ç´¢å¼•ç›¸å…³
â”‚   â”œâ”€â”€ vector.rs       # å‘é‡å­˜å‚¨ä¸æ£€ç´¢ (HNSW)
â”‚   â”œâ”€â”€ reference.rs    # å¼•ç”¨å…³ç³»å›¾æ„å»ºä¸ç¼“å­˜
â”‚   â””â”€â”€ text.rs         # å…¨æ–‡æ£€ç´¢ (Tantivy æˆ–ç®€å•å€’æ’)
â”œâ”€â”€ io.rs               # æ–‡ä»¶è¯»å†™ä¸æµå¼è§£æ
â””â”€â”€ service.rs          # ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚ (ä¾› Command è°ƒç”¨)
```

### 7.1 æ ¸å¿ƒ Command å®šä¹‰

```rust
// æ³¨å†Œåˆ° lib.rs çš„å‘½ä»¤åˆ—è¡¨
#[tauri::command]
fn kb_create_workspace(config: WorkspaceConfig) -> Result<Uuid, String>;

#[tauri::command]
fn kb_list_bases() -> Result<Vec<KnowledgeBaseIndex>, String>;

#[tauri::command]
fn kb_search(query: String, filters: SearchFilters) -> Result<Vec<SearchResult>, String>;

#[tauri::command]
fn kb_add_entry(kb_id: Uuid, content: CaiuInput) -> Result<Caiu, String>;

#[tauri::command]
fn kb_update_entry(kb_id: Uuid, caiu_id: Uuid, content: CaiuInput) -> Result<Caiu, String>;

#[tauri::command]
fn kb_delete_entry(kb_id: Uuid, caiu_id: Uuid) -> Result<(), String>;

#[tauri::command]
fn kb_vectorize(kb_id: Uuid) -> Result<(), String>;

#[tauri::command]
fn kb_get_references(kb_id: Uuid, caiu_id: Uuid) -> Result<ReferenceInfo, String>;
```
