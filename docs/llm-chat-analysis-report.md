# LLM Chat æ¨¡å—ç°çŠ¶åˆ†ææŠ¥å‘Š

## 1. æ¦‚è¿°

LLM Chat æ¨¡å—æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡ã€æ¶æ„æ¸…æ™°çš„å¯¹è¯ç•Œé¢ã€‚å®ƒé‡‡ç”¨äº† Vue 3 (Composition API)ã€Pinia å’Œ TypeScript æ„å»ºã€‚å…¶æ ¸å¿ƒè®¾è®¡æ€æƒ³æ˜¯**çŠ¶æ€é©±åŠ¨**ä¸**å…³æ³¨ç‚¹åˆ†ç¦»**ï¼Œå°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€æ•°æ®ç®¡ç†ä¸UIæ¸²æŸ“æ¸…æ™°åœ°è§£è€¦ã€‚

è¯¥æ¨¡å—ä¸ä»…å®ç°äº†æ ‡å‡†çš„èŠå¤©åŠŸèƒ½ï¼Œè¿˜åŒ…å«äº†**å¯¹è¯åˆ†æ”¯ï¼ˆæ ‘å½¢å†å²ï¼‰**ã€**å¯åˆ†ç¦»ç»„ä»¶ï¼ˆç‹¬ç«‹çª—å£ï¼‰**ã€**æ™ºèƒ½ä½“ï¼ˆè§’è‰²é¢„è®¾ï¼‰** å’Œ **æ€ç»´é“¾å±•ç¤º** ç­‰å¤šé¡¹é«˜çº§ç‰¹æ€§ï¼Œæ•´ä½“æ¶æ„å…·æœ‰å‡ºè‰²çš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## 2. æ ¸å¿ƒæ¶æ„åˆ†æ

æ¨¡å—çš„æ¶æ„å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªä¸»è¦å±‚æ¬¡ï¼š**è§†å›¾å±‚ (Components)**ã€**çŠ¶æ€ç®¡ç†å±‚ (Pinia Stores)** å’Œ **é€»è¾‘ä¸åŠŸèƒ½å±‚ (Composables)**ã€‚

### 2.1. è§†å›¾å±‚ (Components)

è§†å›¾å±‚è´Ÿè´£UIçš„å¸ƒå±€å’Œæ¸²æŸ“ï¼Œç»„ä»¶èŒè´£åˆ’åˆ†æ˜ç¡®ã€‚

- **`LlmChat.vue`**: ä½œä¸ºæ¨¡å—çš„æ ¹ç»„ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªâ€œå¸ƒå±€å®¹å™¨â€ã€‚è´Ÿè´£æ­å»ºä¸‰æ å¼ç•Œé¢ï¼ˆå·¦ä¾§è¾¹æ ã€ä¸»èŠå¤©åŒºã€å³ä¾§è¾¹æ ï¼‰ï¼Œå¹¶å¤„ç†ä¾§è¾¹æ çš„æ‹–æ‹½å’ŒæŠ˜å ã€‚å®ƒæœ¬èº«ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ˜¯é€šè¿‡äº‹ä»¶å°†ç”¨æˆ·æ“ä½œä¼ é€’ç»™çŠ¶æ€ç®¡ç†å±‚ã€‚
- **`ChatArea.vue`**: æ ¸å¿ƒèŠå¤©åŒºçš„â€œæ€»æˆâ€ç»„ä»¶ã€‚å®ƒç»„åˆäº† `MessageList` å’Œ `MessageInput`ï¼Œå¹¶åœ¨å¤´éƒ¨æ˜¾ç¤ºå½“å‰å¯¹è¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ™ºèƒ½ä½“å’Œæ¨¡å‹ï¼‰ã€‚è¯¥ç»„ä»¶æ˜¯**çª—å£åˆ†ç¦»åŠŸèƒ½**çš„å…³é”®å®ç°è€…ï¼Œèƒ½å¤Ÿé€šè¿‡ `useDetachable` composable å°†è‡ªèº«â€œæ’•ä¸‹â€åˆ°ç‹¬ç«‹çª—å£ä¸­ï¼Œå¹¶é€šè¿‡ä»£ç†ä¸ä¸»çª—å£é€šä¿¡ã€‚
- **`MessageList.vue`**: çº¯ç²¹çš„â€œæ¶ˆæ¯æ¸²æŸ“å™¨â€ã€‚è´Ÿè´£å°†æ¶ˆæ¯æ•°ç»„æ¸²æŸ“ä¸ºå¯¹è¯åˆ—è¡¨ã€‚å®ƒæ”¯æŒå±•ç¤ºå¤šç§æ¶ˆæ¯çŠ¶æ€ï¼ˆç”Ÿæˆä¸­ã€é”™è¯¯ï¼‰ã€å…ƒæ•°æ®ï¼ˆTokenç”¨é‡ï¼‰ä»¥åŠä¸€ä¸ªç‰¹è‰²åŠŸèƒ½â€”â€”å¯æŠ˜å çš„**æ€ç»´é“¾(Reasoning)å†…å®¹**ã€‚
- **ä¾§è¾¹æ ç»„ä»¶**:
  - `LeftSidebar.vue`: ç®¡ç†å½“å‰ä¼šè¯çš„æ™ºèƒ½ä½“åˆ‡æ¢å’Œå‚æ•°è¦†ç›–ã€‚
  - `SessionsSidebar.vue`: ç®¡ç†æ‰€æœ‰å†å²ä¼šè¯çš„åˆ—è¡¨ï¼Œæ”¯æŒåˆ›å»ºã€åˆ‡æ¢å’Œåˆ é™¤ä¼šè¯ã€‚

### 2.2. çŠ¶æ€ç®¡ç†å±‚ (Pinia Stores)

è¿™æ˜¯æ•´ä¸ªæ¨¡å—çš„â€œå¤§è„‘â€ï¼Œè´Ÿè´£æ‰€æœ‰çš„æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ã€‚

- **`agentStore.ts` (`useAgentStore`)**:
  - **æ ¸å¿ƒæ¦‚å¿µ**: å®šä¹‰äº†â€œæ™ºèƒ½ä½“â€(Agent)â€”â€”ä¸€ä¸ªå¯å¤ç”¨çš„å¯¹è¯è§’è‰²é¢„è®¾ã€‚
  - **èŒè´£**: ç®¡ç†æ™ºèƒ½ä½“çš„å¢åˆ æ”¹æŸ¥ã€‚æ¯ä¸ªæ™ºèƒ½ä½“å°è£…äº†æ¨¡å‹IDã€ç³»ç»Ÿæç¤ºè¯ã€é»˜è®¤å‚æ•°ç­‰é…ç½®ã€‚å®ƒå°†è§’è‰²é…ç½®ä¸åº•å±‚çš„APIå¯†é’¥è§£è€¦ï¼Œæé«˜äº†çµæ´»æ€§å’Œå¤ç”¨æ€§ã€‚
  - **å…³é”®Action**: `getAgentConfig`ï¼Œç”¨äºåˆå¹¶æ™ºèƒ½ä½“çš„åŸºç¡€é…ç½®å’Œä¼šè¯çš„ä¸´æ—¶è¦†ç›–å‚æ•°ï¼Œç”Ÿæˆæœ€ç»ˆçš„APIè¯·æ±‚é…ç½®ã€‚

- **`store.ts` (`useLlmChatStore`)**:
  - **æ ¸å¿ƒæ¦‚å¿µ**: ç®¡ç†å…·ä½“çš„â€œå¯¹è¯â€(Session)å’Œæ¶ˆæ¯å†å²ã€‚
  - **èŒè´£**:
    1.  **ä¼šè¯ç®¡ç†**: ç»´æŠ¤æ‰€æœ‰ `ChatSession` çš„åˆ—è¡¨ï¼Œå¤„ç†ä¼šè¯çš„åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤å’Œæ›´æ–°ã€‚
    2.  **æ¶ˆæ¯ç®¡ç†**: å®ç°äº†å®Œæ•´çš„æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å‘é€ã€æµå¼æ¥æ”¶ã€ä¸­æ­¢ã€é‡æ–°ç”Ÿæˆå’Œè½¯åˆ é™¤ã€‚
    3.  **APIååŒ**: `sendMessage` actionæ˜¯æ¨¡å—çš„å¿ƒè„ï¼Œå®ƒååŒ `agentStore` å’Œ `useLlmRequest` æ¥å®Œæˆä¸€æ¬¡å®Œæ•´çš„LLM APIè°ƒç”¨ã€‚
  - **æ ¸å¿ƒäº®ç‚¹ï¼šæ ‘å½¢å†å²ç»“æ„**:
    - æ¶ˆæ¯ä¸ä»¥çº¿æ€§æ•°ç»„å­˜å‚¨ï¼Œè€Œæ˜¯ä»¥ `ChatMessageNode` ç»„æˆçš„**æ ‘çŠ¶ç»“æ„**ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰çˆ¶å­å…³ç³»ã€‚
    - è¿™å¤©ç„¶åœ°æ”¯æŒäº†**å¯¹è¯åˆ†æ”¯**ã€‚ä¾‹å¦‚ï¼Œâ€œé‡æ–°ç”Ÿæˆâ€æ“ä½œä¼šä»çˆ¶èŠ‚ç‚¹åˆ›å»ºæ–°çš„åˆ†æ”¯ï¼Œè€Œä¸æ˜¯è¦†ç›–å†å²ã€‚
    - `currentMessageChain` getter é€šè¿‡ä»å½“å‰æ´»åŠ¨å¶èŠ‚ç‚¹å‘ä¸Šå›æº¯ï¼ŒåŠ¨æ€ç”Ÿæˆä¸€ä¸ªçº¿æ€§çš„æ¶ˆæ¯é“¾ä¾›UIä½¿ç”¨ï¼Œè®¾è®¡éå¸¸å·§å¦™ã€‚

### 2.3. é€»è¾‘ä¸åŠŸèƒ½å±‚ (Composables)

é€šè¿‡ Composables å°è£…å¯å¤ç”¨çš„åŠŸèƒ½é€»è¾‘ï¼Œè¿›ä¸€æ­¥æå‡äº†ä»£ç çš„æ¨¡å—åŒ–ç¨‹åº¦ã€‚

- **`useLlmRequest.ts`**: (ä½äº `@/composables`) å°è£…äº†åº•å±‚çš„LLM APIè¯·æ±‚é€»è¾‘ï¼Œå¤„ç†æµå¼å“åº”å’Œé”™è¯¯ã€‚
- **`useDetachable.ts` / `useDetachedManager.ts`**: (ä½äº `@/composables`) æä¾›äº†ç»„ä»¶/çª—å£åˆ†ç¦»çš„æ ¸å¿ƒèƒ½åŠ›ã€‚
- **`useDetachedChatArea.ts`**: ä¸“é—¨ä¸º `ChatArea` ç»„ä»¶å®šåˆ¶çš„ composableï¼Œä½œä¸ºå…¶åœ¨åˆ†ç¦»çŠ¶æ€ä¸‹çš„**æ•°æ®å’Œäº‹ä»¶ä»£ç†**ï¼Œå®ç°äº†ä¸ä¸»çª—å£ Pinia store çš„è·¨çª—å£çŠ¶æ€åŒæ­¥ã€‚

## 3. ç‰¹æ€§äº®ç‚¹æ€»ç»“

- **æ ‘å½¢å¯¹è¯å†å²**: å®ç°äº†éç ´åæ€§çš„å¯¹è¯ç¼–è¾‘å’Œåˆ†æ”¯æ¢ç´¢ï¼Œæ˜¯æ•´ä¸ªæ¨¡å—æœ€æ ¸å¿ƒçš„åˆ›æ–°ç‚¹ã€‚
- **ç»„ä»¶å¯åˆ†ç¦»**: `ChatArea` å¯ä»¥è¢«æ‹–æ‹½åˆ°ç‹¬ç«‹çª—å£ä¸­ï¼Œæä¾›äº†ç±»ä¼¼IDEçš„å¤šçª—å£ä½“éªŒï¼Œæå¤§åœ°æå‡äº†çµæ´»æ€§ã€‚
- **æ™ºèƒ½ä½“ç³»ç»Ÿ**: å°†è§’è‰²é…ç½®ä¸ä¼šè¯åˆ†ç¦»ï¼Œé¼“åŠ±ç”¨æˆ·åˆ›å»ºå’Œå¤ç”¨ä¸åŒçš„å¯¹è¯é¢„è®¾ï¼Œæå‡äº†æ•ˆç‡ã€‚
- **çŠ¶æ€é©±åŠ¨æ¶æ„**: ä¸¥æ ¼éµå¾ªå•å‘æ•°æ®æµï¼Œé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤ã€‚
- **æ€ç»´é“¾å±•ç¤º**: æ”¯æŒåœ¨UIä¸Šç›´æ¥æŸ¥çœ‹æ¨¡å‹çš„æ¨ç†è¿‡ç¨‹ï¼Œå¯¹é«˜çº§ç”¨æˆ·å’Œå¼€å‘è€…éå¸¸å‹å¥½ã€‚

## 4. æ¶æ„è¿œæ™¯ä¸è“å›¾

æ ¹æ®é¡¹ç›®çš„è®¾è®¡æ–‡æ¡£ (`ComfyTavern/DesignDocs`) å’Œå‚è€ƒèµ„æ–™ (`SillyTavern`, `Cherry Studio`)ï¼ŒLLM Chat æ¨¡å—çš„æœ€ç»ˆç›®æ ‡æ˜¯æˆä¸ºä¸€ä¸ªé«˜åº¦å¯æ§ã€å¯ç¼–æ’çš„çŸ¥è¯†æ„å»ºå·¥å…·ï¼Œè€Œéç®€å•çš„çº¿æ€§èŠå¤©è®°å½•å™¨ã€‚å…¶æ ¸å¿ƒè“å›¾åŒ…æ‹¬ï¼š

- **å®Œå…¨ä½“çš„æ ‘çŠ¶å†å²ç¼–è¾‘ (`ComfyTavern` è®¾è®¡)**:
  - æä¾›ä¸€ä¸ªå¯è§†åŒ–çš„å›¾çŠ¶/æ ‘çŠ¶ç¼–è¾‘å™¨ï¼ˆâ€œä¸Šå¸è§†è§’â€ï¼‰ã€‚
  - æ”¯æŒå¯¹æ¶ˆæ¯èŠ‚ç‚¹è¿›è¡Œé«˜çº§æ“ä½œï¼Œå¦‚**å‰ªæ (Prune)**ã€**å«æ¥ (Graft)**ã€**å¯ç”¨/ç¦ç”¨ (Enable/Disable)** å’Œ **åˆ‡æ¢ä¸»å¹² (Switch Trunk)**ã€‚
  - å°†å¯¹è¯ä»â€œæ¶ˆè€—å“â€è½¬å˜ä¸ºå¯é‡æ„ã€å¯ç²¾ç‚¼çš„â€œçŸ¥è¯†èµ„äº§â€ã€‚

- **SillyTavern çº§çš„é«˜çº§ä¸Šä¸‹æ–‡ç®¡ç†**:
  - å¼•å…¥ç±»ä¼¼â€œä¸–ç•Œä¹¦â€çš„åŠ¨æ€ä¸Šä¸‹æ–‡æ³¨å…¥æœºåˆ¶ï¼Œæ ¹æ®å…³é”®è¯ã€è§„åˆ™ã€å®šæ—¶æ•ˆæœç­‰åŠ¨æ€ä¿®æ”¹Promptã€‚
  - å®ç°ç±»ä¼¼â€œè§’è‰²å¡â€çš„æ·±åº¦è§’è‰²å®šåˆ¶ï¼ŒåŒ…æ‹¬è§’è‰²ä¸“å±çš„ç³»ç»Ÿæç¤ºè¦†ç›–å’Œè¡Œä¸ºæŒ‡ä»¤ã€‚

- **Cherry Studio çº§çš„ä¸°å¯Œäº¤äº’ä½“éªŒ**:
  - æ”¯æŒå¤šæ¨¡æ€è¾“å…¥ï¼ˆæ–‡ä»¶ã€å›¾ç‰‡ç²˜è´´ï¼‰ã€‚
  - æä¾›å¼ºå¤§çš„æ¶ˆæ¯æ“ä½œï¼ˆå¤šé€‰ã€ç¼–è¾‘ã€é‡å‘ã€åˆ†æ”¯åˆ›å»ºï¼‰ã€‚
  - å®ç°å¿«æ·å‘½ä»¤ã€æ¨¡å‹æåŠ (`@`) ç­‰é«˜æ•ˆäº¤äº’æ–¹å¼ã€‚

## 5. ç°çŠ¶ä¸è¿œæ™¯çš„å¯¹æ¯”åˆ†æ

ç»¼åˆæ¥çœ‹ï¼Œå½“å‰æ¨¡å—çš„å¼€å‘é˜¶æ®µå¯ä»¥æ€»ç»“ä¸º **â€œæ•°æ®å±‚å…ˆè¡Œï¼ŒåŠŸèƒ½å±‚éªŒè¯ï¼ŒUIå±‚æ»åâ€**ã€‚

- **æ•°æ®å±‚ï¼šé«˜åº¦å¯¹é½ (â˜…â˜…â˜…â˜…â˜…)**
  - æ ¸å¿ƒæ•°æ®ç»“æ„ `ChatMessageNode` å’Œ `ChatSession` (å®šä¹‰äº `types.ts`) ä¸æœ€ç»ˆè®¾è®¡è“å›¾ (`chat-history-branching-design.md`) ä¸­çš„å®šä¹‰**å‡ ä¹å®Œå…¨ä¸€è‡´**ã€‚
  - åŒ…å«äº† `parentId`, `childrenIds`, `isEnabled` ç­‰å…³é”®å­—æ®µï¼Œä¸ºæ‰€æœ‰é«˜çº§æ ‘çŠ¶ç¼–è¾‘åŠŸèƒ½**é¢„ç•™äº†åšå®çš„åŸºç¡€**ã€‚è¿™æ˜¯å½“å‰å®ç°æœ€å¤§çš„äº®ç‚¹å’Œä¼˜åŠ¿ã€‚

- **é€»è¾‘å±‚ï¼šåˆæ­¥å®ç° (â˜…â˜…â˜…â˜†â˜†)**
  - `store.ts` å·²ç»å®ç°äº†åŸºäºæ ‘çŠ¶ç»“æ„çš„åŸºç¡€é€»è¾‘ï¼Œå¦‚é€šè¿‡ `activeLeafId` åˆ‡æ¢åˆ†æ”¯ï¼Œä»¥åŠé€šè¿‡ `isEnabled` æ ‡å¿—è¿›è¡Œéç ´åæ€§æ“ä½œï¼ˆç”¨äºâ€œé‡æ–°ç”Ÿæˆâ€ï¼‰ã€‚
  - è¿™å¯ä»¥è¢«è§†ä¸ºæœ€ç»ˆè®¾è®¡æ–¹æ¡ˆçš„ä¸€ä¸ª**æœ€å°å¯è¡Œäº§å“ (MVP)**ï¼ŒéªŒè¯äº†æ ¸å¿ƒæ•°æ®æµçš„å¯è¡Œæ€§ã€‚
  - ç„¶è€Œï¼Œè·ç¦»è®¾è®¡æ–‡æ¡£ä¸­å®šä¹‰çš„å‰ªæã€å«æ¥ç­‰é«˜çº§æ“ä½œï¼Œä»¥åŠ SillyTavern çº§çš„åŠ¨æ€ä¸Šä¸‹æ–‡æ³¨å…¥é€»è¾‘ï¼Œè¿˜æœ‰å¾ˆå¤§å·®è·ã€‚

- **UI ä¸äº¤äº’å±‚ï¼šå·®è·å·¨å¤§ (â˜…â˜†â˜†â˜†â˜†)**
  - è¿™æ˜¯å½“å‰æœ€è–„å¼±çš„ç¯èŠ‚ã€‚ç”¨æˆ·å®Œå…¨æ— æ³•æ„ŸçŸ¥åˆ°åº•å±‚çš„æ ‘çŠ¶ç»“æ„ã€‚
  - **ç¼ºå¤±å¯è§†åŒ–ç¼–è¾‘å™¨**ï¼šæ²¡æœ‰å›¾çŠ¶è§†å›¾æ¥å±•ç¤ºå’Œæ“ä½œå¯¹è¯åˆ†æ”¯ã€‚
  - **äº¤äº’åŠŸèƒ½éå¸¸åŸºç¡€**ï¼šä»…å®ç°äº†åˆ é™¤ã€é‡ç”Ÿæˆç­‰åŸºæœ¬æ“ä½œï¼Œè¿œæœªè¾¾åˆ° Cherry Studio çš„ä¸°å¯Œåº¦ã€‚
  - **ç¼ºå°‘é«˜çº§é…ç½®èƒ½åŠ›**ï¼šç”¨æˆ·æ— æ³•åƒåœ¨ SillyTavern ä¸­é‚£æ ·ç²¾ç»†åœ°é…ç½®è§’è‰²ã€ä¸–ç•Œä¿¡æ¯å’Œæç¤ºæ¨¡æ¿ã€‚

## 6. è¿­ä»£å¼€å‘è·¯çº¿å›¾å»ºè®®

åŸºäºä»¥ä¸Šåˆ†æï¼Œå»ºè®®åç»­å¼€å‘éµå¾ª **â€œç”±å†…è€Œå¤–ï¼Œå…ˆåŠŸèƒ½åäº¤äº’â€** çš„åŸåˆ™ï¼Œå……åˆ†åˆ©ç”¨å·²æœ‰çš„æ•°æ®å±‚ä¼˜åŠ¿ï¼Œé€æ­¥è¡¥é½åŠŸèƒ½å’ŒUIçš„çŸ­æ¿ã€‚

- **é˜¶æ®µä¸€ï¼šæ ¸å¿ƒä½“éªŒè¡¥å®Œ (åŸºç¡€)**
    1.  **å®ç°æ¶ˆæ¯ Markdown æ¸²æŸ“ (æŠ€æœ¯é€‰å‹: `vue-renderer-markdown`)**:
        -   **ç›®æ ‡**: å¼•å…¥ `vue-renderer-markdown` åº“ï¼Œå°†æ¶ˆæ¯å†…å®¹ä»çº¯æ–‡æœ¬å‡çº§ä¸ºåŠŸèƒ½å®Œæ•´çš„ Markdown æ¸²æŸ“ã€‚
        -   **æ ¸å¿ƒä»·å€¼**: å®ƒçš„æµå¼æ¸²æŸ“ã€é«˜æ€§èƒ½å’Œå¯æ‰©å±•æ€§ï¼Œæ˜¯åç»­æ‰€æœ‰ä½“éªŒä¼˜åŒ–çš„åŸºçŸ³ã€‚
    2.  **å®ç°æ¶ˆæ¯ç¼–è¾‘ä¸é‡å‘**: å…è®¸ç”¨æˆ·ç¼–è¾‘è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼Œå¹¶èƒ½è§¦å‘ä»¥æ–°å†…å®¹é‡æ–°å‘æ¨¡å‹æé—®ï¼Œä¼˜åŒ–çº é”™æµç¨‹ã€‚

- **é˜¶æ®µäºŒï¼šçº¿æ€§å¯¹è¯ä½“éªŒæ·±åº¦ä¼˜åŒ–**
    1.  **æ€§èƒ½ä¼˜åŒ– - æ— é™æ»šåŠ¨åŠ è½½**: æ”¹é€ æ¶ˆæ¯åˆ—è¡¨ï¼Œåœ¨ä¸»å¹²è§†å›¾ä¸­æ”¯æŒé•¿å¯¹è¯çš„æ€§èƒ½ä¼˜åŒ–ï¼Œè§£å†³åˆå§‹åŠ è½½æ…¢å’Œå†…å­˜å ç”¨çš„é—®é¢˜ã€‚
    2.  **æ•ˆç‡æå‡ - å¿«æ·å‘½ä»¤ä¸æåŠ**: å®ç°è¾“å…¥æ¡†çš„ `/` å¿«æ·å‘½ä»¤å’Œ `@` æ¨¡å‹æåŠåŠŸèƒ½ï¼Œä¸ºé«˜çº§ç”¨æˆ·æä¾›æ›´æµç•…çš„æ“ä½œã€‚
    3.  **åŠŸèƒ½æ‰©å±• - åŸºç¡€å¤šæ¨¡æ€è¾“å…¥**: åœ¨è¾“å…¥æ¡†åŒºåŸŸå¢åŠ æ–‡ä»¶/å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼Œè§£é”è§†è§‰å’ŒRAGèƒ½åŠ›çš„åŸºç¡€ã€‚
    4.  **ä¸Šä¸‹æ–‡ç®¡ç† - åˆ†å‰²çº¿ä¸å¤šé€‰**: åœ¨çº¿æ€§è§†å›¾ä¸­ï¼Œå®ç°â€œæ–°ä¸Šä¸‹æ–‡åˆ†å‰²çº¿â€å’Œæ¶ˆæ¯â€œå¤šé€‰â€åŠŸèƒ½ï¼Œä»¥æ›´å¥½åœ°ç®¡ç†é•¿å¯¹è¯ã€‚

- **é˜¶æ®µä¸‰ï¼šå¯è§†åŒ–æ ‘çŠ¶ç¼–è¾‘å™¨ MVP**
    1.  **å®ç°åªè¯»è§†å›¾ä¸åˆ†æ”¯åˆ‡æ¢**: å¼•å…¥å›¾è¡¨åº“ï¼ˆå¦‚ `VueFlow`ï¼‰ï¼Œå¼€å‘â€œç¼–è¾‘æ¨¡å¼â€ï¼Œå°†å¯¹è¯æ¸²æŸ“æˆ**åªè¯»**çš„æ ‘çŠ¶å›¾ã€‚å…è®¸ç”¨æˆ·åœ¨å›¾ä¸Šæˆ–é€šè¿‡èœå•**åˆ‡æ¢ä¸»å¹²** (`activeLeafId`)ã€‚
    2.  **å®ç°åŸºç¡€äº¤äº’**: åœ¨æ ‘çŠ¶å›¾ä¸­ï¼Œå…è®¸ç”¨æˆ·ç‚¹å‡»èŠ‚ç‚¹æ‰§è¡Œâ€œå¯ç”¨/ç¦ç”¨â€ (`isEnabled`) æ“ä½œï¼Œå¹¶å°†çŠ¶æ€å˜åŒ–å®æ—¶åé¦ˆåˆ°çº¿æ€§è§†å›¾ä¸­ã€‚

- **é˜¶æ®µå››ï¼šé«˜çº§ç¼–è¾‘ä¸ä¸Šä¸‹æ–‡æ³¨å…¥**
    1.  **å®ç°é«˜çº§ç¼–è¾‘**: åœ¨å¯è§†åŒ–ç¼–è¾‘å™¨ä¸­ï¼Œå®ç°æ‹–æ‹½å¼çš„**å‰ªæ (Prune)** å’Œ **å«æ¥ (Graft)** æ“ä½œï¼Œå®Œæˆå¯¹è¯çš„éçº¿æ€§é‡æ„ã€‚
    2.  **ä¸Šä¸‹æ–‡æ³¨å…¥ MVP**: å€Ÿé‰´ SillyTavern çš„â€œä¸–ç•Œä¹¦â€ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„å…³é”®è¯->å†…å®¹æ³¨å…¥åŠŸèƒ½ï¼Œå¹¶æä¾›æ’å…¥ä½ç½®é€‰é¡¹ã€‚

- **é˜¶æ®µäº”ï¼šç”Ÿæ€å®Œå–„ä¸ç»†èŠ‚æ‰“ç£¨**
    1.  **å®Œå–„ Agent ç³»ç»Ÿ**: å€Ÿé‰´ SillyTavern çš„â€œè§’è‰²å¡â€ï¼Œä¸º `ChatAgent` å¢åŠ æ›´å¤šé«˜çº§é…ç½®ï¼Œå¦‚è§’è‰²ä¸“å±çš„æç¤ºè¦†ç›–ã€è§’è‰²ç¬”è®°ç­‰ã€‚
    2.  **UI/UX ç»†èŠ‚æ‰“ç£¨**: å¢åŠ æ¶ˆæ¯åˆ†ç»„ã€æ™ºèƒ½ç²˜è´´ã€å¯é…ç½®çš„ç¦…æ¨¡å¼å¸ƒå±€ç­‰ä½“éªŒä¼˜åŒ–åŠŸèƒ½ã€‚

é€šè¿‡ä»¥ä¸Šå››ä¸ªé˜¶æ®µï¼Œå¯ä»¥å¹³ç¨³åœ°å°† LLM Chat æ¨¡å—ä»å½“å‰çš„â€œæœ‰å…¶éª¨è€Œæœªæœ‰å…¶è‚‰â€çš„çŠ¶æ€ï¼Œé€æ­¥æ„å»ºæˆä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€ä½“éªŒå‡ºè‰²çš„é«˜çº§å¯¹è¯å·¥å…·ã€‚

---

### é™„å½• - 1 ï¼š

### vue-renderer-markdown

> Vue 3 çš„é«˜é€Ÿ Markdown æ¸²æŸ“å™¨ï¼Œé’ˆå¯¹å¤§æ–‡æ¡£ã€æµå¼å†…å®¹å’Œå®æ—¶é¢„è§ˆåšäº†æ·±åº¦ä¼˜åŒ–ã€‚

## ç›®å½•

- [ç‰¹æ€§äº®ç‚¹](#ç‰¹æ€§äº®ç‚¹)
- [å®‰è£…](#å®‰è£…)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä»£ç å—æ¨¡å¼](#ä»£ç å—æ¨¡å¼)
- [TypeScript ä½¿ç”¨](#typescript-ä½¿ç”¨)
- [SSR æŒ‡å—](#ssr-æŒ‡å—)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
- [ç›¸å…³é“¾æ¥](#ç›¸å…³é“¾æ¥)
- [è®¸å¯åè®®](#è®¸å¯åè®®)

## ç‰¹æ€§äº®ç‚¹

- âš¡ **æè‡´æ€§èƒ½**ï¼šæ¸²æŸ“å’Œ DOM æ›´æ–°é’ˆå¯¹æµå¼å†…å®¹åšäº†ä¼˜åŒ–
- ğŸŒŠ **æµå¼ä¼˜å…ˆ**ï¼šæ”¯æŒä¸å®Œæ•´ Markdownã€æ¸è¿›å¼æ¸²æŸ“
- ğŸ§  **Monaco å¢é‡æ›´æ–°**ï¼šå¤§ä½“é‡ä»£ç å—ä¹Ÿèƒ½ä¿æŒä¸æ»‘äº¤äº’
- ğŸª„ **Mermaid æ¸è¿›å¼æ¸²æŸ“**ï¼šè¯­æ³•ä¸€æ—¦æ­£ç¡®ç«‹å³å±•ç¤º
- ğŸ§© **è‡ªå®šä¹‰èŠ‚ç‚¹ç»„ä»¶**ï¼šå¯æ— ç¼æ¥å…¥è‡ªæœ‰ Vue ç»„ä»¶
- ğŸ“ **å®Œæ•´ Markdown æ”¯æŒ**ï¼šè¡¨æ ¼ã€æ•°å­¦å…¬å¼ã€Emojiã€å¤é€‰æ¡†ç­‰å…¨è¦†ç›–
- ğŸ”„ **å®æ—¶æ›´æ–°**ï¼šå±€éƒ¨å˜æ›´ä¸ä¼šç ´åæ ¼å¼
- ğŸ“¦ **TypeScript ä¼˜å…ˆ**ï¼šæä¾›å®Œæ•´ç±»å‹æç¤º
- ğŸ”Œ **é›¶é…ç½®ä¸Šæ‰‹**ï¼šé»˜è®¤å³å¯ç”¨äºä»»æ„ Vue 3 é¡¹ç›®

## å®‰è£…

```bash
pnpm add vue-renderer-markdown vue
# æˆ–
npm install vue-renderer-markdown vue
# æˆ–
yarn add vue-renderer-markdown vue
```

### å¯é€‰ peer ä¾èµ–

å¦‚éœ€å¼€å¯é«˜çº§åŠŸèƒ½ï¼Œå¯æŒ‰éœ€å®‰è£…ï¼š

| ä¾èµ–             | ç‰ˆæœ¬     | ä½œç”¨                           | ç¼ºå¤±æ—¶é€€åŒ–è¡Œä¸º |
| ---------------- | -------- | ------------------------------ | -------------- |
| `mermaid`        | >=11     | Mermaid å›¾è¡¨                   | å±•ç¤ºæºä»£ç      |
| `vue-use-monaco` | >=0.0.33 | Monaco ç¼–è¾‘å™¨                  | ä»…æ˜¾ç¤ºçº¯æ–‡æœ¬   |
| `shiki`          | ^3.13.0  | MarkdownCodeBlockNode è¯­æ³•é«˜äº® | ä»…æ˜¾ç¤ºçº¯æ–‡æœ¬   |
| `vue-i18n`       | >=9      | å›½é™…åŒ–                         | å†…ç½®åŒæ­¥ç¿»è¯‘å™¨ |

- âš ï¸ KaTeX æœªéšæœ¬åº“æ‰“åŒ…æˆ–è‡ªåŠ¨æ³¨å…¥ã€‚å¦‚éœ€ LaTeX æ•°å­¦å…¬å¼æ¸²æŸ“ï¼Œè¯·åœ¨å®¿ä¸»åº”ç”¨ä¸­å®‰è£… `katex` å¹¶æ‰‹åŠ¨å¼•å…¥å…¶æ ·å¼è¡¨ã€‚ç¤ºä¾‹ï¼š

```bash
pnpm add katex
# æˆ–
npm install katex
```

ç„¶ååœ¨åº”ç”¨å…¥å£ï¼ˆä¾‹å¦‚ `main.ts`ï¼‰ä¸­å¼•å…¥æ ·å¼ï¼š

```ts
import "katex/dist/katex.min.css";
```

- ğŸ–¼ï¸ å·¥å…·æ å›¾æ ‡æ”¹ç”¨æœ¬åœ° SVGï¼Œæ— éœ€é¢å¤–å›¾æ ‡åº“

## å¿«é€Ÿå¼€å§‹

```vue
<script setup lang="ts">
import MarkdownRender from "vue-renderer-markdown";
import "vue-renderer-markdown/index.css";

const content = `
# Hello Vue Markdown

- æ”¯æŒåˆ—è¡¨
- æ”¯æŒ **åŠ ç²—** / *æ–œä½“*

\`\`\`ts
console.log('æµå¼æ¸²æŸ“!')
\`\`\`
`;
</script>

<template>
  <MarkdownRender :content="content" />
</template>
```

### ä»£ç å—æ¨¡å¼

| æ¨¡å¼        | ç»„ä»¶                    | é€‚ç”¨åœºæ™¯                   | ä¾èµ–             |
| ----------- | ----------------------- | -------------------------- | ---------------- |
| é»˜è®¤ Monaco | `CodeBlockNode`         | äº¤äº’ã€æŠ˜å ã€å¤åˆ¶ç­‰å®Œæ•´åŠŸèƒ½ | `vue-use-monaco` |
| Shiki é«˜äº®  | `MarkdownCodeBlockNode` | è½»é‡å±•ç¤ºã€SSR å‹å¥½         | `shiki`          |
| çº¯æ–‡æœ¬      | `PreCodeNode`           | æœ€å°ä¾èµ–ã€AI "æ€è€ƒ" è¾“å‡º   | æ—                |

åˆ‡æ¢ç¤ºä¾‹ï¼š

```ts
import { MarkdownCodeBlockNode, setCustomComponents } from "vue-renderer-markdown";

setCustomComponents({
  code_block: MarkdownCodeBlockNode,
});
```

æˆ–åœ¨å®ä¾‹çº§å¯ç”¨çº¯æ–‡æœ¬ï¼š

```vue
<MarkdownRender :content="content" :render-code-blocks-as-pre="true" />
```

## TypeScript ä½¿ç”¨

### æ¸²æŸ“ç±»å‹åŒ– AST

```vue
<script setup lang="ts">
import type { BaseNode } from "vue-renderer-markdown";
import { ref, watchEffect } from "vue";
import MarkdownRender, { parseMarkdownToStructure } from "vue-renderer-markdown";

const content = ref<string>("# Demo\n\n- åˆ—è¡¨é¡¹\n");
const nodes = ref<BaseNode[]>([]);

watchEffect(() => {
  nodes.value = parseMarkdownToStructure(content.value);
});
</script>

<template>
  <MarkdownRender :nodes="nodes" />
</template>
```

### è‡ªå®šä¹‰ç»„ä»¶æ—¶çš„ç±»å‹æç¤º

```vue
<!-- components/CustomCodeBlock.vue -->
<script setup lang="ts">
import type { CodeBlockNode } from "vue-renderer-markdown";

const props = defineProps<{ node: CodeBlockNode }>();
</script>

<template>
  <pre class="custom-code">
    <code :data-lang="props.node.language">{{ props.node.code }}</code>
  </pre>
</template>
```

```ts
// main.ts
import { createApp } from "vue";
import { setCustomComponents, VueRendererMarkdown } from "vue-renderer-markdown";
import App from "./App.vue";
import CustomCodeBlock from "./components/CustomCodeBlock.vue";

const app = createApp(App);

setCustomComponents("docs", {
  code_block: CustomCodeBlock,
});

app.use(VueRendererMarkdown, {
  mathOptions: {
    commands: ["infty", "perp", "alpha"],
    escapeExclamation: true,
  },
  getLanguageIcon(lang) {
    return lang === "shell" ? "<span>sh</span>" : undefined;
  },
});

app.mount("#app");
```

### NodeRenderer å±æ€§ï¼š`parseOptions`

`<MarkdownRender />`ï¼ˆç»„ä»¶å†…éƒ¨åä¸º `NodeRenderer`ï¼‰ç°å·²æ”¯æŒä¸€ä¸ªæ–°çš„ `parseOptions` å±æ€§ã€‚å½“ä½ é€šè¿‡ `content` ä¼ å…¥ Markdown å­—ç¬¦ä¸²å¹¶è®©ç»„ä»¶å†…éƒ¨è§£ææ—¶ï¼Œ`parseOptions` ä¼šè¢«è½¬å‘ç»™å†…éƒ¨çš„ `parseMarkdownToStructure`ï¼Œä»è€Œå…è®¸ä½ åœ¨è§£æå‰/åå¯¹ token æˆ–èŠ‚ç‚¹åšè‡ªå®šä¹‰è½¬æ¢ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨è§£æå‡½æ•°ã€‚

ç±»å‹è¯´æ˜ï¼ˆåº“ä¸­å·²å¯¼å‡ºï¼‰ï¼š

- `preTransformTokens?: (tokens: MarkdownToken[]) => MarkdownToken[]` â€” åœ¨ `markdown-it` ç”Ÿæˆ token ä¹‹åã€åº“å¤„ç†ä¹‹å‰è°ƒç”¨ã€‚ç”¨äºé‡å†™æˆ–æ›¿æ¢ tokensã€‚
- `postTransformTokens?: (tokens: MarkdownToken[]) => MarkdownToken[]` â€” åœ¨åº“åšå†…éƒ¨ token ä¿®å¤ä¹‹åè°ƒç”¨ï¼›å¦‚æœä½ è¿”å›äº†æ–°çš„ token æ•°ç»„ï¼Œåº“ä¼šé‡æ–°å°†å…¶å¤„ç†ä¸ºèŠ‚ç‚¹ã€‚
- `postTransformNodes?: (nodes: ParsedNode[]) => ParsedNode[]` â€” ç›´æ¥åœ¨è§£æå‡ºçš„èŠ‚ç‚¹æ ‘ä¸Šæ“ä½œï¼Œå¸¸ç”¨äºè°ƒæ•´æœ€ç»ˆè¾“å‡ºï¼Œæ˜¯æœ€ç®€å•é«˜æ•ˆçš„æ–¹å¼ä¹‹ä¸€ã€‚

ä½¿ç”¨åœºæ™¯ï¼šå½“ä½ éœ€è¦æ”¯æŒè‡ªå®šä¹‰è¯­æ³•ï¼ˆä¾‹å¦‚æŠŠç‰¹å®š HTML å—æ˜ å°„ä¸ºè‡ªå®šä¹‰èŠ‚ç‚¹ç±»å‹ï¼‰æˆ–åšè½»é‡çº§çš„ token ä¿®æ”¹ä»¥æ”¯æŒè‡ªå®šä¹‰ç»„ä»¶æ¸²æŸ“æ—¶ï¼Œ`parseOptions` éå¸¸æœ‰ç”¨ã€‚é…åˆ `setCustomComponents`ï¼ˆæˆ–å®ä¾‹çº§çš„ `custom-id` æœºåˆ¶ï¼‰å¯å°†è‡ªå®šä¹‰èŠ‚ç‚¹ç±»å‹æ˜ å°„ä¸º Vue ç»„ä»¶ã€‚

Token çº§ç¤ºä¾‹ï¼ˆä½œä¸ºç»„ä»¶ prop ä¼ å…¥ï¼‰ï¼š

```vue
<script setup lang="ts">
import MarkdownRender, { getMarkdown } from "vue-renderer-markdown";

const md = getMarkdown();

function pre(tokens: any[]) {
  return tokens.map((t) => {
    if (t.type === "html_block" && /<thinking>/.test(t.content || "")) {
      return {
        ...t,
        type: "thinking_block",
        content: (t.content || "").replace(/<\/?thinking>/g, ""),
      };
    }
    return t;
  });
}

const parseOptions = { preTransformTokens: pre };
</script>

<template>
  <MarkdownRender
    :content="markdownString"
    :parse-options="parseOptions"
    custom-id="playground-demo"
  />
</template>
```

èŠ‚ç‚¹çº§ç¤ºä¾‹ï¼ˆpostTransformNodes ä½œä¸ºç»„ä»¶ propï¼‰ï¼š

```vue
<script setup lang="ts">
import MarkdownRender from "vue-renderer-markdown";

function postNodes(nodes) {
  if (!nodes || nodes.length === 0) return nodes;
  const first = nodes[0];
  if (first.type === "paragraph") {
    return [{ type: "thinking", content: "Auto-thought", children: [first] }, ...nodes.slice(1)];
  }
  return nodes;
}

const parseOptions = { postTransformNodes: postNodes };
</script>

<template>
  <MarkdownRender :content="markdownString" :parse-options="parseOptions" />
</template>
```

æ³¨æ„ï¼š

- å¦‚æœä½ å·²ç»è‡ªå·±è°ƒç”¨ `parseMarkdownToStructure` å¹¶å°† `nodes` ç›´æ¥ä¼ ç»™ç»„ä»¶ï¼Œåˆ™ `parseOptions` ä¸ä¼šç”Ÿæ•ˆâ€”â€”å®ƒä»…åœ¨ç»„ä»¶æ¥æ”¶ `content` å¹¶åœ¨å†…éƒ¨è§£ææ—¶è¢«ä½¿ç”¨ã€‚
- å½“ä½ é€šè¿‡ token è½¬æ¢ç”Ÿæˆæ–°çš„è‡ªå®šä¹‰èŠ‚ç‚¹ç±»å‹æ—¶ï¼Œè¯·ç”¨ `setCustomComponents('your-id', { your_node_type: YourComponent })` æ³¨å†Œå¯¹åº”çš„ Vue ç»„ä»¶ï¼Œå¹¶ç»™ç»„ä»¶ä¼ å…¥ `custom-id="your-id"`ï¼Œä»¥ä¾¿æ¸²æŸ“å™¨èƒ½æ‰¾åˆ°å¹¶æ¸²æŸ“ä½ çš„ç»„ä»¶ã€‚

## SSR æŒ‡å—

æœ¬åº“è®¾è®¡ä¸º SSR å®‰å…¨ï¼Œé‡å‹ä¾èµ–ï¼ˆMonacoã€Mermaidï¼‰ä»…åœ¨æµè§ˆå™¨ç«¯æ‡’åŠ è½½ï¼Œæµè§ˆå™¨ç›¸å…³åŠŸèƒ½ä¼šè‡ªåŠ¨è·³è¿‡æœåŠ¡ç«¯æ¸²æŸ“ã€‚

- Nuxt 3ï¼šä½¿ç”¨ `<client-only>` åŒ…è£¹ç»„ä»¶
  ```vue
  <template>
    <client-only>
      <MarkdownRender :content="markdown" />
    </client-only>
  </template>
  ```
- Vite SSR / è‡ªå®šä¹‰ SSRï¼šåœ¨ `onMounted` åå†æ¸²æŸ“ç»„ä»¶

  ```vue
  <script setup lang="ts">
  import { onMounted, ref } from "vue";
  import MarkdownRender from "vue-renderer-markdown";

  const mounted = ref(false);
  onMounted(() => {
    mounted.value = true;
  });
  </script>

  <template>
    <div v-if="mounted">
      <MarkdownRender :content="markdown" />
    </div>
    <div v-else>
      <!-- SSR å›é€€ï¼šè½»é‡é¢„æ ¼å¼åŒ–æ–‡æœ¬ -->
      <pre>{{ markdown }}</pre>
    </div>
  </template>
  ```

- è¿è¡Œ `pnpm run check:ssr` å¯éªŒè¯å¯¼å…¥å®‰å…¨
- éœ€è¦æœåŠ¡å™¨é¢„æ¸²æŸ“çš„å›¾è¡¨æˆ–ä»£ç ï¼Œå¯å…ˆç”Ÿæˆé™æ€ HTML åä¼ å…¥

æ›´å¤šç¤ºä¾‹è¯¦è§ [docs/nuxt-ssr.zh-CN.md](docs/nuxt-ssr.zh-CN.md)ã€‚

## æ•…éšœæ’æŸ¥

### Monaco worker åŠ è½½å¤±è´¥

**ç°è±¡**ï¼šç”Ÿäº§ç¯å¢ƒæˆ–é¢„è§ˆæ—¶æ§åˆ¶å°æŠ¥é”™ `Could not load worker`ã€`Failed to load Monaco worker`ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ Vite é…ç½®ä¸­å¯ç”¨ `vite-plugin-monaco-editor-esm` å¹¶æŒ‡å®š worker è¾“å‡ºç›®å½•ã€‚

```ts
// vite.config.ts
import path from "node:path";
import monacoEditorPlugin from "vite-plugin-monaco-editor-esm";

export default {
  plugins: [
    monacoEditorPlugin({
      languageWorkers: ["editorWorkerService", "typescript", "css", "html", "json"],
      customDistPath(root, buildOutDir, base) {
        return path.resolve(buildOutDir, "monacoeditorwork");
      },
    }),
  ],
};
```

> æ³¨æ„ï¼šå¦‚ä»…éœ€æ¸²æŸ“ Monaco ç¼–è¾‘å™¨ï¼ˆç”¨äºä»£ç ç¼–è¾‘æˆ–é¢„è§ˆï¼‰ï¼Œå¯ç›´æ¥é›†æˆ `vue-use-monaco`ï¼Œæ— éœ€æœ¬åº“çš„å®Œæ•´ Markdown æ¸²æŸ“ç®¡çº¿ã€‚

### Mermaid ä¸æ¸²æŸ“

**ç°è±¡**ï¼šæ ‡è®°ä¸º ` ```mermaid` çš„ä»£ç å—ä»ç„¶æ˜¾ç¤ºåŸå§‹æ–‡æœ¬ã€‚

**æ’æŸ¥æ­¥éª¤**ï¼š

1. ç¡®è®¤å·²ç»å®‰è£…ä¾èµ–ï¼š
   ```bash
   pnpm add mermaid
   ```
2. æ ¡éªŒä»£ç å—è¯­æ³•æ˜¯å¦ä¸ºæœ‰æ•ˆ Mermaidï¼š
   ````markdown
   ```mermaid
   graph TD
     A[Start] --> B[End]
   ```
   ````
   ```

   ```
3. æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ Mermaid æŠ›å‡ºçš„é”™è¯¯ï¼Œåº“ä¼šåœ¨æ¸²æŸ“å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æºç å±•ç¤ºã€‚

### è¯­æ³•é«˜äº®æ— æ•ˆ

**ç°è±¡**ï¼šä½¿ç”¨ `MarkdownCodeBlockNode` æ—¶ä»£ç å—ä»…æ˜¾ç¤ºçº¯æ–‡æœ¬ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå®‰è£… `shiki` ä¾èµ–ï¼š

```bash
pnpm add shiki
```

å¹¶ç¡®ä¿åœ¨æ¸²æŸ“å™¨ä¸­å¯ç”¨äº†è¯¥ç»„ä»¶ï¼š

```ts
import { MarkdownCodeBlockNode, setCustomComponents } from "vue-renderer-markdown";

setCustomComponents({
  code_block: MarkdownCodeBlockNode,
});
```

### TypeScript æç¤ºç¼ºå¤±

**ç°è±¡**ï¼šé¡¹ç›®ä¸­æŠ¥é”™ `Cannot find module 'vue-renderer-markdown'` æˆ–ç±»å‹æç¤ºç¼ºå¤±ã€‚

**æ’æŸ¥æ­¥éª¤**ï¼š

1. ä»åŒ…å…¥å£å¯¼å…¥ç±»å‹ï¼š
   ```ts
   import type { BaseNode, CodeBlockNode } from "vue-renderer-markdown";
   ```
2. å¦‚éœ€æ›´ç»†è‡´çš„ç±»å‹å®šä¹‰ï¼š
   ```ts
   import type { MarkdownRenderProps } from "vue-renderer-markdown/dist/types";
   ```
3. åœ¨ `tsconfig.json` ä¸­å¼€å¯ `"moduleResolution": "bundler"` æˆ– `"node16"`ï¼š
   ```json
   {
     "compilerOptions": {
       "moduleResolution": "bundler"
     }
   }
   ```

### SSR æŠ¥ `window is not defined`

**åŸå› **ï¼šMonacoã€Mermaidã€Web Worker ç­‰åŠŸèƒ½ä¾èµ–æµè§ˆå™¨ç¯å¢ƒï¼Œéœ€è¦å»¶è¿Ÿåˆ°å®¢æˆ·ç«¯æ‰§è¡Œã€‚

- **Nuxt 3**ï¼š
  ```vue
  <template>
    <client-only>
      <MarkdownRender :content="markdown" />
    </client-only>
  </template>
  ```
- **è‡ªå®šä¹‰ Vite SSR**ï¼š

  ```vue
  <script setup lang="ts">
  import { onMounted, ref } from "vue";
  import MarkdownRender from "vue-renderer-markdown";

  const mounted = ref(false);
  onMounted(() => {
    mounted.value = true;
  });
  </script>

  <template>
    <MarkdownRender v-if="mounted" :content="markdown" />
  </template>
  ```

### Tailwind æ ·å¼å†²çª

**ç°è±¡**ï¼šåº“çš„æ ·å¼è¢« Tailwind æˆ–å…¶ä»–ç»„ä»¶åº“è¦†ç›–ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå°†åº“æ ·å¼å¯¼å…¥ Tailwind çš„ `components` å±‚ï¼Œç¡®ä¿åŠ è½½é¡ºåºå¯æ§ã€‚

```css
/* main.css æˆ– index.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer components {
  @import "vue-renderer-markdown/index.css";
}
```

å¦‚éœ€æ›´é«˜ä¼˜å…ˆçº§ï¼Œå¯æ”¾å…¥ `base` å±‚ï¼š

```css
@layer base {
  @import "vue-renderer-markdown/index.css";
}
```

### å›¾æ ‡æœªæ˜¾ç¤º

**ç°è±¡**ï¼šå¤åˆ¶ã€æŠ˜å ç­‰å·¥å…·æ æŒ‰é’®æ˜¾ç¤ºä¸ºæ–‡æœ¬æˆ–å ä½ç¬¦ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. ç¡®è®¤å·²ç»å¼•å…¥åº“çš„æ ·å¼æ–‡ä»¶ï¼ˆ`import 'vue-renderer-markdown/index.css'`ï¼‰ã€‚
2. æ£€æŸ¥æ„å»ºå·¥å…·æ˜¯å¦å…è®¸ä»ä¾èµ–ä¸­å¯¼å…¥é™æ€èµ„æºï¼ˆSVGï¼‰ã€‚
3. å¦‚å·²è‡ªå®šä¹‰å›¾æ ‡ç»„ä»¶ï¼Œè¯·ç¡®ä¿å®ƒä»¬æ¸²æŸ“äº†é¢„æœŸçš„ SVG å†…å®¹ã€‚

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

- å°†å¤§å‹ Markdown æ–‡æ¡£æ‹†åˆ†ä¸ºå°å—æµå¼å†™å…¥ï¼Œé¿å…ä¸€æ¬¡æ€§æ¸²æŸ“é˜»å¡ä¸»çº¿ç¨‹ã€‚
- ä»…å±•ç¤ºæ—¶ä½¿ç”¨ `MarkdownCodeBlockNode` æˆ– `render-code-blocks-as-pre`ï¼Œå¯è·³è¿‡ Monaco åˆå§‹åŒ–ã€‚
- ä½¿ç”¨ `setCustomComponents('id', mapping)` ä¸ºä¸åŒæ¸²æŸ“å®ä¾‹åˆ†åˆ«æ³¨å†Œç»„ä»¶ï¼Œå¹¶åœ¨ä¸å†éœ€è¦æ—¶ç§»é™¤ï¼Œå‡å°‘å†…å­˜å ç”¨ã€‚
- åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ `setDefaultMathOptions`ï¼Œç»Ÿä¸€æ•°å­¦å…¬å¼é…ç½®ï¼Œé˜²æ­¢åœ¨æ¸²æŸ“æœŸé—´é‡å¤è®¡ç®—ã€‚
- å¯¹å¤æ‚ Mermaid å›¾è¡¨å¯æå‰åœ¨æœåŠ¡ç«¯æ ¡éªŒæˆ–é¢„æ¸²æŸ“ï¼Œå†å°†ç»“æœä½œä¸ºç¼“å­˜å†…å®¹ä¼ ç»™ç»„ä»¶ã€‚
- Math æ¸²æŸ“é”™è¯¯æ—¶ï¼Œå¯é€šè¿‡ `setDefaultMathOptions` è°ƒæ•´éœ€è¦è‡ªåŠ¨è¡¥å…¨åæ–œæ çš„æŒ‡ä»¤é›†åˆã€‚è‹¥éœ€åœ¨æœåŠ¡ç«¯ç”Ÿæˆæˆ–ç¼“å­˜ KaTeX è¾“å‡ºï¼Œè¯·ç¡®ä¿å®¿ä¸»åº”ç”¨å·²å®‰è£… `katex` å¹¶å°†å…¶åŒ…å«åœ¨æ„å»ºä¸­ã€‚

## æ–°å¢å±æ€§ï¼š`viewportPriority`

- ç±»å‹ï¼š`boolean`
- é»˜è®¤å€¼ï¼š`true`

è¯´æ˜ï¼š

- å¼€å¯ï¼ˆé»˜è®¤ï¼‰æ—¶ï¼Œæ¸²æŸ“å™¨ä¼šä¼˜å…ˆæ¸²æŸ“è§†å£å†…æˆ–æ¥è¿‘è§†å£çš„èŠ‚ç‚¹ï¼Œå°†ç¦»å±çš„é‡å‹èŠ‚ç‚¹ï¼ˆå¦‚ Mermaidã€Monacoï¼‰å»¶åå¤„ç†ï¼Œä»è€Œæå‡é•¿æ–‡æ¡£ä¸æµå¼å†…å®¹çš„é¦–å±å¯äº¤äº’ä½“éªŒã€‚
- å…³é—­ï¼ˆè®¾ä¸º `false`ï¼‰æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹å°†å°½å¿«â€œæ€¥åˆ‡â€æ¸²æŸ“ï¼Œé€‚åˆæ‰“å°/å¯¼å‡ºã€éœ€è¦ä¸€æ¬¡æ€§å®Œæˆå¸ƒå±€æµ‹é‡çš„åœºæ™¯ï¼Œæˆ–ä½ æ˜ç¡®å¸Œæœ›ç«‹å³å‘ˆç°å…¨éƒ¨å†…å®¹çš„æƒ…å†µã€‚

ç¤ºä¾‹ï¼š

```vue
<script setup lang="ts">
import MarkdownRender from "vue-renderer-markdown";

const markdown = `# åŒ…å«å¤§é‡å›¾è¡¨ä¸ä»£ç å—çš„é•¿æ–‡æ¡£...`;
</script>

<template>
  <!-- å‡†å¤‡æ‰“å°æˆ–å¯¼å‡ºæ—¶å¯å…³é—­è§†å£ä¼˜å…ˆ -->
  <MarkdownRender :content="markdown" :viewport-priority="false" />
  <!-- åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨çŸ­æ¨ªçº¿å†™æ³•ï¼šviewport-priorityï¼›ä¸ä¼ æ—¶ä¸ºé»˜è®¤å¼€å¯ -->
</template>
```

## å›½é™…åŒ– / å¤‡ç”¨ç¿»è¯‘

å¦‚ä¸æƒ³å®‰è£…æˆ–ä½¿ç”¨ `vue-i18n`ï¼Œæœ¬åº“å†…ç½®äº†ä¸€ä¸ªåŒæ­¥å¤‡ç”¨ç¿»è¯‘å™¨ï¼Œè¦†ç›–å¸¸è§ UI æ–‡æ¡ˆï¼ˆå¤åˆ¶ã€é¢„è§ˆã€å›¾ç‰‡åŠ è½½ç­‰ï¼‰ã€‚å¯åœ¨åº”ç”¨å¯åŠ¨æ—¶é€šè¿‡ `setDefaultI18nMap` æ›¿æ¢é»˜è®¤è‹±æ–‡ç¿»è¯‘ï¼š

```ts
import { setDefaultI18nMap } from "vue-renderer-markdown";

setDefaultI18nMap({
  "common.copy": "å¤åˆ¶",
  "common.copySuccess": "å·²å¤åˆ¶",
  "common.decrease": "å‡å°‘",
  "common.reset": "é‡ç½®",
  "common.increase": "å¢åŠ ",
  "common.expand": "å±•å¼€",
  "common.collapse": "æŠ˜å ",
  "common.preview": "é¢„è§ˆ",
  "image.loadError": "å›¾ç‰‡åŠ è½½å¤±è´¥",
  "image.loading": "æ­£åœ¨åŠ è½½å›¾ç‰‡...",
});
```

å¦‚å®‰è£…å¹¶é…ç½®äº† `vue-i18n`ï¼Œåº“ä¼šä¼˜å…ˆä½¿ç”¨å…¶ç¿»è¯‘ã€‚

## ç›¸å…³é“¾æ¥

- Streaming Playgroundï¼šhttps://vue-markdown-renderer.simonhe.me/
- ä¼ ç»Ÿæ¸²æŸ“å¯¹æ¯”ç¤ºä¾‹ï¼šhttps://vue-markdown-renderer.simonhe.me/markdown
- æ–‡æ¡£ï¼š[docs/](docs/)
- Issue åé¦ˆï¼šhttps://github.com/Simon-He95/vue-markdown-render/issues

## è®¸å¯åè®®

[MIT](./LICENSE)

---

æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2025-10-20
