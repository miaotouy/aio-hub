<template>
  <div class="agent-preset-editor" :class="{ compact: props.compact }">
    <!-- Â§¥ÈÉ®Êìç‰ΩúÊ†è -->
    <div v-if="!props.compact" class="editor-header">
      <div class="header-title">
        <span>È¢ÑËÆæÊ∂àÊÅØÈÖçÁΩÆ</span>
        <el-tooltip content="È¢ÑËÆæÊ∂àÊÅØÂ∞Ü‰Ωú‰∏∫ÊâÄÊúâÂØπËØùÁöÑ‰∏ä‰∏ãÊñáÂü∫Á°Ä" placement="top">
          <el-icon><QuestionFilled /></el-icon>
        </el-tooltip>
      </div>
      <div class="header-actions">
        <el-button size="small" @click="handleExport">
          <el-icon><Download /></el-icon>
          ÂØºÂá∫
        </el-button>
        <el-button size="small" @click="handleImport">
          <el-icon><Upload /></el-icon>
          ÂØºÂÖ•
        </el-button>
        <el-button type="primary" size="small" @click="handleAddMessage">
          <el-icon><Plus /></el-icon>
          Ê∑ªÂä†Ê∂àÊÅØ
        </el-button>
      </div>
    </div>

    <!-- Ê∂àÊÅØÂàóË°®ÊªöÂä®ÂÆπÂô® -->
    <div class="messages-container" :style="{ height: containerHeight }">
      <div class="messages-scroll-wrapper">
        <VueDraggableNext
          v-model="localMessages"
          item-key="id"
          handle=".drag-handle"
          @start="onDragStart"
          @end="onDragEnd"
          class="messages-list"
          ghost-class="ghost-message"
          drag-class="drag-message"
          :force-fallback="true"
        >
          <div
            v-for="(element, index) in localMessages"
            :key="element.id"
            class="message-card-wrapper"
          >
            <!-- ÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶ - Á¥ßÂáëÊ®°Âºè -->
            <div
              v-if="element.type === 'chat_history' && props.compact"
              class="message-card message-card-compact history-placeholder-compact"
              :class="{ disabled: element.isEnabled === false }"
            >
              <!-- ÊãñÊãΩÊâãÊüÑ -->
              <div class="drag-handle">
                <el-icon><Rank /></el-icon>
              </div>

              <!-- ÂéÜÂè≤ÂõæÊ†á -->
              <div class="role-icon">
                <el-icon color="var(--el-color-warning)">
                  <ChatDotRound />
                </el-icon>
              </div>

              <!-- ÊñáÊú¨ -->
              <div class="message-text-compact placeholder-text">
                üí¨ ËÅäÂ§©ÂéÜÂè≤ÊèíÂÖ•‰ΩçÁΩÆ
              </div>

              <!-- Êìç‰ΩúÊåâÈíÆ -->
              <div class="message-actions-compact">
                <el-switch
                  v-model="element.isEnabled"
                  :active-value="true"
                  :inactive-value="false"
                  size="small"
                  @change="handleToggleEnabled(index)"
                />
              </div>
            </div>

            <!-- ÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶ - Ê≠£Â∏∏Ê®°Âºè -->
            <div
              v-else-if="element.type === 'chat_history'"
              class="message-card history-placeholder"
              :class="{ disabled: element.isEnabled === false }"
            >
              <!-- ÊãñÊãΩÊâãÊüÑ -->
              <div class="drag-handle">
                <el-icon><Rank /></el-icon>
              </div>

              <!-- Ê∂àÊÅØÂÜÖÂÆπ -->
              <div class="message-content">
                <!-- ËßíËâ≤Ê†áÁ≠æ -->
                <div class="message-role">
                  <el-tag
                    type="warning"
                    size="small"
                    effect="plain"
                  >
                    <el-icon style="margin-right: 4px">
                      <ChatDotRound />
                    </el-icon>
                    ÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶
                  </el-tag>
                </div>

                <!-- Ê∂àÊÅØÊñáÊú¨È¢ÑËßà -->
                <div class="message-text placeholder-text">
                  ÂÆûÈôÖÁöÑËÅäÂ§©ÂéÜÂè≤Â∞ÜÂú®Ê≠§Â§ÑÊèíÂÖ•
                </div>
              </div>

              <!-- Êìç‰ΩúÊåâÈíÆ -->
              <div class="message-actions">
                <el-switch
                  v-model="element.isEnabled"
                  :active-value="true"
                  :inactive-value="false"
                  size="small"
                  @change="handleToggleEnabled(index)"
                />
              </div>
            </div>

            <!-- ÊôÆÈÄöÈ¢ÑËÆæÊ∂àÊÅØ - Á¥ßÂáëÊ®°Âºè -->
            <div
              v-else-if="props.compact"
              class="message-card message-card-compact"
              :class="{ disabled: element.isEnabled === false }"
              @click="handleEditMessage(index)"
            >
              <!-- ÊãñÊãΩÊâãÊüÑ -->
              <div class="drag-handle">
                <el-icon><Rank /></el-icon>
              </div>

              <!-- ËßíËâ≤ÂõæÊ†á -->
              <div class="role-icon">
                <el-icon :color="getRoleColor(element.role)">
                  <component :is="getRoleIcon(element.role)" />
                </el-icon>
              </div>

              <!-- Ê∂àÊÅØÊñáÊú¨È¢ÑËßàÔºàÂçïË°åÔºâ -->
              <div class="message-text-compact">
                {{ truncateText(element.content, 60) }}
              </div>

              <!-- Êìç‰ΩúÊåâÈíÆ -->
              <div class="message-actions-compact" @click.stop>
                <el-switch
                  v-model="element.isEnabled"
                  :active-value="true"
                  :inactive-value="false"
                  size="small"
                  @change="handleToggleEnabled(index)"
                />
                <el-button
                  link
                  size="small"
                  @click="handleEditMessage(index)"
                >
                  <el-icon><Edit /></el-icon>
                </el-button>
                <el-button
                  link
                  size="small"
                  type="danger"
                  @click="handleDeleteMessage(index)"
                >
                  <el-icon><Delete /></el-icon>
                </el-button>
              </div>
            </div>

            <!-- ÊôÆÈÄöÈ¢ÑËÆæÊ∂àÊÅØ - Ê≠£Â∏∏Ê®°Âºè -->
            <div
              v-else
              class="message-card"
              :class="{ disabled: element.isEnabled === false }"
            >
              <!-- ÊãñÊãΩÊâãÊüÑ -->
              <div class="drag-handle">
                <el-icon><Rank /></el-icon>
              </div>

              <!-- Ê∂àÊÅØÂÜÖÂÆπ -->
              <div class="message-content">
                <!-- ËßíËâ≤Ê†áÁ≠æ -->
                <div class="message-role">
                  <el-tag
                    :type="getRoleTagType(element.role)"
                    size="small"
                    effect="plain"
                  >
                    <el-icon style="margin-right: 4px">
                      <component :is="getRoleIcon(element.role)" />
                    </el-icon>
                    {{ getRoleLabel(element.role) }}
                  </el-tag>
                </div>

                <!-- Ê∂àÊÅØÊñáÊú¨È¢ÑËßà -->
                <div class="message-text">
                  {{ truncateText(element.content, 120) }}
                </div>
              </div>

              <!-- Êìç‰ΩúÊåâÈíÆ -->
              <div class="message-actions">
                <el-switch
                  v-model="element.isEnabled"
                  :active-value="true"
                  :inactive-value="false"
                  size="small"
                  @change="handleToggleEnabled(index)"
                />
                <el-button
                  link
                  size="small"
                  @click="handleEditMessage(index)"
                >
                  <el-icon><Edit /></el-icon>
                </el-button>
                <el-button
                  link
                  size="small"
                  type="danger"
                  @click="handleDeleteMessage(index)"
                >
                  <el-icon><Delete /></el-icon>
                </el-button>
              </div>
            </div>
          </div>
        </VueDraggableNext>

        <!-- Á©∫Áä∂ÊÄÅ -->
        <div v-if="localMessages.length === 0" class="empty-state">
          <el-empty description="ÊöÇÊó†È¢ÑËÆæÊ∂àÊÅØÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÊ∑ªÂä†">
            <el-button type="primary" @click="handleAddMessage">
              Ê∑ªÂä†Á¨¨‰∏ÄÊù°Ê∂àÊÅØ
            </el-button>
          </el-empty>
        </div>
      </div>
    </div>

    <!-- ÁºñËæëÂØπËØùÊ°Ü -->
    <BaseDialog
      :visible="editDialogVisible"
      @update:visible="editDialogVisible = $event"
      :title="isEditMode ? 'ÁºñËæëÊ∂àÊÅØ' : 'Ê∑ªÂä†Ê∂àÊÅØ'"
      width="800px"
      height="auto"
    >
      <template #content>
        <el-form :model="editForm" label-width="80px">
        <el-form-item label="ËßíËâ≤">
          <el-radio-group v-model="editForm.role">
            <el-radio value="system">
              <el-icon style="margin-right: 4px"><ChatDotRound /></el-icon>
              System
            </el-radio>
            <el-radio value="user">
              <el-icon style="margin-right: 4px"><User /></el-icon>
              User
            </el-radio>
            <el-radio value="assistant">
              <el-icon style="margin-right: 4px"><Service /></el-icon>
              Assistant
            </el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="ÂÜÖÂÆπ">
          <el-input
            v-model="editForm.content"
            type="textarea"
            :rows="16"
            placeholder="ËØ∑ËæìÂÖ•Ê∂àÊÅØÂÜÖÂÆπ..."
          />
          </el-form-item>
        </el-form>
      </template>
      <template #footer>
        <el-button @click="editDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="handleSaveMessage">
          {{ isEditMode ? '‰øùÂ≠ò' : 'Ê∑ªÂä†' }}
        </el-button>
      </template>
    </BaseDialog>

    <!-- ÂØºÂÖ•Êñá‰ª∂ÈÄâÊã©Âô® -->
    <input
      ref="importFileInput"
      type="file"
      accept=".json"
      style="display: none"
      @change="handleFileSelected"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { VueDraggableNext } from 'vue-draggable-next';
import type { ChatMessageNode, MessageRole } from '../../types';
import {
  QuestionFilled,
  Download,
  Upload,
  Plus,
  Rank,
  Edit,
  Delete,
  ChatDotRound,
  User,
  Service,
} from '@element-plus/icons-vue';
import { ElMessage, ElMessageBox } from 'element-plus';

interface Props {
  modelValue?: ChatMessageNode[];
  height?: string;
  /** Á¥ßÂáëÊ®°ÂºèÔºöÂè™ÊòæÁ§∫‰∏ÄË°åÔºåÈöêËóèÂ§¥ÈÉ®Êìç‰ΩúÊ†è */
  compact?: boolean;
}

interface Emits {
  (e: 'update:modelValue', value: ChatMessageNode[]): void;
}

const props = withDefaults(defineProps<Props>(), {
  modelValue: () => [],
  height: '500px',
  compact: false,
});

const emit = defineEmits<Emits>();

// Êú¨Âú∞Ê∂àÊÅØÂàóË°®
const localMessages = ref<ChatMessageNode[]>([]);

// ÁºñËæëÂØπËØùÊ°ÜÁä∂ÊÄÅ
const editDialogVisible = ref(false);
const isEditMode = ref(false);
const editingIndex = ref(-1);
const editForm = ref({
  role: 'system' as MessageRole,
  content: '',
});

// Êñá‰ª∂ÂØºÂÖ•
const importFileInput = ref<HTMLInputElement | null>(null);

// ÂÆπÂô®È´òÂ∫¶
// ÂÆπÂô®È´òÂ∫¶
const containerHeight = computed(() => props.height);

// ÁõëÂê¨Â§ñÈÉ®ÂèòÂåñ
watch(
  () => props.modelValue,
  (newValue) => {
    // Á°Æ‰øùÊâÄÊúâÊ∂àÊÅØÈÉΩÊúâÂîØ‰∏ÄIDÔºåÂπ∂‰∏îÂ≠òÂú®ÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶
    const CHAT_HISTORY_PLACEHOLDER_ID = 'chat-history-placeholder';
    
    // ‰ªéÂ§ñÈÉ®Ëé∑ÂèñÊ∂àÊÅØÂàóË°®
    let existingMessages = [...(newValue || [])];
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶
    const hasHistoryPlaceholder = existingMessages.some((msg) => msg.type === 'chat_history');
    
    // Â¶ÇÊûú‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™
    if (!hasHistoryPlaceholder) {
      const historyPlaceholder: ChatMessageNode = {
        id: CHAT_HISTORY_PLACEHOLDER_ID,
        parentId: null,
        childrenIds: [],
        role: 'system',
        content: 'ËÅäÂ§©ÂéÜÂè≤',
        type: 'chat_history',
        status: 'complete',
        isEnabled: true,
        timestamp: new Date().toISOString(),
      };
      // Â∞ÜÂç†‰ΩçÁ¨¶Ê∑ªÂä†Âà∞ÂàóË°®Êú´Â∞æÔºåËøôÊ†∑ËÅäÂ§©ËÆ∞ÂΩïÈªòËÆ§‰ºöË¢´ÊèíÂÖ•Âà∞Â∫ïÈÉ®
      existingMessages = [...existingMessages, historyPlaceholder];
    }
    
    localMessages.value = existingMessages;
    
    // Â¶ÇÊûúÊàë‰ª¨Ê∑ªÂä†‰∫ÜÂç†‰ΩçÁ¨¶ÔºåÂêåÊ≠•Âà∞Â§ñÈÉ®
    if (!hasHistoryPlaceholder && existingMessages.length > 0) {
      emit('update:modelValue', existingMessages);
    }
  },
  { immediate: true, deep: true }
);
// ÊãñÊãΩÂºÄÂßã‰∫ã‰ª∂
function onDragStart() {
  // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Êó•ÂøóÊàñÂÖ∂‰ªñÈÄªËæë
}

// ÊãñÊãΩÁªìÊùü‰∫ã‰ª∂ - ÂêåÊ≠•Âà∞Â§ñÈÉ®
function onDragEnd() {
  emit('update:modelValue', localMessages.value);
}

// ÂêåÊ≠•Âà∞Â§ñÈÉ®ÁöÑËæÖÂä©ÂáΩÊï∞
function syncToParent() {
  emit('update:modelValue', localMessages.value);
}

/**
 * Ëé∑ÂèñËßíËâ≤Ê†áÁ≠æÁ±ªÂûã
 */
function getRoleTagType(role: MessageRole): 'success' | 'primary' | 'info' {
  const typeMap: Record<MessageRole, 'success' | 'primary' | 'info'> = {
    system: 'info',
    user: 'primary',
    assistant: 'success',
  };
  return typeMap[role];
}

/**
 * Ëé∑ÂèñËßíËâ≤ÂõæÊ†á
 */
function getRoleIcon(role: MessageRole) {
  const iconMap: Record<MessageRole, any> = {
    system: ChatDotRound,
    user: User,
    assistant: Service,
  };
  return iconMap[role];
}

/**
 * Ëé∑ÂèñËßíËâ≤Ê†áÁ≠æÊñáÊú¨
 */
function getRoleLabel(role: MessageRole): string {
  const labelMap: Record<MessageRole, string> = {
    system: 'System',
    user: 'User',
    assistant: 'Assistant',
  };
  return labelMap[role];
}

/**
 * Ëé∑ÂèñËßíËâ≤È¢úËâ≤ÔºàÁ¥ßÂáëÊ®°ÂºèÁî®Ôºâ
 */
function getRoleColor(role: MessageRole): string {
  const colorMap: Record<MessageRole, string> = {
    system: 'var(--el-color-info)',
    user: 'var(--el-color-primary)',
    assistant: 'var(--el-color-success)',
  };
  return colorMap[role];
}

/**
 * Êà™Êñ≠ÊñáÊú¨
 */
function truncateText(text: string, maxLength: number): string {
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

/**
 * Ê∑ªÂä†Ê∂àÊÅØ
 */
function handleAddMessage() {
  isEditMode.value = false;
  editForm.value = {
    role: 'system',
    content: '',
  };
  editDialogVisible.value = true;
}

/**
 * ÁºñËæëÊ∂àÊÅØ
 */
function handleEditMessage(index: number) {
  const message = localMessages.value[index];
  
  // ‰∏çÂÖÅËÆ∏ÁºñËæëÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶
  if (message.type === 'chat_history') {
    ElMessage.warning('ÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶‰∏çÂèØÁºñËæë');
    return;
  }
  
  isEditMode.value = true;
  editingIndex.value = index;
  editForm.value = {
    role: message.role,
    content: message.content,
  };
  editDialogVisible.value = true;
}

/**
 * ‰øùÂ≠òÊ∂àÊÅØ
 */
function handleSaveMessage() {
  if (!editForm.value.content.trim()) {
    ElMessage.warning('Ê∂àÊÅØÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫');
    return;
  }

  if (isEditMode.value) {
    // ÁºñËæëÊ®°ÂºèÔºöÊõ¥Êñ∞Áé∞ÊúâÊ∂àÊÅØ
    const message = localMessages.value[editingIndex.value];
    message.role = editForm.value.role;
    message.content = editForm.value.content;
  } else {
    // Ê∑ªÂä†Ê®°ÂºèÔºöÂàõÂª∫Êñ∞Ê∂àÊÅØ
    const newMessage: ChatMessageNode = {
      id: `preset-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      parentId: null,
      childrenIds: [],
      content: editForm.value.content,
      role: editForm.value.role,
      status: 'complete',
      type: 'message', // ÊòéÁ°ÆÊ†áËÆ∞‰∏∫ÊôÆÈÄöÊ∂àÊÅØ
      isEnabled: true,
      timestamp: new Date().toISOString(),
    };
    localMessages.value.push(newMessage);
  }

  editDialogVisible.value = false;
  syncToParent();
}

/**
 * Âà†Èô§Ê∂àÊÅØ
 */
async function handleDeleteMessage(index: number) {
  const message = localMessages.value[index];
  
  // ‰∏çÂÖÅËÆ∏Âà†Èô§ÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶
  if (message.type === 'chat_history') {
    ElMessage.warning('ÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶‰∏çÂèØÂà†Èô§');
    return;
  }
  
  try {
    await ElMessageBox.confirm(
      'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°È¢ÑËÆæÊ∂àÊÅØÂêóÔºü',
      'Á°ÆËÆ§Âà†Èô§',
      {
        type: 'warning',
      }
    );
    localMessages.value.splice(index, 1);
    syncToParent();
    ElMessage.success('Âà†Èô§ÊàêÂäü');
  } catch {
    // Áî®Êà∑ÂèñÊ∂à
  }
}

/**
 * ÂàáÊç¢ÂêØÁî®Áä∂ÊÄÅ
 */
function handleToggleEnabled(_index: number) {
  // Áä∂ÊÄÅÂ∑≤ÁªèÈÄöËøá v-model Ëá™Âä®Êõ¥Êñ∞ÔºåÈúÄË¶ÅÊâãÂä®ÂêåÊ≠•
  syncToParent();
}


/**
 * ÂØºÂá∫È¢ÑËÆæÊ∂àÊÅØ
 */
function handleExport() {
  if (localMessages.value.length === 0) {
    ElMessage.warning('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÈ¢ÑËÆæÊ∂àÊÅØ');
    return;
  }

  const dataStr = JSON.stringify(localMessages.value, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `preset-messages-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);

  ElMessage.success('ÂØºÂá∫ÊàêÂäü');
}

/**
 * ÂØºÂÖ•È¢ÑËÆæÊ∂àÊÅØ
 */
function handleImport() {
  importFileInput.value?.click();
}

/**
 * Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
 */
async function handleFileSelected(event: Event) {
  const target = event.target as HTMLInputElement;
  const file = target.files?.[0];
  if (!file) return;

  try {
    const content = await file.text();
    const imported = JSON.parse(content) as ChatMessageNode[];

    // ÁÆÄÂçïÈ™åËØÅ
    if (!Array.isArray(imported)) {
      throw new Error('Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ');
    }

    localMessages.value = imported;
    syncToParent();
    ElMessage.success('ÂØºÂÖ•ÊàêÂäü');
  } catch (error) {
    ElMessage.error('ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ');
    console.error('Import error:', error);
  } finally {
    // Ê∏ÖÁ©∫ inputÔºåÂÖÅËÆ∏ÈáçÂ§çÂØºÂÖ•Âêå‰∏ÄÊñá‰ª∂
    target.value = '';
  }
}
</script>

<style scoped>
.agent-preset-editor {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.editor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid var(--el-border-color);
}

.header-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
}

.header-actions {
  display: flex;
  gap: 8px;
}

.messages-container {
  flex: 1;
  overflow: hidden;
  position: relative;
  min-height: 0; /* Á°Æ‰øù flex Â≠êÂÖÉÁ¥†ÂèØ‰ª•Ê≠£Á°ÆÊî∂Áº© */
}

.messages-scroll-wrapper {
  height: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 16px;
  box-sizing: border-box;
}

.messages-list {
  display: flex;
  flex-direction: column;
  gap: 12px; /* ‰ΩøÁî® gap Êõø‰ª£ÊØè‰∏™ wrapper ÁöÑ margin-bottom */
}

.message-card {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 16px;
  background: var(--el-bg-color);
  border: 1px solid var(--el-border-color);
  border-radius: 8px;
  transition: all 0.2s;
}

.message-card:hover {
  border-color: var(--el-color-primary);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.message-card.disabled {
  opacity: 0.5;
}

.message-card.history-placeholder {
  background: var(--el-color-warning-light-9);
  border-color: var(--el-color-warning-light-5);
  border-style: dashed;
}

.message-card.history-placeholder:hover {
  border-color: var(--el-color-warning);
}

.placeholder-text {
  color: var(--el-text-color-secondary);
  font-style: italic;
}

.ghost-message {
  opacity: 0.5;
  background: var(--el-color-primary-light-9);
}

.drag-message {
  opacity: 0.8;
  transform: rotate(2deg);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  transition: none !important;
}

.drag-handle {
  display: flex;
  align-items: center;
  cursor: grab;
  color: var(--el-text-color-secondary);
  padding: 4px;
  user-select: none;
}

.drag-handle:active {
  cursor: grabbing;
}

.drag-handle:hover {
  color: var(--el-color-primary);
}

.message-content {
  flex: 1;
  min-width: 0;
}

.message-role {
  margin-bottom: 8px;
}

.message-text {
  color: var(--el-text-color-regular);
  line-height: 1.6;
  word-break: break-word;
}

.message-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.empty-state {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  min-height: 300px;
}

/* Á¥ßÂáëÊ®°ÂºèÊ†∑Âºè */
.agent-preset-editor.compact .messages-scroll-wrapper {
  padding: 8px;
}

.agent-preset-editor.compact .messages-list {
  gap: 8px; /* Á¥ßÂáëÊ®°Âºè‰∏ã‰ΩøÁî®Êõ¥Â∞èÁöÑÈó¥Ë∑ù */
}

.message-card-compact {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--el-bg-color);
  border: 1px solid var(--el-border-color);
  border-radius: 6px;
  transition: all 0.2s;
  cursor: pointer;
  min-height: 36px;
}

.message-card-compact:hover {
  border-color: var(--el-color-primary);
  background: var(--el-fill-color-light);
}

.message-card-compact.disabled {
  opacity: 0.5;
}

.message-card-compact .drag-handle {
  padding: 2px;
  font-size: 14px;
}

.role-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.message-text-compact {
  flex: 1;
  font-size: 13px;
  color: var(--el-text-color-regular);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
}

.message-actions-compact {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}

/* Á¥ßÂáëÊ®°Âºè‰∏ãÁöÑÁ©∫Áä∂ÊÄÅ */
.agent-preset-editor.compact .empty-state {
  min-height: 100px;
  font-size: 13px;
}

/* Á¥ßÂáëÊ®°Âºè‰∏ãÁöÑÂéÜÂè≤Ê∂àÊÅØÂç†‰ΩçÁ¨¶ */
.history-placeholder-compact {
  background: var(--el-color-warning-light-9);
  border-color: var(--el-color-warning-light-5);
  border-style: dashed;
}

.history-placeholder-compact:hover {
  border-color: var(--el-color-warning);
  background: var(--el-color-warning-light-8);
}

.history-placeholder-compact .placeholder-text {
  color: var(--el-color-warning-dark-2);
  font-weight: 500;
}
</style>