# 资产占位符与转写注入设计（Draft / RFC）

## 1. 背景与目标

当前 `transcription-processor` 在处理附件转写时，统一将文本追加到消息末尾（见 `src/tools/llm-chat/core/context-processors/transcription-processor.ts`）。  
这在简单场景可用，但在复杂 Prompt 结构中存在问题：

- 无法控制转写内容在消息中的位置；
- 多附件时语义顺序不稳定；
- 粘贴含本地文件路径的外部聊天记录后，缺少“一键转资产+占位”能力。

### 目标

1. 提供**独立于宏引擎**的占位符体系（不与 `{{...}}` 冲突）。
2. 支持“附件 -> 占位符 -> 转写注入位置”的稳定映射。
3. 支持多占位符、重复占位符、去重资产复用场景。
4. 默认关闭自动插入，避免改变常规聊天习惯。
5. 为下一步“本地路径一键转资产”预留统一入口。

---

## 2. 非目标（本期不做）

- 不接入 `macro-engine`（避免进入发送前宏固化链路）。
- 不改变知识库占位符机制（`【kb...】`）。
- 不引入新的消息存储字段（先基于现有 `msg.content + msg._attachments` 实现）。
- 不做复杂可视化占位节点（先文本语法稳定，后续可做编辑器装饰）。

---

## 3. 占位符语法设计

为避开宏语法，采用中文括号风格（与知识库风格一致但前缀区分）：

- **语法**：`【file::assetId】`
- **示例**：`请先看这个截图：【file::b2d2c4f2-...】然后回答。`

设计理由：

- 不占用宏命名空间；
- 易于正则扫描；
- 与 KB 占位视觉风格统一，用户可读性好；
- `assetId` 可唯一定位，避免同名文件歧义。

---

## 4. 核心行为定义

## 4.0 UI 渲染规则（渲染历史消息时）

在 `MessageContent.vue` 的 `resolveAsset` 钩子中执行：

1. 扫描文本中的 `【file::assetId】`；
2. 在当前消息的 `attachments` 中查找对应资产；
3. 若资产存在，将其转换为可访问的本地 URL（使用 `asset://` 协议或 `convertFileSrc`）；
4. 将占位符替换为该 URL。

这确保了 Markdown 中的图片 `![](【file::...】)` 或链接 `[文件](【file::...】)` 能在 UI 中正确加载。

## 4.1 注入规则（发送/预览时）

在 `transcription-processor` 内执行：

1. 扫描消息文本中的 `【file::assetId】`；
2. 对每个 `assetId`，尝试在当前消息 `_attachments` 中找到对应资产；
3. **增强指向性（多模态优化）**：
   - 即使资产不可产出文本（如纯图片），若存在占位符，可将其替换为 `[附件: 序号 - 文件名]`。
   - 这能辅助多模态模型通过文本引用精确定位图片位置（如“请对比图1和图2”）。
4. **文本注入**：若资产可产出文本（转写或文本文件提取）：
   - 将占位符替换为完整的格式化文本（保留现有包装，如 `[转写: 文件名] ...内容...`）。
5. 未被占位符“认领”的文本化附件，按旧逻辑追加到末尾。
6. 未解析成功的占位符（附件不存在）处理策略：
   - 保留原占位符（默认，便于排查）；
   - 或替换为空（可选策略）。

## 4.2 多占位符与重复占位符

- 同一消息中可有多个不同占位符；
- 同一 `assetId` 的占位符可重复出现多次；
- 重复占位符均替换为同一份文本（满足“相同图片复读”场景）。

## 4.3 去重兼容

`useAttachmentManager` 当前会按 `id/sha256` 去重。  
本设计要求：**即使去重到同一资产 ID，占位映射也不乱**，因为占位本身就是以 `assetId` 为锚点。  
因此：

- 多个相同内容来源可共享同一 `assetId`；
- 多处占位依旧可稳定替换。

---

## 5. 输入侧交互设计

## 5.1 全局开关（默认关闭）

在 `ChatTranscriptionConfig` 增加：

- `autoInsertPlaceholder: boolean`（默认 `false`）

位置：

- 类型：`src/tools/llm-chat/types/settings.ts`
- 默认值：`DEFAULT_SETTINGS.transcription`
- 设置 UI：`src/tools/llm-chat/components/settings/settingsConfig.ts`

文案建议：

- 标题：自动插入资产占位符
- 说明：导入附件时自动在输入内容插入 `【file::...】`，转写将优先注入占位位置。

## 5.2 拖放/粘贴导入时

当前入口在 `src/tools/llm-chat/components/message-input/MessageInput.vue`，通过 `useChatFileInteraction` 把资产送入 `inputManager`。  
增强后：

- 若 `autoInsertPlaceholder=false`：保持现状（只加附件，不插占位）。
- 若 `true`：成功加入附件后，在当前光标位置插入占位符。
- **多文件策略**：若一次性导入多个文件，按导入顺序在光标处依次插入，每个占位符间以**换行**分隔。

## 5.3 删除后重插

`AttachmentCard.vue` 已有右键菜单（`el-dropdown trigger="contextmenu"`）。  
新增菜单项：

- 插入占位符
- 复制占位符

这样用户删除占位后可随时恢复，无需重新导入文件。

---

## 6. 本地路径一键转换（下一步功能的本期预埋）

目标场景：粘贴聊天记录中含本地路径，例如：

- HTML：`<img src="file://D:\...\a.jpg" />`
- Markdown：`![](file:///D:/.../a.jpg)`

处理流程（可手动触发 + 后续可加自动触发）：

1. 扫描消息文本中的可解析本地路径（支持 `file://` 协议及原生 Windows 路径如 `D:\path\to\file`）；
2. 校验路径存在；
3. 导入为附件（复用现有附件导入能力）；
4. 将原路径片段替换为 `【file::assetId】`；
5. 输出转换报告（成功/失败条数）。

---

## 7. 兼容性与风险

## 7.1 兼容性

- 未使用占位符的用户完全不受影响；
- 占位功能默认关闭，不改变旧习惯；
- processor 保留“末尾追加”回退，避免内容丢失。

## 7.2 风险点

1. **Token 膨胀**：同一大文件（如长 PDF 转写）被多次占位引用，会导致发送文本成倍增加。
   - _缓解_：Phase 2 考虑引入引用标记机制（首次填充全文，后续仅显示“引用自 [文件名]”）。
2. **资产失效**：占位符中的 `assetId` 与 `_attachments` 不一致（手动编辑或跨消息复制）。
3. **语义误解**：用户期望占位符能控制多模态图片位置，但模型理解能力受限。
4. **时序错位**：多窗口同步下，插入占位符与附件导入的时序可能错位。

缓解：

- processor 做存在性校验；
- 无匹配时保留占位符并记录日志；
- 输入侧“先拿到实际 assetId 再插入占位”。

---

## 8. 实施拆分计划（建议）

### Phase 1（最小闭环）

1. `transcription-processor` 支持 `【file::assetId】` 替换 + 回退追加；
2. 增加“文件序号标注”逻辑，增强多模态指向性；
3. settings 增加 `autoInsertPlaceholder`（默认关闭）；
4. 导入附件时（拖放/粘贴）按开关自动插入占位符（含多文件换行逻辑）。

### Phase 2（可用性增强）

1. `AttachmentCard` 右键菜单：插入/复制占位符；
2. 支持重复占位符的“引用标记”机制（防 Token 膨胀）；
3. 占位符未匹配时日志与 UI 轻提示。

### Phase 3（路径转换）

1. 增加“本地路径转资产”工具入口（按钮/菜单）；
2. 支持 HTML/Markdown 图片路径识别与替换；
3. 可选自动转换策略。

---

## 9. 验收用例（关键）

1. 单附件单占位：正确替换，不追加重复内容。
2. 单附件多占位：所有占位都替换。
3. 多附件多占位：按 `assetId` 精准替换。
4. 有占位 + 无占位混合：占位替换 + 其余末尾追加。
5. 占位引用不存在附件：占位保留，流程不中断。
6. 相同内容去重为同一 `assetId`：多处占位替换一致。
7. 用户删除占位后，通过附件右键可重新插入。
8. 开关关闭时：导入附件不自动插占位，行为与现状一致。
