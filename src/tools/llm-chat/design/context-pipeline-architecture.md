# LLM Chat ä¸Šä¸‹æ–‡ç®¡é“æ¶æ„ (Context Pipeline Architecture)

## 1. è®¾è®¡æ¦‚è¿°

LLM Chat çš„ä¸Šä¸‹æ–‡æ„å»ºé‡‡ç”¨ **ç»Ÿä¸€ç®¡é“æ¶æ„ (Unified Pipeline Architecture)**ï¼Œå°†å¤æ‚çš„ä¸Šä¸‹æ–‡ç»„è£…æµç¨‹æ•´åˆä¸ºä¸€ä¸ªå•ä¸€ã€å¯é…ç½®çš„å¤„ç†å™¨æµæ°´çº¿ã€‚

è¿™ç§è®¾è®¡çš„æ ¸å¿ƒç†å¿µæ˜¯ **"å•ä¸€æ•°æ®æµ"** æ¨¡å‹ï¼š

1.  **ç»Ÿä¸€ç®¡é“**ï¼šæ‰€æœ‰å¤„ç†æ­¥éª¤ï¼ˆåŠ è½½ã€è½¬æ¢ã€æˆªæ–­ã€æ³¨å…¥ã€åå¤„ç†ã€é™„ä»¶è½¬æ¢ï¼‰éƒ½åœ¨åŒä¸€ä¸ªç®¡é“ä¸­æŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œã€‚
2.  **ä¿ç•™å…ƒæ•°æ®**ï¼šåœ¨ç®¡é“æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¶ˆæ¯ä¿æŒ"ä¸­é—´æ ¼å¼"ï¼ŒåŒ…å«åŸå§‹é™„ä»¶å¼•ç”¨ï¼Œç›´åˆ°æœ€åä¸€æ­¥æ‰è½¬æ¢ä¸ºæœ€ç»ˆå‘é€æ ¼å¼ã€‚
3.  **çµæ´»é…ç½®**ï¼šæ‰€æœ‰å¤„ç†å™¨éƒ½å¯é…ç½®ã€å¯æ’åºã€å¯å¯ç”¨/ç¦ç”¨ï¼Œé€šè¿‡ `priority` å­—æ®µæ§åˆ¶æ‰§è¡Œé¡ºåºã€‚

## 2. æ¶æ„æ€»è§ˆ

### 2.1. æ•°æ®æµå‘

ä»¥ä¸‹ Mermaid å›¾å±•ç¤ºäº†ä»ç”¨æˆ·è¾“å…¥åˆ°æœ€ç»ˆå‘é€ç»™ LLM çš„å®Œæ•´æµç¨‹ï¼ˆå½“å‰å·²å®ç°æ¶æ„ï¼‰ï¼š

```mermaid
graph TD
    subgraph A [useChatHandler - æŒ‡æŒ¥ä¸­å¿ƒ]
        A1(ç”¨æˆ·è¾“å…¥) --> A2{å®ä¸é™„ä»¶å¤„ç†}
        A2 --> A3[åˆ›å»ºæ¶ˆæ¯èŠ‚ç‚¹]
    end

    subgraph B [useChatExecutor - æ‰§è¡Œå™¨]
        B1(åˆ›å»º PipelineContext)
        B2(è°ƒç”¨ç»Ÿä¸€ç®¡é“)
    end

    subgraph UnifiedPipeline [ç»Ÿä¸€ä¸Šä¸‹æ–‡ç®¡é“]
        direction TB
        P1[1. ä¼šè¯åŠ è½½å™¨<br/>priority: 100]
        P2[2. æ­£åˆ™å¤„ç†å™¨<br/>priority: 200]
        P3[3. è½¬å†™ä¸æ–‡æœ¬æå–å™¨<br/>priority: 250]
        P4[4. æ³¨å…¥ç»„è£…å™¨<br/>priority: 400]
        P5[5. Token é™åˆ¶å™¨<br/>priority: 450]
        P6[6. æ¶ˆæ¯æ ¼å¼åŒ–<br/>priorities: 500-800]
        P7[7. æ’ä»¶æ‰©å±•ç‚¹<br/>priority: 900]
        P8[8. Base64 èµ„æºè§£æå™¨<br/>priority: 10000]

        P1 --> P2 --> P3 --> P4 --> P5 --> P6 --> P7 --> P8
    end

    A3 --> B1
    B1 --> B2
    B2 --> UnifiedPipeline
    P10 --> Final((å‘é€è‡³ LLM))

    classDef stage fill:#f9f9f9,stroke:#33,stroke-width:2px;
    class A,B stage;
    style P10 fill:#e3f2fd,stroke:#1976d2
```

### 2.2. æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ                        | è¯´æ˜                                                                                                |
| :-------------------------- | :-------------------------------------------------------------------------------------------------- |
| **PipelineContext**         | åœ¨ç®¡é“ä¸­æµåŠ¨çš„ç»Ÿä¸€æ•°æ®è½½ä½“ï¼ŒåŒ…å«æ¶ˆæ¯åˆ—è¡¨ã€å…ƒæ•°æ®å’Œå…±äº«é»‘æ¿                                          |
| **ContextProcessor**        | è´Ÿè´£å•ä¸€åŠŸèƒ½çš„æ¨¡å—åŒ–å¤„ç†å•å…ƒï¼Œå¯é…ç½®ã€å¯æ’åºã€å¯å¯ç”¨/ç¦ç”¨ã€‚æ”¯æŒé€šè¿‡ `configFields` è‡ªåŠ¨ç”Ÿæˆé…ç½®ç•Œé¢ |
| **Infrastructure Services** | å¦‚ `MacroProcessor`ï¼Œä½œä¸ºåŸºç¡€èƒ½åŠ›è¢«å¤„ç†å™¨æŒ‰éœ€è°ƒç”¨ï¼Œè€Œéç®¡é“æ­¥éª¤                                     |
| **ä¸­é—´æ ¼å¼æ¶ˆæ¯**            | åœ¨ç®¡é“ä¸­æµåŠ¨çš„æ¶ˆæ¯ï¼Œä¿æŒé™„ä»¶å¼•ç”¨æ ¼å¼ï¼Œç›´åˆ°æœ€åä¸€æ­¥ç”± `asset-resolver` è½¬æ¢ä¸ºæœ€ç»ˆæ ¼å¼                |

## 3. ç»Ÿä¸€ç®¡é“è®¾è®¡

ç»Ÿä¸€ç®¡é“è´Ÿè´£å°†åŸå§‹æ•°æ®ç»„è£…æˆæœ€ç»ˆå‘é€ç»™ LLM çš„ä¸Šä¸‹æ–‡ã€‚å…¶å†…éƒ¨æ‰§è¡Œä¸¥æ ¼éµå¾ªå¤„ç†å™¨çš„ä¼˜å…ˆçº§é¡ºåºï¼š

### 3.1. æ‰§è¡Œé¡ºåº

1.  **åŠ è½½ä¼šè¯å†å²**ï¼šåŠ è½½ä¼šè¯å†å²ï¼Œè½¬æ¢ä¸ºä¸­é—´æ ¼å¼æ¶ˆæ¯ï¼ˆä¿ç•™é™„ä»¶å¼•ç”¨ï¼‰ã€‚
2.  **æ­£åˆ™å¤„ç†**ï¼š**å°±åœ°ä¿®æ”¹**æ¶ˆæ¯å†…å®¹ï¼Œåº”ç”¨æ­£åˆ™æ›¿æ¢è§„åˆ™ã€‚
3.  **è½¬å†™ä¸æ–‡æœ¬æå–**ï¼šå¯¹éŸ³é¢‘ã€è§†é¢‘ã€å›¾ç‰‡é™„ä»¶è¿›è¡Œè½¬å†™ï¼Œå¹¶ç›´æ¥è¯»å–æ–‡æœ¬é™„ä»¶å†…å®¹ï¼Œå°†å…¶æ’å…¥æ¶ˆæ¯å†…å®¹ï¼Œä»¥ä¾¿åç»­ Token è®¡ç®—ã€‚
4.  **æ³¨å…¥ä¸ç»„è£…**ï¼šå°† Agent é¢„è®¾æ¶ˆæ¯åˆ†ç±»ä¸ºéª¨æ¶ã€æ·±åº¦æ³¨å…¥ã€é”šç‚¹æ³¨å…¥ï¼Œç„¶åä¸å†å²æ¶ˆæ¯ç²¾å¯†ç»„è£…ã€‚
5.  **Token é™åˆ¶**ï¼šå¯¹æ¶ˆæ¯è¿›è¡Œæˆªæ–­ã€‚**æ­¤æ­¥éª¤å‘ç”Ÿåœ¨æ³¨å…¥ä¹‹å**ï¼Œé™åˆ¶å™¨èƒ½å¤Ÿçœ‹åˆ°æ‰€æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬é¢„è®¾å’Œå†å²ï¼‰ã€‚å®ƒä¼šä¼˜å…ˆä¿ç•™é¢„è®¾æ¶ˆæ¯ï¼Œè®¡ç®—å…¶ Token å ç”¨ï¼Œç„¶åå°†å‰©ä½™é¢„ç®—åˆ†é…ç»™å†å²æ¶ˆæ¯è¿›è¡Œæˆªæ–­ã€‚
6.  **æ¶ˆæ¯æ ¼å¼åŒ–**ï¼šåº”ç”¨æ¨¡å‹ç‰¹å®šçš„æ ¼å¼åŒ–è§„åˆ™ï¼ˆåˆå¹¶ System æ¶ˆæ¯ã€åˆå¹¶è¿ç»­è§’è‰²ç­‰ï¼‰ã€‚
7.  **æ’ä»¶æ‰©å±•**ï¼šæ‰§è¡Œæ’ä»¶æ³¨å†Œçš„è‡ªå®šä¹‰å¤„ç†å™¨ï¼ˆé¢„ç•™æ‰©å±•ç‚¹ï¼‰ã€‚
8.  **Base64 èµ„æºè§£æ**ï¼š**æœ€åä¸€æ­¥**ï¼Œå°†å‰©ä½™çš„äºŒè¿›åˆ¶é™„ä»¶å¼•ç”¨ï¼ˆå¦‚å›¾ç‰‡ã€PDFã€éŸ³è§†é¢‘ï¼‰è½¬æ¢ä¸ºæœ€ç»ˆå‘é€æ ¼å¼ï¼ˆç»“æ„åŒ–å¯¹è±¡æˆ– Base64ï¼‰ã€‚

### 3.2. å†…ç½®å¤„ç†å™¨

ä»¥ä¸‹æ˜¯ç³»ç»Ÿå†…ç½®çš„æ ¸å¿ƒå¤„ç†å™¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼š

| ID                            | åç§°              | èŒè´£                                                                           | ä¼˜å…ˆçº§ | å®é™… ID (ä»£ç )                |
| :---------------------------- | :---------------- | :----------------------------------------------------------------------------- | :----- | :---------------------------- |
| `primary:session-loader`      | ä¼šè¯åŠ è½½å™¨        | åŠ è½½ä¼šè¯å†å²ä¸ºä¸­é—´æ ¼å¼æ¶ˆæ¯ï¼ˆä¿ç•™é™„ä»¶å¼•ç”¨ï¼‰                                     | 100    | `primary:session-loader`      |
| `primary:regex-processor`     | æ­£åˆ™å¤„ç†å™¨        | å¯¹å†å²æ¶ˆæ¯åº”ç”¨æ­£åˆ™è§„åˆ™                                                         | 200    | `primary:regex-processor`     |
| `transcription-processor`     | è½¬å†™ä¸æ–‡æœ¬æå–å™¨  | å¯¹éŸ³é¢‘/è§†é¢‘/å›¾ç‰‡è½¬å†™ï¼ŒåŠ**è¯»å–æ–‡æœ¬é™„ä»¶å†…å®¹**ï¼Œæ’å…¥æ¶ˆæ¯ä»¥ä¾¿ Token è®¡ç®—          | 250    | `transcription-processor`     |
| `primary:injection-assembler` | æ³¨å…¥ç»„è£…å™¨        | å¤„ç†é¢„è®¾ã€æ³¨å…¥ã€å®ï¼Œå¹¶ä¸å†å²æ¶ˆæ¯ç»„è£…                                           | 400    | `primary:injection-assembler` |
| `primary:token-limiter`       | Token é™åˆ¶å™¨      | æ ¹æ®é¢„ç®—æˆªæ–­å†å²æ¶ˆæ¯ï¼ˆä¼˜å…ˆä¿ç•™é¢„è®¾æ¶ˆæ¯ï¼Œå‰©ä½™é¢„ç®—åˆ†ç»™å†å²ï¼‰                     | 450    | `primary:token-limiter`       |
| `message-formatter`           | æ¶ˆæ¯æ ¼å¼åŒ–å™¨      | åŒ…å«ä¸€ç³»åˆ—å­å¤„ç†å™¨ï¼Œè´Ÿè´£åˆå¹¶Systemã€åˆå¹¶è¿ç»­è§’è‰²ã€è½¬æ¢Systemã€ç¡®ä¿è§’è‰²äº¤æ›¿ç­‰ã€‚ | 500    | `message-formatter`           |
| `asset-resolver`              | Base64 èµ„æºè§£æå™¨ | **æœ€åä¸€æ­¥**ï¼šå°†å‰©ä½™çš„äºŒè¿›åˆ¶é™„ä»¶å¼•ç”¨è½¬æ¢ä¸ºæœ€ç»ˆå‘é€æ ¼å¼ï¼ˆç»“æ„åŒ–å¯¹è±¡æˆ– Base64ï¼‰  | 10000  | `asset-resolver`              |

> **è®¾è®¡è¦ç‚¹**ï¼š
>
> 1. å®å¤„ç† (`macro`) ä¸æ˜¯ç‹¬ç«‹çš„ç®¡é“å¤„ç†å™¨ï¼Œè€Œæ˜¯è¢« `regex-processor` å’Œ `injection-assembler` æŒ‰éœ€è°ƒç”¨çš„åŸºç¡€èƒ½åŠ›ã€‚è¿™ç¡®ä¿äº†å®åœ¨æ­£ç¡®çš„ä¸Šä¸‹æ–‡ä¸­è¢«è§£æã€‚
> 2. `asset-resolver` å…·æœ‰æœ€é«˜çš„ä¼˜å…ˆçº§ï¼ˆ10000ï¼‰ï¼Œç¡®ä¿å®ƒåœ¨æ‰€æœ‰å…¶ä»–å¤„ç†å®Œæˆåæœ€åæ‰§è¡Œï¼Œé¿å… base64 æ•°æ®å¹²æ‰°å…¶ä»–å¤„ç†æ­¥éª¤ã€‚
> 3. `transcription-processor` ä¼˜å…ˆçº§è°ƒæ•´ä¸º 250ï¼Œç¡®ä¿æ‰€æœ‰æ–‡æœ¬å†…å®¹ï¼ˆåŒ…æ‹¬è½¬å†™å’Œæ–‡ä»¶è¯»å–ï¼‰åœ¨ Token é™åˆ¶ä¹‹å‰å®Œæˆã€‚
> 4. **Token é™åˆ¶å™¨ä½ç½®**ï¼šToken é™åˆ¶å™¨ (450) åœ¨æ³¨å…¥ç»„è£…å™¨ (400) ä¹‹åæ‰§è¡Œã€‚è¿™ç¡®ä¿äº†é™åˆ¶å™¨èƒ½å‡†ç¡®è®¡ç®—é¢„è®¾æ¶ˆæ¯çš„ Token å ç”¨ï¼Œä»è€Œæ›´ç²¾å‡†åœ°æ§åˆ¶æ€»ä¸Šä¸‹æ–‡é•¿åº¦ï¼ŒåŒæ—¶ä¾ç„¶åªæˆªæ–­å†å²æ¶ˆæ¯ã€‚

## 4. ä¸­é—´æ ¼å¼æ¶ˆæ¯ä¸èµ„äº§è§£æ

### 4.1. ä¸­é—´æ ¼å¼æ¶ˆæ¯

åœ¨ç®¡é“æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¶ˆæ¯ä¿æŒ"ä¸­é—´æ ¼å¼"ï¼Œå…¶ç‰¹ç‚¹æ˜¯ï¼š

```typescript
interface ProcessableMessage {
  role: "system" | "user" | "assistant";
  // å†…å®¹å¯ä»¥æ˜¯çº¯æ–‡æœ¬ï¼Œæˆ–åŒ…å«é™„ä»¶å¼•ç”¨çš„ç‰¹æ®Šç»“æ„
  content: string | LlmMessageContent[];
  // é™„ä»¶å¼•ç”¨ä¿¡æ¯
  _attachments?: Asset[];
  // å…¶ä»–å…ƒæ•°æ®...
}
```

å®é™…ç±»å‹å®šä¹‰è§ `src/tools/llm-chat/types/context.ts`ã€‚

### 4.2. Base64 èµ„æºè§£æå™¨ (`asset-resolver`)

`asset-resolver` å¤„ç†å™¨çš„èŒè´£ï¼ˆä»…å¤„ç†äºŒè¿›åˆ¶é™„ä»¶ï¼‰ï¼š

1.  **è¯†åˆ«é™„ä»¶å¼•ç”¨**ï¼šæ‰«ææ‰€æœ‰æ¶ˆæ¯çš„ `_attachments` å­—æ®µï¼Œæ‰¾å‡ºå‰©ä½™çš„äºŒè¿›åˆ¶é™„ä»¶ï¼ˆæ–‡æœ¬ç±»å‹çš„é™„ä»¶å·²åœ¨ `transcription-processor` ä¸­è¢«æ¶ˆè´¹ï¼‰ã€‚
2.  **è½¬æ¢ä¸ºæœ€ç»ˆæ ¼å¼**ï¼šæ ¹æ®æ¨¡å‹èƒ½åŠ›å’Œè®¾ç½®ï¼Œå°†é™„ä»¶å¼•ç”¨è½¬æ¢ä¸ºï¼š
    - å¯¹äºå›¾ç‰‡ï¼šè½¬æ¢ä¸º `{ type: "image", imageBase64: "..." }` æ ¼å¼ï¼ˆé¡¹ç›®å†…éƒ¨ç»Ÿä¸€æ ¼å¼ï¼‰ã€‚
    - å¯¹äºæ–‡æ¡£/éŸ³è§†é¢‘ï¼šè½¬æ¢ä¸º `{ type: "document" | "audio" | "video", source: { type: "base64", media_type: "...", data: "..." } }` ç»“æ„åŒ–å¯¹è±¡ã€‚
3.  **æ›´æ–°æ¶ˆæ¯å†…å®¹**ï¼šå°†è½¬æ¢åçš„ç»“æ„åŒ–å†…å®¹è¿½åŠ åˆ°æ¶ˆæ¯çš„ `content` å­—æ®µã€‚
4.  **è®°å½•è½¬æ¢æ—¥å¿—**ï¼šåœ¨ `PipelineContext.logs` ä¸­è®°å½•è½¬æ¢è¯¦æƒ…ã€‚

### 4.3. é…ç½®åˆå¹¶ç­–ç•¥ (Agent ä¸æ¨¡å‹çš„ååŒ)

ä¸ºäº†å…¼é¡¾çµæ´»æ€§ä¸ä¸€è‡´æ€§ï¼Œå¤„ç†å™¨é…ç½®é‡‡ç”¨ä¸¤çº§åˆå¹¶ç­–ç•¥ï¼Œéµå¾ª **"Agent ä¼˜å…ˆï¼Œæ¨¡å‹å…œåº•"** çš„åŸåˆ™ã€‚

**åˆå¹¶é€»è¾‘**:

åœ¨ `useChatExecutor` æ‰§è¡Œç®¡é“ä¹‹å‰ï¼Œä¼šè¿›è¡Œä»¥ä¸‹åˆå¹¶ï¼š

1.  **åŠ è½½æ¨¡å‹é…ç½®**: è·å–å½“å‰æ¨¡å‹å®šä¹‰çš„é»˜è®¤å¤„ç†å™¨é…ç½®åˆ—è¡¨ï¼ˆåŒ…å«å¯ç”¨çŠ¶æ€å’Œå‚æ•°ï¼‰ã€‚
2.  **åŠ è½½ Agent é…ç½®**: è·å–å½“å‰ Agent å®šä¹‰çš„å¤„ç†å™¨é…ç½®åˆ—è¡¨ï¼ˆåŒ…å«å¯ç”¨çŠ¶æ€å’Œå‚æ•°ï¼‰ã€‚
3.  **æ‰§è¡Œåˆå¹¶**:
    - å¦‚æœæŸä¸ªå¤„ç†å™¨ä»…åœ¨æ¨¡å‹é…ç½®ä¸­å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä½¿ç”¨æ¨¡å‹é…ç½®ã€‚
    - å¦‚æœæŸä¸ªå¤„ç†å™¨ä»…åœ¨ Agent é…ç½®ä¸­å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ Agent é…ç½®ã€‚
    - å¦‚æœæŸä¸ªå¤„ç†å™¨åœ¨ä¸¤è€…ä¸­éƒ½å­˜åœ¨ï¼ˆID ç›¸åŒï¼‰ï¼Œåˆ™**Agent é…ç½®å®Œå…¨è¦†ç›–æ¨¡å‹é…ç½®**ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿ Agent çš„ç‰¹å®šéœ€æ±‚ï¼ˆå¦‚ç‰¹å®šçš„ Prompt é£æ ¼ï¼‰æ€»æ˜¯ä¼˜å…ˆäºæ¨¡å‹çš„é»˜è®¤è¡Œä¸ºã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¨¡å‹å¯ä»¥æºå¸¦ä¸€å¥—"æœ€ä½³å®è·µ"çš„é»˜è®¤å¤„ç†å™¨é…ç½®ï¼Œè€Œ Agent ä¾ç„¶æ‹¥æœ‰æœ€ç»ˆçš„å†³å®šæƒã€‚

## 5. æ¥å£å®šä¹‰

### 5.1. PipelineContext

```typescript
import type { ChatSession, UserProfile } from "../types";
import type { ProcessableMessage } from "../types/context";
import type { ModelCapabilities } from "@/types/llm-profiles";
import type { ChatAgent } from "@/tools/llm-chat/types/agent";

export interface PipelineContext {
  // --- æ ¸å¿ƒå¯å˜æ•°æ® ---
  /**
   * å½“å‰æ­£åœ¨æ„å»ºçš„æ¶ˆæ¯åˆ—è¡¨ã€‚
   * å¤„ç†å™¨å¯ä»¥ç›´æ¥ä¿®æ”¹æ­¤æ•°ç»„ï¼ˆå¢åˆ æ”¹ï¼‰ã€‚
   */
  messages: ProcessableMessage[];

  // --- åªè¯»å…ƒæ•°æ® ---
  readonly session: ChatSession;
  readonly userProfile?: UserProfile;
  readonly agentConfig: ChatAgent; // å®Œæ•´çš„æ™ºèƒ½ä½“é…ç½®
  readonly capabilities?: ModelCapabilities;
  readonly timestamp: number;

  // --- å…±äº«é»‘æ¿ (Shared Blackboard) ---
  /**
   * ç”¨äºå¤„ç†å™¨ä¹‹é—´ä¼ é€’ä¸´æ—¶æ•°æ®ã€‚
   * ä¾‹å¦‚ï¼šå›¾åƒåˆ†æå™¨æå–çš„æè¿°å¯ä»¥å­˜æ”¾åœ¨è¿™é‡Œï¼Œä¾›åç»­çš„ Prompt å¤„ç†å™¨è¯»å–ã€‚
   */
  sharedData: Map<string, any>;

  // --- æ—¥å¿—è®°å½• ---
  /**
   * å¤„ç†å™¨å¯ä»¥è®°å½•å¤„ç†æ—¥å¿—ï¼Œç”¨äºè°ƒè¯•å’Œå¯è§†åŒ–å±•ç¤ºã€‚
   */
  logs: Array<{
    processorId: string;
    level: "info" | "warn" | "error";
    message: string;
    details?: any;
  }>;
}
```

### 5.2. ContextProcessor

```typescript
export interface ContextProcessor {
  /** å”¯ä¸€æ ‡è¯†ç¬¦ (ä¾‹å¦‚: 'primary:session-loader') */
  id: string;

  /** æ˜¾ç¤ºåç§° (ä¾‹å¦‚: 'ä¼šè¯åŠ è½½å™¨') */
  name: string;

  /** æè¿°ä¿¡æ¯ */
  description: string;

  /**
   * æ‰§è¡Œä¼˜å…ˆçº§ (æ•°å­—è¶Šå°è¶Šé å‰)
   * ç”¨äºå¤„ç†å™¨çš„æ’åºï¼Œæ ¸å¿ƒå¤„ç†å™¨åº”æœ‰å›ºå®šçš„ä¼˜å…ˆçº§ã€‚
   */
  priority: number;

  /** å›¾æ ‡ (Lucide å›¾æ ‡åæˆ– URL) */
  icon?: string;

  /** æ˜¯å¦ä¸ºç³»ç»Ÿæ ¸å¿ƒå¤„ç†å™¨ (ä¸å¯åˆ é™¤ï¼Œä½†å¯èƒ½å…è®¸ç¦ç”¨) */
  isCore?: boolean;

  /** é»˜è®¤å¯ç”¨çŠ¶æ€ */
  defaultEnabled?: boolean;

  /**
   * æ ¸å¿ƒæ‰§è¡Œé€»è¾‘
   * @param context ç®¡é“ä¸Šä¸‹æ–‡
   */
  execute(context: PipelineContext): Promise<void>;

  /**
   * é…ç½®ç»„ä»¶ (å¯é€‰)
   * å¦‚æœå¤„ç†å™¨æœ‰è‡ªå®šä¹‰é…ç½®ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ª Vue ç»„ä»¶åç§°
   */
  configComponent?: string;

  /**
   * é…ç½®å­—æ®µå®šä¹‰ (å¯é€‰)
   * ç”¨äºè‡ªåŠ¨ç”Ÿæˆç®€å•çš„é…ç½® UIï¼Œæ— éœ€ç¼–å†™è‡ªå®šä¹‰ç»„ä»¶
   */
  configFields?: ProcessorConfigField[];
}

export interface ProcessorConfigField {
  key: string;
  label: string;
  type?: "text" | "number" | "boolean" | "select";
  placeholder?: string;
  default?: any;
  options?: { label: string; value: any }[];
}
```

## 6. å­˜å‚¨ä¸çŠ¶æ€ç®¡ç†

ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„ Pinia Store ç®¡ç†æ‰€æœ‰å¤„ç†å™¨ï¼Œä½äº `src/tools/llm-chat/stores/contextPipelineStore.ts`ï¼š

- **`useContextPipelineStore`**ï¼šç®¡ç†æ‰€æœ‰å¤„ç†å™¨çš„æ³¨å†Œã€æ’åºã€å¯ç”¨/ç¦ç”¨å’Œæ‰§è¡Œè°ƒåº¦ã€‚

## 7. å®ç°çŠ¶æ€

ç»Ÿä¸€ç®¡é“æ¶æ„å·²å®Œå…¨å®ç°å¹¶é›†æˆåˆ° LLM Chat ä¸­ã€‚ä»¥ä¸‹ä¸ºå„é˜¶æ®µçš„å®Œæˆæƒ…å†µï¼š

| é˜¶æ®µ                              | çŠ¶æ€      | è¯´æ˜                                                                          |
| :-------------------------------- | :-------- | :---------------------------------------------------------------------------- |
| **Phase 1: åˆ›å»ºç»Ÿä¸€å­˜å‚¨**         | âœ… å·²å®Œæˆ | å·²åˆ›å»º `contextPipelineStore.ts`ï¼Œåˆå¹¶äº†å‰åå¤„ç†å™¨çš„ç®¡ç†é€»è¾‘ã€‚                |
| **Phase 2: ç»Ÿä¸€å¤„ç†å™¨ç›®å½•**       | âœ… å·²å®Œæˆ | æ‰€æœ‰å¤„ç†å™¨å·²ç»Ÿä¸€æ”¾ç½®åœ¨ `core/context-processors/` ç›®å½•ä¸‹ã€‚                    |
| **Phase 3: åˆ›å»ºèµ„äº§è§£æå™¨**       | âœ… å·²å®Œæˆ | `asset-resolver.ts` å·²å®ç°ï¼Œè´Ÿè´£äºŒè¿›åˆ¶é™„ä»¶çš„ Base64 è½¬æ¢ã€‚                    |
| **Phase 4: é‡æ„ä¼šè¯åŠ è½½å™¨**       | âœ… å·²å®Œæˆ | `session-loader.ts` è¾“å‡ºä¸­é—´æ ¼å¼æ¶ˆæ¯ï¼Œä¿ç•™é™„ä»¶å¼•ç”¨ã€‚                          |
| **Phase 5: æ›´æ–°é¢„è§ˆæ„å»ºå™¨**       | âœ… å·²å®Œæˆ | `preview-builder.ts` å·²é€‚é…ä¸­é—´æ ¼å¼æ¶ˆæ¯ï¼ŒToken è®¡ç®—æ­£ç¡®ã€‚                     |
| **Phase 6: æ¸…ç†æ—§å­˜å‚¨**           | âœ… å·²å®Œæˆ | å·²ç§»é™¤ `primaryContextPipelineStore.ts` å’Œ `postProcessingPipelineStore.ts`ã€‚ |
| **Phase 7: æ’ä»¶ API æ›´æ–°**        | ğŸ”„ è¿›è¡Œä¸­ | æ’ä»¶ç³»ç»Ÿæ”¯æŒæ³¨å†Œè‡ªå®šä¹‰å¤„ç†å™¨ï¼ŒAPI æ­£åœ¨é€æ­¥å®Œå–„ã€‚                              |
| **Phase 8: æ ¸å¿ƒç®—æ³•ä¸å·¥å…·å±‚é‡æ„** | âœ… å·²å®Œæˆ | æ¶ˆé™¤äº†è¿‡åº¦æ‹†åˆ†ï¼Œå°†å·¥å…·å‡½æ•°åˆå¹¶åˆ°å¯¹åº”å¤„ç†å™¨ï¼Œæå‡äº†å†…èšæ€§ã€‚                    |

å½“å‰æ¶æ„å·²ç¨³å®šè¿è¡Œï¼Œæ”¯æŒæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼šå†å²åŠ è½½ã€æ­£åˆ™å¤„ç†ã€é™„ä»¶è½¬å†™ã€Token é™åˆ¶ã€é¢„è®¾æ³¨å…¥ã€æ¶ˆæ¯æ ¼å¼åŒ–åŠ Base64 èµ„æºè§£æã€‚

## 8. æ–‡ä»¶ç»“æ„

```
src/tools/llm-chat/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ context-utils/            # è¾…åŠ©å·¥å…·å±‚
â”‚   â”‚   â”œâ”€â”€ index.ts              # ç»Ÿä¸€å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ attachment-resolver.ts # é™„ä»¶å†…å®¹è§£æ (è½¬å†™/è¯»å–)
â”‚   â”‚   â”œâ”€â”€ macro.ts              # å®è§£æç®—æ³•
â”‚   â”‚   â””â”€â”€ preview-builder.ts    # é¢„è§ˆæ•°æ®æ„å»ºå™¨ (UIä¸“ç”¨)
â”‚   â”œâ”€â”€ context-processors/       # ã€ç»Ÿä¸€ç›®å½• - æ ¸å¿ƒå¤„ç†å™¨ã€‘
â”‚   â”‚   â”œâ”€â”€ index.ts              # ç»Ÿä¸€å¯¼å‡ºæ‰€æœ‰å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ session-loader.ts     # ä¼šè¯åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ regex-processor.ts    # æ­£åˆ™å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ token-limiter.ts      # Token é™åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ injection-assembler.ts # æ³¨å…¥ç»„è£…å™¨
â”‚   â”‚   â”œâ”€â”€ message-format-processors.ts # æ¶ˆæ¯æ ¼å¼åŒ–å¤„ç†å™¨ç»„
â”‚   â”‚   â”œâ”€â”€ transcription-processor.ts # è½¬å†™ä¸æ–‡æœ¬æå–
â”‚   â”‚   â””â”€â”€ asset-resolver.ts     # èµ„äº§è§£æå™¨
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ pipeline.ts               # PipelineContext, ContextProcessor æ¥å£
â”‚   â”œâ”€â”€ context.ts                # ä¸Šä¸‹æ–‡ç›¸å…³ç±»å‹
â”‚   â””â”€â”€ ...                       # å…¶ä»–ç±»å‹å®šä¹‰
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ contextPipelineStore.ts   # ã€ç»Ÿä¸€å­˜å‚¨ã€‘
â”œâ”€â”€ components/
â”‚   â””â”€â”€ settings/
â”‚       â”œâ”€â”€ PipelineConfig.vue    # ã€ä¸Šä¸‹æ–‡ç®¡é“é…ç½®ç•Œé¢ã€‘
â”‚       â””â”€â”€ SettingItemRenderer.vue # é…ç½®é¡¹æ¸²æŸ“å™¨
â””â”€â”€ macro-engine/                 # å®å¼•æ“ (ç‹¬ç«‹æ¨¡å—)
    â”œâ”€â”€ index.ts
    â”œâ”€â”€ MacroProcessor.ts
    â””â”€â”€ ...
```
