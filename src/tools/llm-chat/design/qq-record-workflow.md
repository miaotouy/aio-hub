# QQ 聊天记录 → AIO Chat 全链路工作流

**状态**: Stable Feature Guide

---

## 概述

这是一个将 QQ（NT 新版）聊天记录（含图片）快速导入 AIO Chat 并进行 AI 分析的完整工作流。
单看每个功能点都很普通，但串联起来之后，可以做到：
**从 QQ 复制一段带图的聊天记录，粘贴，两次点击，AI 就能完整理解其中的文字和图片内容**。

---

## 背景：为什么 QQ NT 的图片是路径？

QQ NT 版在复制聊天记录时，图片不会被编码进剪贴板，而是以**带本地路径的 HTML 标签**形式嵌入到文本中，格式通常为：

```html
<img src="file://D:\Documents\TencentFiles\QQ\nt_qq\...\image.png" />
```

**特点**：

- **HTML 包装**：路径通常被包裹在 `<img>` 标签的 `src` 属性中。
- **反斜杠路径**：在 Windows 环境下，路径使用反斜杠 `\`（如 `D:\...\image.png`），且带有 `file://` 协议前缀。
- **本地存在**：这意味着图片文件实际上已经在你的本地磁盘上，只是需要一个机制来“认领”并资产化它们。

---

## 完整操作流程

### 第一步：在 QQ 中复制聊天记录

在 QQ NT 版中，选中一段包含图片的聊天记录，右键复制（或 Ctrl+C）。

### 第二步：粘贴到 AIO Chat 输入框

直接在 AIO Chat 的输入框中 Ctrl+V。此时输入框中会出现包含本地路径的原始文本，图片路径以纯文本形式显示。

### 第三步：路径转附件

点击输入框工具栏 → **路径转附件**。

系统会：

1. **智能识别**：用正则扫描输入框文本，识别所有 `file://` 协议链接、`<img>` 标签中的 `src` 路径以及 Windows/Unix 绝对路径。
2. **兼容处理**：自动处理 Windows 下的反斜杠 `\` 路径，确保导入引擎能正确读取文件。
3. **资产化导入**：将识别到的每个路径文件导入为系统 Asset（存入资产库，支持去重）。
4. **结构化替换**：将输入框中的原始 `<img>` 标签或路径字符串替换为 `【file::assetId】` 占位符，保持文本内容的结构化关联。

操作完成后，图片会以附件卡片的形式出现在输入框下方，原始路径从文本中消失。

### 第四步：自动转写（后台进行）

附件导入完成后，`useTranscriptionManager` 会自动检测到新附件就绪（`importStatus === 'complete'`），并根据聊天设置中的转写配置自动触发转写任务。

转写的触发策略：

- **智能模式（默认）**：检查当前对话模型是否具备视觉能力。若模型不支持图片（如 `deepseek-chat`），则自动触发 OCR/图片描述；若模型支持视觉（如 `gpt-4o`），则跳过转写，直接发送图片。
- **始终转写模式**：无论模型能力如何，都对图片进行转写，适合需要节省 Token 或提高长上下文理解力的场景。

转写任务在后台异步执行，输入框中的附件卡片会显示转写进度。

### 第五步：发送

点击发送。在消息实际发出前，系统会通过 `ensureTranscriptions` 等待所有必要的转写任务完成，然后由上下文管道中的 `transcription-processor` 将转写结果注入到发送给 LLM 的上下文中。

---

## 渲染还原：让占位符“显形”

在 AIO Chat 中，你看到的不仅仅是 `【file::assetId】` 这种冷冰冰的占位符。渲染系统通过以下机制将其还原为直观的媒体内容：

### 1. 占位符映射 (Placeholder Mapping)

当消息渲染时，系统会扫描文本中的占位符：

- **MessageContent.vue**：在消息渲染层级，系统会拦截 `【file::assetId】` 占位符。
- **查找附件**：渲染器会从当前消息节点的 `attachments` 列表中根据 `assetId` 查找对应的资产对象。
- **动态替换**：如果找到的是图片资产，渲染器会动态将其替换为 `<img>` 标签或专用的媒体预览组件。

### 2. 协议转换与安全绕过 (Protocol Resolution)

由于现代浏览器（及 Tauri 窗口）出于安全考虑禁止直接访问本地路径，系统利用了 Tauri 的自定义协议机制：

- **`convertFileSrc`**：`agentAssetUtils.ts` 中的工具函数会将本地路径转换为安全资源 URL。
- **统一解析**：`GenericHtmlNode.vue` 等渲染节点在渲染 HTML 内容时，会自动调用 `resolveAsset` 钩子，将 `agent-asset://` 和 `file://` 协议转换为可显示的真实地址。
- **显示保障**：这确保了即使图片还在你电脑的 QQ 缓存文件夹里，也能在 AIO 的聊天界面中正常渲染。

### 3. 双向一致性

这一机制保证了：

- **输入时**：你看到的是占位符，保持了文本的结构化。
- **发送后**：渲染器将其还原为图片，保持了视觉的直观性。
- **发送给 AI 时**：管道将其还原为转写文本或 Base64，保证了 AI 的理解力。

---

## 技术链路图

```
QQ NT 复制聊天记录
        │
        │  剪贴板文本（含 file:// 路径）
        ▼
AIO Chat 输入框（Ctrl+V）
        │
        │  点击"路径转附件"
        ▼
MessageInput.handleConvertPaths()
  ├─ 正则识别本地路径
  ├─ attachmentManager 导入为 Asset
  └─ 路径替换为 【file::assetId】 占位符
        │
        │  importStatus → 'complete'
        ▼
useTranscriptionManager（自动监听）
  ├─ 检查转写策略（smart / always）
  ├─ 检查模型视觉能力
  └─ 触发转写任务（OCR / 图片描述）
        │
        │  点击发送
        ▼
ensureTranscriptions()（等待转写完成）
        │
        ▼
统一上下文管道
  └─ transcription-processor 注入转写结果
        │
        ▼
LLM API（文字 + 图片内容均可理解）
```

---

## 关键配置

转写相关配置位于 **聊天设置 → 转写** 中：

| 配置项         | 说明                                              |
| -------------- | ------------------------------------------------- |
| 启用转写       | 总开关                                            |
| 导入时自动开始 | 控制是否在附件导入后立即触发转写                  |
| 转写策略       | `smart`（按模型能力）/ `always`（始终转写）       |
| 图片转写模型   | 专用于图片 OCR/描述的模型，优先级高于全局转写模型 |
| 强制转写阈值   | 对话超过 N 轮后，即使模型支持视觉也强制转写       |

---

## 适用场景

- **聊天记录存档分析**：将一段 QQ 群讨论（含截图）粘贴进来，让 AI 总结要点
- **问题复现记录**：复制包含报错截图的聊天记录，直接让 AI 分析问题
- **信息整理**：将碎片化的聊天内容（文字 + 图片）一次性结构化处理
- **不支持视觉的模型**：即使使用纯文本模型，转写模块也能将图片内容转为文字描述，保证信息不丢失

---

## 注意事项

- 路径转附件依赖本地文件仍然存在。QQ 的缓存图片可能会被清理，建议及时处理。
- 转写质量取决于所配置的转写模型。图片描述类任务建议使用具备视觉能力的模型（如 `gpt-4o-mini`、`gemini-flash`）。
- 若转写任务失败，发送时会有提示，可在附件卡片上手动重试。
