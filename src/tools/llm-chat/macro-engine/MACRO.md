# LLM Chat: 宏系统 (Macro System) 指南

宏系统是 `llm-chat` 中一个强大的动态内容生成引擎。它允许你在智能体的预设消息、用户输入、正则替换等任何支持文本的地方嵌入可执行的占位符，从而实现根据上下文动态调整 Prompt 的能力。

## 1. 基础语法

宏的基本格式为：

- **无参数宏**: `{{macroName}}`
- **带参数宏**: `{{macroName::arg1::arg2}}`

### 1.1. 转义

如果你需要在文本中显示 `{{` 字符串而不触发宏处理，可以在前面加上反斜杠：
`\{{example}}` -> 处理后变为 `{{example}}`

### 1.2. 空白符控制

`{{trim}}` 是一个特殊的标记，它本身不输出内容，但会移除其前后的所有空白字符（包括换行符）。这在为了模板可读性而添加换行，但不希望这些换行进入最终 Prompt 时非常有用。

---

## 2. 执行机制：三阶段管道

为了保证宏之间的依赖关系正确处理（例如先设置变量再读取变量），宏引擎采用三阶段执行管道：

1.  **预处理 (`PRE_PROCESS`)**: 处理状态变更宏（如 `setvar`, `incvar`）。这些宏通常不返回可见内容。
2.  **替换 (`SUBSTITUTE`)**: 处理静态值替换（如 `user`, `getvar`）。
3.  **后处理 (`POST_PROCESS`)**: 执行依赖最终文本上下文或动态计算的函数（如 `time`, `lastMessage`）。

---

## 3. 内置宏参考

### 3.1. 核心上下文宏

这些宏用于获取当前会话的基本信息。

| 宏名称            | 说明                                     | 示例                  |
| :---------------- | :--------------------------------------- | :-------------------- |
| `user`            | 当前用户的名称                           | `{{user}}`            |
| `agent` / `char`  | 当前智能体/角色的名称                    | `{{char}}`            |
| `persona`         | 当前用户档案 (UserProfile) 的内容        | `{{persona}}`         |
| `description`     | 智能体的描述信息 (Character Description) | `{{description}}`     |
| `lastMessage`     | 会话中的最后一条消息内容                 | `{{lastMessage}}`     |
| `lastUserMessage` | 最后一条用户消息                         | `{{lastUserMessage}}` |
| `lastCharMessage` | 最后一条助手消息                         | `{{lastCharMessage}}` |

### 3.2. 模型元数据宏

获取当前正在使用的模型信息。

| 宏名称        | 说明                                      | 示例              |
| :------------ | :---------------------------------------- | :---------------- |
| `modelId`     | 完整模型 ID (如 `openai:gpt-4o`)          | `{{modelId}}`     |
| `modelName`   | 模型显示名称 (如 `GPT-4o`)                | `{{modelName}}`   |
| `profileName` | LLM 配置文件名称                          | `{{profileName}}` |
| `provider`    | 模型提供商类型 (如 `openai`, `anthropic`) | `{{provider}}`    |

### 3.3. 时间与日期宏

所有时间宏都会自动感知智能体的 **虚拟时间线 (Virtual Timeline)** 配置。

#### 标准格式

- `{{time}}`: 12小时制英文时间 (如 `10:30 PM`)
- `{{time24}}`: 24小时制时间 (如 `22:30`)
- `{{date}}`: 英文日期 (如 `November 7, 2025`)
- `{{date_ymd}}`: ISO 日期 (如 `2025-11-07`)
- `{{datetime}}`: 完整日期时间 (如 `2025-11-07 22:30:00`)
- `{{weekday}}`: 英文星期几 (如 `Friday`)

#### 中文格式

- `{{date_cn}}`: 中文日期 (如 `2025年11月7日`)
- `{{datetime_cn}}`: 完整中文日期时间 (含星期和午别)
- `{{weekday_cn}}`: 中文星期 (如 `星期五`)

#### 古风/特殊格式

- `{{date_cn_ancient}}`: 农历/干支日期 (如 `乙巳年（蛇年）十月十八`)
- `{{time_cn_ancient}}`: 时辰刻数 (如 `亥时一刻`)
- `{{shichen}}`: 仅时辰名称 (如 `亥时`)
- `{{date_cn_uppercase}}`: 大写汉字日期 (如 `贰零贰伍年拾壹月柒日`)
- `{{date_en_ancient}}`: 中世纪风格英文日期

#### 动态格式化

- `{{datetime_format::pattern}}`: 使用自定义模式字符串。支持 `YYYY`, `MM`, `DD`, `HH`, `mm`, `ss` 等。
- `{{datetime_locale::locale}}`: 指定语言区域格式化 (如 `{{datetime_locale::ja-JP}}`)。

### 3.4. 变量操作宏

变量允许你在上下文构建过程中传递和共享状态。

> [!IMPORTANT]
> **生命周期与执行顺序**:
>
> 1.  **持续性**: 变量（`setvar`/`getvar`）在**单次 LLM 请求的完整上下文构建管道**中是持续的。
> 2.  **执行顺序**: 宏处理是按**预设消息列表的物理排序**从上到下串行执行的。这意味着在排序靠前的预设中 `setvar` 的值，可以在排序靠后的预设中通过 `getvar` 读取。
> 3.  **注入无关性**: 变量的传递仅取决于预设列表的物理顺序，不受最终消息注入位置（如 depth 注入或锚点注入）的影响。
> 4.  **临时性**: 变量内容不会持久化到数据库。当回复生成后，这些临时变量就会被销毁，无法跨轮次（跨用户发送的消息）使用。

| 宏名称              | 说明                               | 示例                         |
| :------------------ | :--------------------------------- | :--------------------------- |
| `setvar::name::val` | 设置临时局部变量                   | `{{setvar::mood::happy}}`    |
| `getvar::name`      | 获取临时局部变量值                 | `{{getvar::mood}}`           |
| `incvar::name`      | 临时变量自增 1                     | `{{incvar::counter}}`        |
| `decvar::name`      | 临时变量自减 1                     | `{{decvar::counter}}`        |
| `setglobalvar`      | 设置全局变量（当前应用进程内有效） | `{{setglobalvar::key::val}}` |
| `getglobalvar`      | 获取全局变量值                     | `{{getglobalvar::key}}`      |

### 3.5. 功能性宏

提供逻辑处理、随机化和文本操作。

| 宏名称                | 说明                                       | 示例                           |
| :-------------------- | :----------------------------------------- | :----------------------------- |
| `random::opt1::opt2`  | 从提供的选项中随机选择一个                 | `{{random::高冷::热情::神秘}}` |
| `pick::opt1::opt2`    | 基于会话内容的稳定选择（同一会话结果固定） | `{{pick::A::B}}`               |
| `roll::NdM`           | 掷骰子（如 `1d20` 表示掷一个20面骰）       | `{{roll::1d100}}`              |
| `randomInt::min::max` | 生成指定范围内的随机整数                   | `{{randomInt::1::10}}`         |
| `repeat::text::n`     | 重复指定文本 N 次                          | `{{repeat::*::5}}`             |
| `newline`             | 插入一个换行符                             | `第一行{{newline}}第二行`      |

### 3.6. 系统信息宏

获取运行环境的硬件和软件信息。

| 宏名称      | 说明                                     | 示例            |
| :---------- | :--------------------------------------- | :-------------- |
| `os`        | 操作系统名称 (如 `Windows_NT`, `Darwin`) | `{{os}}`        |
| `osVersion` | 操作系统版本号                           | `{{osVersion}}` |
| `platform`  | 运行平台 (如 `win32`, `linux`)           | `{{platform}}`  |
| `arch`      | CPU 架构 (如 `x86_64`, `aarch64`)        | `{{arch}}`      |
| `hostname`  | 计算机主机名                             | `{{hostname}}`  |
| `locale`    | 系统语言环境 (如 `zh-CN`)                | `{{locale}}`    |

### 3.7. 资产宏

| 宏名称   | 说明                                          | 示例                   |
| :------- | :-------------------------------------------- | :--------------------- |
| `assets` | 列出智能体可用的私有资产。可选参数为分组 ID。 | `{{assets::stickers}}` |

---

## 4. 最佳实践

1.  **配合正则替换**: 在正则替换规则中使用 `{{user}}` 或 `{{char}}` 可以编写更通用的清洗规则。
2.  **动态角色设定**: 在智能体的 `scenario` 或 `description` 中使用时间宏，让角色感知当前的时间环境。
3.  **跨预设消息传递**: 在排序靠前的预设消息中设置 `setvar`，在后续消息中根据该变量动态调整 Prompt 内容。利用物理排序控制变量流向。
