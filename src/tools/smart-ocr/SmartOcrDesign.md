# 智能OCR工具 (Smart OCR) - 设计文档

## 1. 概述

### 1.1. 项目目标

开发一款集成在AIOTools中的OCR文字识别工具，支持多种识别引擎（本地/云端/VLM），能够高效识别图片中的文字内容。为了更好地处理超长截图场景，工具提供了智能切图的辅助功能，可自动检测空白区域并切割长图，从而提升识别效率和准确率。

### 1.2. 核心功能

- **多引擎OCR识别**:
  - 内置基于`Tesseract.js`的**本地离线OCR引擎**。
  - 支持集成**传统云端OCR服务**（如白描）。
  - 支持通过**通用API端点**接入各类**视觉语言模型 (VLM)**，如本地部署的Ollama模型 (Qwen-VL, Llama3.2-vision) 或商业模型 (Gemini, GPT-4o)。
- **智能切图辅助功能**:
  - 自动检测并基于无文本的空白横带对长截图进行切割。
  - 用户可选择是否启用，也可设置长宽比阈值自动触发。
  - 有助于提升长截图的识别效率和准确率。
- **可视化操作**: 在UI上清晰地展示切割线、切割后的图片块以及实时的OCR结果。
- **灵活配置**: 用户可以管理和保存多个自定义VLM服务的配置（API端点、模型、密钥等）。

## 2. 功能设计

### 2.1. OCR识别流程

1. **图像输入**: 用户上传图片或截图。
2. **预处理判断**: 检查是否需要启用智能切图（基于用户设置和图片长宽比）。
3. **OCR执行**:
   - 若不需要切图，直接对整图进行OCR识别。
   - 若需要切图，先执行智能切图算法，再对每个图片块进行OCR识别。
4. **结果汇总**: 收集所有识别结果并展示给用户。

### 2.2. 智能切图算法（辅助功能）

采用基于**水平投影**的空白区域检测算法。

1.  **图像预处理**:
    - **主题检测**: 通过检测图像四角的平均亮度，判断是亮色主题（白底黑字）还是暗色主题（黑底白字）。
    - **智能二值化**: 根据主题检测结果，将图像转换为统一的“白底黑字”二值化图，消除主题颜色对后续步骤的干扰。
2.  **水平投影**:
    - 沿Y轴方向，计算二值化图中**每一行**的黑色像素点数量，生成一个一维直方图。
3.  **寻找切割点**:
    - 在直方图中寻找连续的、值低于预设**空白阈值**的区域。
    - 当一个低值区域的连续行数超过预设的**最小行高**时，将其视为一个有效的“空白横带”。
    - 取该横带的中线作为切割点。
4.  **图像切割**:
    - 根据所有找到的切割点，将原始彩色图像切割成多个子图片块。

### 2.3. 切图触发条件

- 在执行切图算法前，会检查用户是否启用了智能切图，以及图片的长宽比是否超过了设定的阈值。
- 只有满足条件时，才会执行切图流程；否则，将整张图直接送入OCR引擎进行识别。

## 3. 技术方案

### 3.1. 前端 (Vue 3 + TypeScript + Vite)

- **图像处理**: 使用原生的**Canvas API**进行图像加载、像素级操作（主题检测、二值化、投影计算）和切割。不引入额外的图像处理库。
- **UI框架**: **Element Plus**，用于快速构建高质量的UI界面。
- **状态管理**: 使用Vue 3的Composition API (`ref`, `reactive`) 进行组件内的状态管理。
- **模块化**:
  - 业务逻辑将被拆分到`composables`目录下的hooks中 (e.g., `useImageSlicer.ts`, `useOcrRunner.ts`)。
  - UI界面将被拆分为多个独立的子组件 (`ControlPanel.vue`, `PreviewPanel.vue`, `ResultPanel.vue`)。

### 3.2. OCR引擎

- **本地引擎**: **Tesseract.js**，实现离线识别能力。中文语言包将存放于`public`目录。
- **云端引擎**:
  - 通过**`@tauri-apps/plugin-http`**发送网络请求，以绕过浏览器CORS限制。
  - 设计一个可插拔的**OCR引擎管理器 (`OCREngineManager.ts`)**，用于统一管理和调用不同的OCR服务。
  - 实现一个**`GenericVLMEngine`**类，用于处理所有符合OpenAI Vision API格式的VLM服务。

### 3.3. 配置与数据存储

- **`@tauri-apps/plugin-store`**: 用于持久化存储用户的API配置（如VLM服务的端点、密钥等），数据将保存在用户本地的应用数据目录中。

## 4. UI/UX 设计

### 4.1. 布局

采用**三栏式布局**:

- **左栏 (ControlPanel.vue)**: 配置与控制区。包括图片上传、OCR引擎选择、API设置入口、算法参数调整（开关、阈值滑块等）和操作按钮。
- **中栏 (PreviewPanel.vue)**: 图像预览区。用于显示原始上传图片、算法计算出的切割线以及切割后的图片块列表。
- **右栏 (ResultPanel.vue)**: OCR结果展示区。实时显示每个图片块的识别进度和结果，并提供复制功能。

### 4.2. 交互流程

1.  用户上传图片。
2.  图片显示在中栏预览区，用户在左侧选择OCR引擎并进行相关配置。
3.  点击"开始识别"。
4.  若启用了智能切图，应用会在中栏可视化显示切割线和切割结果；否则直接处理整图。
5.  应用调用选定的OCR引擎，并在右栏实时更新识别结果。
6.  用户在右栏查看和复制识别出的文本内容。

## 5. 实现计划

### Phase 1: 核心功能搭建 (MVP)
- 搭建新工具页面和基础的三栏UI布局。
- 集成`Tesseract.js`本地OCR引擎。
- 实现基础的图片上传和OCR识别功能。

### Phase 2: 智能切图辅助功能
- 实现完整的智能切图算法逻辑。
- 在UI上可视化展示切割线和切割结果。
- 支持对切图后的图片块进行批量OCR识别。

### Phase 3: 通用VLM与云端API支持
- 实现`OCREngineManager`和`GenericVLMEngine`。
- 创建VLM配置管理界面，并使用`plugin-store`进行数据持久化。
- 实现动态加载和调用用户自定义的VLM服务。

### Phase 4: 优化与完善
- 将UI拆分为独立的子组件。
- 将业务逻辑抽离到`composables`。
- 完善UI细节，如加载状态、进度条、错误提示等。